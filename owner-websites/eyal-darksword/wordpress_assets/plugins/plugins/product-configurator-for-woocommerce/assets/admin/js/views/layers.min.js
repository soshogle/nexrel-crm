var PC=PC||{};PC.views=PC.views||{},((n,o)=>{PC.views.layers=Backbone.View.extend({tagName:"div",className:"state layers-state",template:wp.template("mkl-pc-structure"),orderAttr:"order",collectionName:"layers",initialize:function(e){this.options=e||{},this.admin=PC.app.get_admin(),this.product_id=e.app.product.id,this.items=[],PC.selection.reset(),this.admin[this.collectionName]?this.col=this.admin[this.collectionName]:(e=this.admin.model.get(this.collectionName),this.col=this.admin[this.collectionName]=0!=e?new PC[this.collectionName](e):new PC[this.collectionName]),this.listenTo(this.col,"add",this.add_one),this.listenTo(this.col,"add",this.mark_collection_as_modified),this.listenTo(this.col,"change",this.layers_changed),this.listenTo(this.col,"change:type",this.add_all),this.listenTo(this.col,"multiple-selection",this.edit_multiple),this.listenTo(this.col,"simple-selection",this.edit_simple),this.listenTo(this.col,"changed-order",this.update_sorting),this.listenTo(this.col,"destroy",this.removed_model),this.listenTo(PC.app.admin,"pasted-data",this.on_paste),this.render()},single_view:function(){return PC.views.layer},events:{"click .add-layer":"create","click .order-toolbar button":"change_order_type","keypress .structure-toolbar input":"create",remove:"cleanup_on_remove","save-state":"save_layers"},cleanup_on_remove:function(){o.each(this.items,this.remove_item),this.stopListening()},render:function(){return this.col.orderBy="order",this.col.sort(),this.$el.append(this.template({input_placeholder:PC.lang[this.collectionName+"_new_placeholder"],collectionName:this.collectionName})),this.$list=this.$(".layers"),this.$form=this.$(".pc-sidebar"),this.$new_input=this.$(".structure-toolbar input"),this.floating_add=new PC.views.floating_add_button({el:this.$(".floating-add").first(),list:this.$list,parent:this}),this.add_all(),this},mark_collection_as_modified:function(){PC.app.is_modified[this.collectionName]=!0},removed_model:function(e){this.admin.remove_relationships(this.collectionName,e),this.mark_collection_as_modified()},change_order_type:function(e){var t,e=n(e.currentTarget),i=e.data("order_type");"image_order"==i&&(t=this.col.pluck("image_order")).length&&!o.max(t)&&this.col.each(function(e){e.set("image_order",e.get("order"))}),i&&this.orderAttr!=i&&(e.closest(".button-group").find("button").removeClass("button-primary"),e.addClass("button-primary"),this.orderAttr=i,this.col.orderBy=i,this.col.sort({silent:!0}),this.add_all())},add_one:function(e){e=new(this.single_view())({model:e,form_target:this.$form,collection:this.col,orderAttr:this.orderAttr});this.items.push(e),this.$list.append(e.render().el)},remove_item:function(e){e.remove()},add_all:function(){var e=this.col;this.$list.empty(),o.each(this.items,this.remove_item),this.items=[],e.each(this.add_one,this);"order"==this.orderAttr&&o.each(this.items,function(e){var t;e.model.get("parent")&&(t=this.$(".layers[data-item-id="+e.model.get("parent")+"]")).length&&t.append(e.$el)}.bind(this)),this.$(".layers").sortable({items:".mkl-list-item",placeholder:"mkl-list-item__placeholder",cursor:"move",axis:"y",handle:".sort",forcePlaceholderSize:!0,helper:"clone",opacity:.65,connectWith:".sortable-list",stop:function(e,t){"order"==this.orderAttr?this.update_sorting():t.item.trigger("drop",t.item.index())}.bind(this)})},create:function(e){"keypress"==e.type&&13!==e.which||this.$new_input.val().trim()&&(this.col.create(this.new_attributes(this.$new_input.val().trim())),this.$new_input.val(""))},layers_changed:function(e){1===o.keys(e.changed).length&&e.changed.hasOwnProperty("active")||(PC.app.is_modified[this.collectionName]=!0)},layers_loaded:function(e){this.render()},new_attributes:function(e){return{_id:PC.app.get_new_id(this.col),name:e,order:this.col.nextOrder(),image_order:this.col.nextOrder(),active:!0}},get_col:function(){return this.col},edit_multiple:function(){this.edit_multiple_items_form&&this.edit_multiple_items_form.remove(),this.col.where({active:!0}).length&&(this.edit_multiple_items_form=new PC.views.multiple_edit_form({collection:this.col,view:this}),this.$form.append(this.edit_multiple_items_form.$el))},edit_simple:function(){this.edit_multiple_items_form&&(this.edit_multiple_items_form=null),PC.selection.reset()},update_sorting:function(){this.$(".layers .mkl-list-item").each(function(e,t){var i=!1;n(t).closest(".group-list").length&&(i=n(t).closest(".group-list").data("itemId")),n(t).trigger("update_order",[e,i])}),this.col.sort({silent:!0}),this.$list.sortable("instance")&&this.$list.sortable("refresh")},on_paste(e){if(e&&e.type===this.collectionName&&e.models){let i=[],s=[];o.each(e.models,e=>{var t;e.layer&&(t=e.layer._id,e=l({layer_data:e.layer,choices_data:e.content,is_cloning:!1,collection:this.col}),i[t]=e.id,s.push(e))}),s.forEach(e=>{var t=e.get("parent");t&&(i[t]?e.set("parent",i[t]):e.unset("parent"))})}}}),PC.views.layer=Backbone.View.extend({tagName:"div",className:"layer mkl-list-item",template:wp.template("mkl-pc-structure-layer"),edit_view:function(){return PC.views.layer_form},initialize:function(e){this.options=e||{},this.form_target=e.form_target,this.listenTo(this.model,"change:active",this.activate),this.listenTo(this.model,"change:name change:admin_label change:image",this.update_label),this.listenTo(this.model,"destroy",this.remove)},events:{"click > button":"edit",drop:"drop","update-sort":"update_sort",update_order:"update_order"},render:function(){return this.$el.data("view",this),this.$el.html(this.template(o.extend({},this.model.attributes,{orderAttr:this.options.orderAttr}))),this.label||(this.label=new PC.views.layerLabel({model:this.model}),this.$("h3").append(this.label.$el)),1!=this.model.get("active")&&"true"!=this.model.get("active")||this.edit(),this},update_label:function(){this.label.render()},edit:function(e){if(!PC.selection.adding_group){if(e&&(e.shiftKey||e.metaKey||e.ctrlKey)){var i,t;if(this.model.get("active")?this.model.set("active",!1):this.model.set("active",!0),PC.selection.is_multiple())return e&&e.shiftKey&&this.model.collection.last_clicked&&this.model.collection.last_clicked!=this&&(i=this.model.collection.last_clicked.model,this.model.collection.last_clicked.model.get("order")<this.model.get("order")?(t=this.model.collection.indexOf(this.model.collection.last_clicked.model),s=this.model.collection.indexOf(this.model)):(s=this.model.collection.indexOf(this.model.collection.last_clicked.model),t=this.model.collection.indexOf(this.model)),t=this.model.collection.slice(t,s),o.each(t,function(e){if(i.get("parent")!=e.get("parent")){var t=e.collection.get(e.get("parent"));if(t&&("group"===t.get("type")||t.get("is_group")))return}e.set("active",e.collection.last_clicked.model.get("active"))}.bind(this))),this.form_target.empty(),void(this.model.collection.last_clicked=this).model.collection.trigger("multiple-selection");this.activate()}this.model.collection.trigger("simple-selection");var s=this.edit_view();e?(0==this.model.get("active")||"false"==this.model.get("active")||1<this.model.collection.where({active:!0}).length)&&(this.options.collection.each(function(e){e.set("active",!1)}),this.model.set("active",!0),this.form&&this.form.remove(),this.form=new s(this.options),this.form_target.html(this.form.render().el)):this.form||(this.options.collection.each(function(e){e.set("active",!1)}),this.model.set("active",!0),this.activate(),this.form=new s(this.options),this.form_target.html(this.form.render().el)),this.model.collection.last_clicked=this}},activate:function(){!0===this.model.get("active")?this.$el.addClass("active"):this.$el.removeClass("active"),PC.selection.select(this)},drop:function(e,t){!0===this.model.get("active")&&this.model.set("active",!1),this.$el.siblings().addBack().trigger("update-sort"),this.form&&this.form.remove()},update_sort:function(e){e.stopPropagation(),this.model.set(this.model.collection.orderBy,n(e.currentTarget).index())},update_order:function(e,t,i){e.stopPropagation(),i&&i==this.model.id||this.model.set({order:t,parent:i})}}),PC.views.layerLabel=Backbone.View.extend({tagName:"span",template:wp.template("mkl-pc-content-layer-list-item--label"),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.attributes))}}),PC.views.layer_form=Backbone.View.extend({tagName:"div",className:"layer-form",template:wp.template("mkl-pc-structure-layer-form"),toggled_status:{init:function(){this.statuses=JSON.parse(localStorage.getItem("layers_toggle_status"))||{}},set:function(e,t){this.statuses[e]=t,localStorage.setItem("layers_toggle_status",JSON.stringify(this.statuses))},get:function(e){return this.statuses.hasOwnProperty(e)?this.statuses[e]:"opened"}},initialize:function(e){this.pre_init&&this.pre_init(e),this.toggled_status.init(),this.collection=this.model.collection,this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,wp.hooks.applyFilters("PC.admin.layer_form.render.on.change.events","change:not_a_choice change:type change:required change:display_mode"),this.render)},events:{"click .delete-item":"delete_layer","click .confirm-delete":"delete_layer","click .cancel-delete":"delete_layer","click .duplicate-item":"duplicate_layer","click .copy-item":"copy_layer","keyup .setting input":"form_change","keyup .setting textarea":"form_change","change .setting select":"form_change",'change .setting [type="radio"]':"form_change",'click [type="checkbox"]':"form_change",'click [type="checkbox"][data-setting="not_a_choice"]':"on_change_not_a_choice","click .edit-attachment":"edit_attachment","click .remove-attachment":"select_attachment","select-media":"select_attachment","click .mkl-pc--action":"trigger_custom_action","click button.components-panel__body-toggle":"toggle_section"},render:function(){var e=this.model.attributes;return"group"!=this.model.get("type")||this.model.get("parent")&&this.model.collection.get(this.model.get("parent"))||(e=o.extend({},e,{maybe_step:!0})),e=o.extend({},e,{toggled_status:this.toggled_status.statuses}),this.$el.html(this.template(e)),this.delete_btns={prompt:this.$(".delete-item"),confirm:this.$(".prompt-delete")},this.$(".section-fields:empty").closest(".setting-section").hide(),this.populate_angles_list(),PC.currentEditedItem=this.model,this.current_focus&&(1===(e=this.$('[data-setting="'+this.current_focus+'"]')).length&&e.trigger("focus"),1<e.length)&&1===(e=this.$('[data-setting="'+this.current_focus+'"]:checked')).length&&e.trigger("focus"),wp.hooks.doAction("PC.admin.layer_form.render",this),this},on_change_not_a_choice:function(e){e=n(e.currentTarget).prop("checked");this.model.set("not_a_choice",e)},form_change:function(e){var t=n(e.currentTarget),i=t.data("setting");if(this.current_focus=i,"checkbox"===e.currentTarget.type){if("click"!==e.type)return;var s=t.prop("checked")}else s="text"===e.currentTarget.type||"textarea"===e.currentTarget.type?t.val().trim():t.val();if("type"==i&&"group"==s){var o=PC.app.get_layer_content(this.model.id);if(o&&o.length&&!confirm(PC_lang.group_with_content_warning))return e.preventDefault(),t.val(this.model.get(i)),!1}this.model.get(i)!=s&&this.model.set(i,s)},delete_layer:function(e){var t=n(e.currentTarget);switch(t.data("delete")){case"prompt":t.addClass("hidden"),this.delete_btns.confirm.removeClass("hidden");break;case"confirm":this.collectionName&&"angles"===this.collectionName&&1===this.model.collection.length?alert(PC_lang.angles_no_delete_message):this.model.destroy();break;case"cancel":this.delete_btns.prompt.removeClass("hidden"),this.delete_btns.confirm.addClass("hidden")}},duplicate_layer:function(e){var t=PC.toJSON(this.model),i=PC.app.get_product().get("content").get(this.model.id)?.get("choices").models||null;l({layer_data:t,choices_data:i,is_cloning:!0,collection:this.collection})},copy_layer:function(){PC.copy_items(this)},edit_attachment:function(e){e.preventDefault(),PC.media.open({el:this.$el,selection:this.model.get("image").id})},select_attachment:function(e,t){var i="",s=null;t&&(i=t.get("url"),s=t.id),this.model.set("image",{url:i,id:s}),this.render()},populate_angles_list:function(){var t=this.model.get("angle_switch")||"no",e=PC.app.get_collection("angles");e&&e.length&&e.each(function(e){this.$('select[data-setting="angle_switch"]').append("<option "+(t==e.id?"selected ":"")+'value="'+e.id+'">Switch to '+e.get("name")+"</option>")},this)},trigger_custom_action:function(e){var e=n(e.currentTarget),t=e.data("action");t in PC.actions&&PC.actions[t](e,this)},toggle_section:function(e){var e=n(e.currentTarget).closest(".setting-section"),t=e.data("section");e.toggleClass("is-opened"),this.toggled_status.set(t,e.is(".is-opened")?"opened":"closed")}}),PC.views.layer_img=Backbone.View.extend({}),PC.views.multiple_edit_form=Backbone.View.extend({tagName:"div",className:"layer-form",template:wp.template("mkl-pc-multiple-edit-form"),initialize:function(e){this.collection=e.collection,this.edited_list_view=e.view,this.render(),this.listenTo(this.collection,"simple-selection",this.remove)},events:{"click .delete-layer":"delete_items","click .confirm-delete-layer":"delete_items","click .cancel-delete-layer":"delete_items","click .order .up":"move_items","click .order .down":"move_items","click .group button":"group_items","click .copy button":"copy_items"},render:function(){return this.$el.html(this.template({render_group:!(this.collection instanceof PC.angles)})),this.delete_btns={prompt:this.$(".delete-layer"),confirm:this.$(".prompt-delete")},this},delete_items:function(e){var t=n(e.currentTarget);switch(t.data("delete")){case"prompt":t.addClass("hidden"),this.delete_btns.confirm.removeClass("hidden");break;case"confirm":o.each(this.collection.where({active:!0}),function(e){e.destroy()}),PC.selection.reset(),this.collection.trigger("simple-selection");break;case"cancel":this.delete_btns.prompt.removeClass("hidden"),this.delete_btns.confirm.addClass("hidden")}},move_items:function(e){var e=n(e.currentTarget).is(".up")?-1:1,t=PC.selection.last().get("view"),i=t.$el.next(),s=PC.selection.first().get("view"),o=s.$el.prev(),l=this.collection.orderBy||"order";if(1==e){if(!i.length)return;i.insertBefore(s.$el),i.data("view").model.set(l,s.model.get(l)),PC.selection.each(function(e){e.get("view").model.set(l,e.get("view").model.get(l)+1)})}else{if(!o.length)return;o.insertAfter(t.$el),o.data("view").model.set(l,t.model.get(l)),PC.selection.each(function(e){e.get("view").model.set(l,e.get("view").model.get(l)-1)})}this.collection.sort()},group_items:function(e){var t,i,s=this.$(".group input");s.val().trim()&&(PC.selection.adding_group=!0,i=this.collection.where({active:!0})[0].get("order"),(s=PC.app.new_attributes(this.collection,{name:s.val().trim()})).order=i,this.collection instanceof PC.layers||this.collection instanceof PC.choices&&(s.layerId=this.collection.layer.id),t=this.collection.add(s),PC.selection.each(function(e){e.get("view").model.set("parent",t.id)}.bind(this)),PC.selection.adding_group=!1,PC.selection.reset(),this.collection.trigger("simple-selection"),i=this.edited_list_view.items[this.edited_list_view.items.length-1],t.set("active",!0),i.edit(),this.collection instanceof PC.layers?t.set("type","group"):this.collection instanceof PC.choices&&t.set("is_group",!0),this.collection.trigger("changed-order"))},copy_items:function(){PC.copy_items(this)}}),PC.views.floating_add_button=Backbone.View.extend({initialize:function(e){this.list=e.list,this.parent=e.parent,this.$el.on("mouseenter",function(){this.active=!0}.bind(this)),this.$el.on("mouseleave",function(){this.active=!1}.bind(this)),this.render()},render:function(){this.list.on("mouseenter",function(e){this.list.on("mousemove",this.calculate_position.bind(this))}.bind(this)),this.list.on("mouseleave",function(e){this.list.off("mousemove",this.calculate_position),setTimeout(function(){this.active||this.$el.removeClass("showing")}.bind(this),60)}.bind(this)),this.list.on("scroll",function(e){this.$el.removeClass("showing")}.bind(this))},calculate_position:o.debounce(function(e){var t,i,s,o=n(e.target).closest(".mkl-list-item");o.length&&(t=o[0].getBoundingClientRect(),i=this.list[0].getBoundingClientRect(),s=t.y-i.y+this.list.position().top,this.list_item=o,e.clientY<t.y+20?(this.$el.css({transform:"translateY("+s+"px)",width:t.width,left:t.x-i.x}),this.where="before",this.$el.addClass("showing")):e.clientY>t.y+t.height-20?(this.where="after",this.$el.css({transform:"translateY("+(s+t.height)+"px)",width:t.width,left:t.x-i.x}),this.$el.addClass("showing"),this.$el.css("width",t.width)):this.active||this.$el.removeClass("showing"))},100),events:{"click .mkl-floating-add-item":"create"},create:function(){var e=this.list_item.data("view"),t=e.model.get("order"),i=PC.app.new_attributes(e.collection,{name:"New item"}),t=(e.model.get("parent")&&(i.parent=e.model.get("parent")),"before"===this.where&&(t-=.5),"after"===this.where&&(t+=.5),i.order=t,e.collection instanceof PC.choices&&(i.layerId=e.collection.layer.id),e.collection.add(i)),s=this.list.find(".mkl-list-item").last();s.data("view").model===t&&("before"===this.where?s.insertBefore(this.list_item):s.insertAfter(this.list_item),s.addClass("just-added"),setTimeout(function(){s.removeClass("just-added")},300))},show:function(e){}});let l=function({layer_data:e,choices_data:i=null,is_cloning:s=!1,collection:t}){var o=PC.app.get_product().get("content"),e=new PC.layer(e);s&&(e.set("name",e.get("name")+" (Copy)"),e.get("admin_label"))&&e.set("admin_label",e.get("admin_label")+" (Copy)");let l,n=(t.create_layer?l=t.create_layer(PC.toJSON(e)):((l=PC.toJSON(e)).order=t.nextOrder(),l._id=PC.app.get_new_id(t)),t.create(l));if(i&&Array.isArray(i)){let t=new PC.choices([],{layer:n});o.add({layerId:n.id,choices:t}),i.forEach(e=>{e=s?e.clone():new PC.choice(e),e.set("layerId",n.id),e=t.create(PC.toJSON(e));PC.app.modified_choices.push(e.get("layerId")+"_"+e.id)}),PC.app.is_modified.content=!0}return n}})(jQuery,PC._us||window._);