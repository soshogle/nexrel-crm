var PC=PC||{};PC.views=PC.views||{},((l,a)=>{PC.views.choices=Backbone.View.extend({tagName:"div",className:"mkl-choice-list-inner",template:wp.template("mkl-pc-choices"),collectionName:"content",initialize:function(e){if(this.options=e||{},!this.options.state)return!1;this.items=[],this.product=PC.app.get_product(),this.content=this.product.get("content"),this.content.get(this.model.id)?this.col=this.content.get(this.model.id).get("choices"):(this.content.add({layerId:this.model.id,choices:new PC.choices([],{layer:PC.app.admin.layers.get(this.model.id)})}),this.col=this.content.get(this.model.id)),this.state=this.options.state,this.listenTo(this.col,"add",this.add_one),this.listenTo(this.col,"add",this.mark_collection_as_modified),this.listenTo(this.col,"remove",this.remove_one),this.listenTo(this.col,"change",this.choices_changed),this.listenTo(this.col,"change:is_group",this.render),this.listenTo(this.col,"multiple-selection",this.edit_multiple),this.listenTo(this.col,"changed-order",this.update_sorting),this.listenTo(this.col,"duplicated-item",this.duplicated_item),this.listenTo(this.col,"simple-selection",this.edit_simple),this.listenTo(PC.app.admin,"pasted-data",this.on_paste),this.render()},events:{"click .active-layer":"hide_choices","click .add-layer":"create","keypress .structure-toolbar input":"create",remove:"cleanup_on_remove"},remove_item:function(e){e.remove()},cleanup_on_remove:function(){this.col.each(function(e){e.set("active",!1)}),this.remove_views(),this.stopListening()},duplicated_item:function(){this.render(),this.update_sorting()},has_clipboard_data:function(){return!!PC.clipboard_data},render:function(){this.$el.empty(),this.$el.html(this.template(a.extend({has_clipboard_data:this.has_clipboard_data()},this.model.attributes))),this.remove_views(),this.$active_layer=this.$(".active-layer");var e=wp.template("mkl-pc-content-layer-back-link");return this.$active_layer.html(e(this.model.attributes)),this.$new_input=this.$(".structure-toolbar input"),this.$list=this.$(".choices"),this.$form=this.state.$(".choice-details"),this.add_all(),this.update_groups(),this.setup_sortable(),this},choices_changed:function(e,t){1===a.keys(e.changed).length&&e.changed.hasOwnProperty("active")||(-1==PC.app.modified_choices.indexOf(e.get("layerId")+"_"+e.id)&&PC.app.modified_choices.push(e.get("layerId")+"_"+e.id),PC.app.is_modified[this.collectionName]=!0)},mark_collection_as_modified:function(){PC.app.is_modified[this.collectionName]=!0},add_one:function(e){e=new PC.views.choice({model:e,state:this.state,collection:this.col,form_target:this.$form});this.items.push(e),this.$list.append(e.render().el)},update_groups:function(){a.each(this.items,function(e){var t;e.model.get("parent")&&(t=this.$(".choices[data-item-id="+e.model.get("parent")+"]")).length&&t.append(e.$el)}.bind(this))},remove_one:function(e){this.mark_collection_as_modified()},add_all:function(){this.col.each(this.add_one,this)},setup_sortable:function(){this.$(".choices").sortable({items:".mkl-list-item",placeholder:"mkl-list-item__placeholder",cursor:"move",axis:"y",handle:".sort",forcePlaceholderSize:!0,helper:"clone",opacity:.65,connectWith:".sortable-list",stop:function(e,t){this.update_sorting()}.bind(this)})},update_sorting:function(){this.$(".choices .mkl-list-item").each(function(e,t){var i=!1;l(t).closest(".group-list").length&&(i=l(t).closest(".group-list").data("itemId")),l(t).trigger("update_order",[e,i])}),this.col.sort({silent:!0}),this.$list.sortable("instance")&&this.$list.sortable("refresh")},hide_choices:function(e){e.preventDefault(),this.state.$el.removeClass("show-choices"),this.remove_views(),this.$el.empty(),this.$form.empty()},remove_views:function(){a.each(this.items,this.remove_item),this.items=[]},create:function(e){"keypress"==e.type&&13!==e.which||this.$new_input.val().trim()&&(this.model.get("not_a_choice")&&this.col.length?alert("The layer is set as Not a choice, so only one item can be added."):(e=this.col.add(this.new_attributes(this.$new_input.val().trim())),PC.app.modified_choices.push(e.get("layerId")+"_"+e.id),this.$new_input.val("")))},new_attributes:function(e){return{_id:PC.app.get_new_id(this.col),name:e,order:this.col.nextOrder(),active:!0,layerId:this.model.id}},edit_multiple:function(){this.edit_multiple_items_form&&this.edit_multiple_items_form.remove(),this.col.where({active:!0}).length&&(this.edit_multiple_items_form=new PC.views.multiple_edit_form({collection:this.col,view:this}),this.$form.append(this.edit_multiple_items_form.$el))},edit_simple:function(){this.edit_multiple_items_form&&(this.edit_multiple_items_form=null)},on_paste(n){if(n&&"choices"===n.type&&n.models){let i=[],s=[],o=(a.each(n.models,e=>{var t=e._id,e=(e._id=PC.app.get_new_id(this.col),e.layerId=this.model.id,e.order=this.col.nextOrder(),this.col.create(e));PC.app.modified_choices.push(e.get("layerId")+"_"+e.id),1===n.models.length&&this.model.set("active",!1),i[t]=e.id,s.push(e)}),0);s.forEach(e=>{var t=e.get("parent");t&&(i[t]?(e.set("parent",i[t]),o++):e.unset("parent"))}),o&&this.duplicated_item()}}}),PC.views.choiceLabel=Backbone.View.extend({tagName:"span",template:wp.template("mkl-pc-content-choice-list-item--label"),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.attributes))}}),PC.views.choice=PC.views.layer.extend({edit_view:function(){return PC.views.choiceDetails},events:{"click > button":"edit",drop:"drop",update_order:"update_order"},template:wp.template("mkl-pc-content-choice-list-item"),initialize:function(e){this.options=e||{},this.form_target=e.form_target,this.listenTo(this.model,"change:active",this.activate),this.listenTo(this.model,"change:name change:admin_label",this.update_label),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.addClass("choice"),this.$el.toggleClass("is-group",!!this.model.get("is_group")),this.$el.data("view",this),this.$el.html(this.template(this.model.attributes)),this.label||(this.label=new PC.views.choiceLabel({model:this.model}),this.$("h3").append(this.label.$el)),1!=this.model.get("active")&&"true"!=this.model.get("active")||this.edit(),this},update_label:function(){this.label.render()},update_order:function(e,t,i){e.stopPropagation(),i&&i==this.model.id||this.model.set({order:t,parent:i})},drop:function(e,t,i){this.dropped&&this.dropped==e.timeStamp||(this.dropped=e.timeStamp,!0===this.model.get("active")&&this.model.set("active",!1),this.$el.closest(".group-list").length||e.target!=this.el?e.target==this.el&&l(e.target).trigger("update-sort",[this.model,t,1]):l(e.target).trigger("update-sort",[this.model,t,0]),this.form&&this.form.remove())}}),PC.views.choiceDetails=Backbone.View.extend({tagName:"div",className:"choice-form",template:wp.template("mkl-pc-content-choice-form"),collectionName:"content",initialize:function(e){this.admin=PC.app.get_admin(),this.toggled_status.init(),this.angles=this.admin.angles,this.layer=PC.app.admin.layers.get(this.model.get("layerId")),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,wp.hooks.applyFilters("PC.admin.choice_form.render.on.change.events","change:is_group"),this.render),PC.currentEditedItem=this.model,wp.hooks.doAction("PC.admin.choiceDetails.init",this)},events:{"click .delete-item":"delete_choice","click .confirm-delete":"delete_choice","click .cancel-delete":"delete_choice","click .duplicate-item":"duplicate_choice","click .copy-item":"copy_choice","keyup .setting input":"form_change","input .setting input":"form_change","change .setting input[type=date]":"form_change","keyup .setting textarea":"form_change","change .setting select":"form_change",'click [type="checkbox"]':"form_change","click .mkl-pc--action":"trigger_custom_action","click button.components-panel__body-toggle":"toggle_section","click .hide-addon-placeholder":"hide_addon","focus input.color-hex":"toggle_iris",remove:"on_remove"},on_remove:function(e){this.$(".wp-picker-container.wp-picker-active input.color-hex").wpColorPicker("close")},render:function(){var e=this.layer?{not_a_choice:this.layer.get("not_a_choice"),layer_type:this.layer.get("type"),layer:this.layer.attributes}:{},e=a.extend({},a.defaults(e,this.model.attributes),{toggled_status:this.toggled_status.statuses});return this.$el.html(this.template(e)),this.$pictures=this.$(".views"),this.model.get("is_group")?this.add_angle(this.angles.first()):this.angles.each(this.add_angle,this),this.delete_btns={prompt:this.$(".delete-item"),confirm:this.$(".prompt-delete")},this.populate_angles_list(),this.$("input.color-hex").wpColorPicker({change:function(e,t){e=l(e.target);e.val(t.color.toString()),e.trigger("input")},clear:function(e,t){var i=l(this).closest(".wp-picker-container").find('input[type="text"]');i.val(""),i.trigger("input")}}),this.$(".section-fields:empty").closest(".setting-section").hide(),wp.hooks.doAction("PC.admin.choiceDetails.render",this),this},form_change:function(e){var t,i=l(e.currentTarget),s=i.data("setting");("keyup"!==e.type&&"input"!==e.type||"checkbox"!==e.currentTarget.type)&&("click"===e.type?(t=i.prop("checked"),"is_default"==s&&t&&"simple"==this.layer.get("type")&&this.model.collection.invoke("set",{is_default:!1})):t="text"===e.currentTarget.type||"textarea"===e.currentTarget.type?i.val().trim():i.val(),this.model.get(s)!=t)&&this.model.set(s,t)},form_changed:function(){},delete_choice:function(e){var t=l(e.currentTarget);switch(t.data("delete")){case"prompt":t.addClass("hidden"),this.delete_btns.confirm.removeClass("hidden");break;case"confirm":this.model.destroy();break;case"cancel":this.delete_btns.prompt.removeClass("hidden"),this.delete_btns.confirm.addClass("hidden")}},duplicate_choice:function(){var e=this.model.clone();e.set("_id",PC.app.get_new_id(this.model.collection)),e.set("name",e.get("name")+" (Copy)"),e.get("admin_label")&&e.set("admin_label",e.get("admin_label")+" (Copy)"),this.model.collection.create(PC.toJSON(e)),PC.app.modified_choices.push(e.get("layerId")+"_"+e.id),this.model.set("active",!1),this.model.collection.trigger("duplicated-item")},copy_choice:function(){PC.copy_items()},add_angle:function(e){var t={angle:e,choice:this.model};this.model.get("images")||this.model.set("images",new PC.choice_pictures);var i=this.model.get("images").get(e.id)||null,i=(t.model=i,new PC.views.choice_picture(t));this.$pictures.append(i.render().el),wp.hooks.doAction("PC.admin.choiceDetails.add_angle",e,i,this)},trigger_custom_action:function(e){var e=l(e.currentTarget),t=e.data("action");t in PC.actions&&PC.actions[t](e,this)},populate_angles_list:function(){var a=PC.app.get_collection("angles");a&&a.length&&this.$('select[data-setting="angle_switch"], .angle-list').each(function(e,t){var i=l(t).data("setting"),s=l(t).data("label_prefix"),o=l(t).val(),n=this.model.get(i)||o;a.each(function(e){l(t).append("<option "+(n==e.id?"selected ":"")+'value="'+e.id+'">'+(s?s+" ":"")+e.get("name")+"</option>")},this)}.bind(this))},toggled_status:{init:function(){this.statuses=JSON.parse(localStorage.getItem("choice_toggle_status"))||{}},set:function(e,t){this.statuses[e]=t,localStorage.setItem("choice_toggle_status",JSON.stringify(this.statuses))},get:function(e){return this.statuses.hasOwnProperty(e)?this.statuses[e]:"opened"}},toggle_section:function(e){var e=l(e.currentTarget).closest(".setting-section"),t=e.data("section");e.toggleClass("is-opened"),this.toggled_status.set(t,e.is(".is-opened")?"opened":"closed")},hide_addon:function(e){e.preventDefault();var e=l(e.currentTarget).closest(".setting"),t=e.closest(".setting-section"),e=/setting-id-(.+)/i.exec(e[0].className);e&&(e=e[1],t.remove(),localStorage.setItem("mkl_pc_settings_hide__"+e,!0),wp.ajax.post({action:"mkl_pc_hide_addon_setting",setting:e,security:PC_lang.user_preferences_nonce}))},toggle_iris:function(e){var e=l(e.target).closest(".wp-picker-container"),t=e.find("button.wp-color-result");e.is(".wp-picker-active")||t.trigger("click")}}),PC.views.choice_picture=Backbone.View.extend({template:wp.template("mkl-pc-content-choice-pictures"),className:"view",collectionName:"content",initialize:function(e){this.options=e||{},this.model&&this.listenTo(this.model,"change",this.has_changed)},events:{"click .edit-attachment":"edit_attachment","click .remove-attachment":"remove_attachment","select-media":"select_attachment"},has_changed:function(){PC.app.is_modified[this.collectionName]=!0},edit_attachment:function(e){e.preventDefault(),this.editing=l(e.currentTarget).closest(".picture").data("edit");e={};e.el=this.$el,this.model&&this.model.get(this.editing).id&&(e.selection=this.model.get(this.editing).id),PC.media.open(e)},select_attachment:function(e,t){if(!this.editing)return!1;this.model||(this.model=new PC.choice_picture({angleId:this.options.angle.id}),this.options.choice.get("images").add(this.model),this.listenTo(this.model,"change",this.has_changed)),this.model.set(this.editing,{url:t.get("url"),id:t.id,dimensions:{height:t.get("height"),width:t.get("width")}}),"thumbnail"!=this.editing||this.options.angle.get("has_thumbnails")||(this.options.angle.collection.invoke("set",{has_thumbnails:!1}),this.options.angle.set("has_thumbnails",!0)),this.render()},remove_attachment:function(e){e=l(e.currentTarget).closest(".picture").data("edit");this.model.set(e,{url:"",id:null,dimensions:{height:0,width:0}}),this.render()},render:function(){this.$el.empty();var e=a.defaults({},this.model?this.model.attributes:{image:{url:""},thumbnail:{url:""}});return e.is_group=this.options.choice.get("is_group"),e.angle_name=this.options.angle.get("name"),e.angle=this.options.angle.toJSON(),this.$el.append(this.template(e)),this}})})(jQuery,PC._us||window._);