var PC=PC||{};PC.views=PC.views||{},((t,s)=>{PC.views.admin=Backbone.View.extend({modals:[],structure:!1,events:{},initialize:function(){this.products=new PC.products,document.addEventListener("paste",this.on_paste.bind(this))},on_paste(e){e=e.clipboardData?.getData("text/plain");try{var t=JSON.parse(e);t&&t.type&&this.trigger("pasted-data",t)}catch(t){console.warn("The pasted data is not a valid json object"),console.log(e),console.log(t)}},open:function(t){if(void 0===t.product_id)throw{name:"Error",message:"product_id parameter is missing to start the configurator."};this.products.get(t.product_id)||this.products.add(t),this.current_product=this.products.get(t.product_id),this.current_product.editor?this.current_product.editor.open():this.current_product.editor=new PC.views.editor({current_product:this.current_product})},close:function(){this.get_current_modal().close()},set_data:function(){0!=PC.app.admin_data.get("layers")&&(this.layers=new PC.layers(PC.app.admin_data.get("layers"))),0!=PC.app.admin_data.get("angles")&&(this.angles=new PC.angles(PC.app.admin_data.get("angles"),{parse:!0}))},remove_relationships:function(t,i){var e;"layers"==t&&(e=this.current_product.get("content")).get(i.id)&&(e.remove(i.id),PC.app.is_modified.content=!0),"angles"==t&&(e=this.current_product.get("content"))&&(e.each(function(t,e){t.get("choices").each(function(t){var e=t.get("images").where({angleId:i.id});t.get("images").remove(e)})},this),PC.app.is_modified.content=!0)},get_current_product:function(){return this.current_product},get_current_modal:function(){return this.current_product.editor}}),PC.views.editor=Backbone.View.extend({tagName:"div",className:"pc-modal-container",template:wp.media.template("mkl-modal"),loading:0,initialize:function(t){return this.product=t.current_product,this.states=new PC.states,this.admin=PC.app.get_admin(),this.admin.structure||(this.loading++,PC.app.admin_data.fetch({success:s.bind(function(t,e,i){this.admin.set_data(),this.fetched(t,e,i),this.contentMissing&&(this.contentMissing=!1,this.product.fetch({success:s.bind(this.fetched,this),error:function(t,e,i){console.log("error fecthing data"),console.log(t,e,i)}}))},this),error:function(t,e,i){console.log("error fecthing data"),console.log(t,e,i)}})),this.product.get("content")||(this.loading++,this.contentMissing=!0),this.open(),this.$el.addClass("loading"),this.states.fetch({url:this.states.url()+"&id="+this.product.id,success:s.bind(this.fetched,this)}),this.loading++,this},fetched:function(t,e,i){this.loading--,0==this.loading&&(this.refresh(),this.$el.removeClass("loading"))},events:{"click .media-modal-close":"close"},open:function(){if(this.opened)return!1;this.modal||(this.render(),this.modal=this.$(".pc-modal"),this.backdrop=this.$(".pc-modal-backdrop"),this.modal_content=this.modal.find(".media-frame"),this.statesView=new PC.views.states({el:this.modal_content,parent:this})),this.modal.show(),this.backdrop.show(),this.opened=!0,t("body").addClass("pc-modal-opened")},close:function(){if(-1!=s.indexOf(s.values(PC.app.is_modified),!0)&&!confirm(PC.lang.confirm_closing||"Some values have not been saved. Are you sure you want to close?"))return!1;this.opened=!1,this.modal.hide(),this.backdrop.hide(),t("body").removeClass("pc-modal-opened")},refresh:function(){this.modal&&this.statesView.render()},render:function(){t("body").append(this.$el.html(this.template()))}})})(jQuery,PC._us||window._);