generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Agency {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  website   String?
  logo      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

model User {
  id                          String                       @id @default(cuid())
  name                        String?
  email                       String                       @unique
  emailVerified               DateTime?
  password                    String?
  passwordResetToken          String?
  passwordResetTokenExpiry    DateTime?
  image                       String?
  role                        UserRole                     @default(USER)
  agencyId                    String?
  onboardingProgress          Json?
  onboardingCompleted         Boolean                      @default(false)
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  address                     String?
  businessDescription         String?
  phone                       String?
  timezone                    String?                      @default("America/New_York")
  website                     String?
  legalEntityName             String? // Legal name for contracts, privacy policy, terms (e.g. "Acme Inc.")
  legalJurisdiction           String? // Country/region for legal pages (e.g. "United States", "California")
  companyLogoUrl              String? // Company logo URL (from onboarding upload; used in CRM and website)
  averageDealValue            Float?
  businessCategory            String?
  businessHours               String?
  businessLanguage            String?                      @default("English")
  campaignTone                String?
  currency                    String?                      @default("USD")
  currentCRM                  String?
  demographics                String?
  emailProvider               String?
  emailProviderConfig         String?
  emailProviderConfigured     Boolean                      @default(false)
  industryNiche               String?
  leadSources                 String?
  monthlyMarketingBudget      String?
  operatingLocation           String?
  paymentProvider             String?
  paymentProviderConfigured   Boolean                      @default(false)
  preferredContactMethod      String?
  primaryMarketingChannel     String?
  productsServices            String?
  salesCycleLength            String?
  smsProvider                 String?
  smsProviderConfig           String?
  smsProviderConfigured       Boolean                      @default(false)
  socialMediaProfiles         String?
  targetAudience              String?
  teamSize                    String?
  websiteTraffic              String?
  quickbooksConfig            String?
  quickbooksConfigured        Boolean                      @default(false)
  whatsappConfig              String?
  whatsappConfigured          Boolean                      @default(false)
  accountStatus               AccountStatus                @default(ACTIVE)
  lastLoginAt                 DateTime?
  suspendedAt                 DateTime?
  suspendedReason             String?
  trialEndsAt                 DateTime?
  industry                    Industry?
  clubCode                    String?                      @unique
  parentRole                  Boolean                      @default(false)
  subdomain                   String?                      @unique
  language                    String?                      @default("en")
  crmVoiceAgentId             String? // ElevenLabs agent ID for CRM voice assistant
  activeWorkflowDraftId       String? // Active workflow draft for voice/chat (cleared when leaving builder)
  workflowExecutions          AIWorkflowExecution[]        @relation("UserWorkflowExecutions")
  workflowInstances           AIWorkflowInstance[]         @relation("UserWorkflowInstances")
  accounts                    Account[]
  achSettlements              AchSettlement[]
  adminSessions               AdminSession[]               @relation("AdminSessions")
  apiKeys                     ApiKey[]
  appointmentTypes            AppointmentType[]
  auditLogs                   AuditLog[]
  autoReplySettings           AutoReplySettings?
  bnplApplications            BnplApplication[]
  appointments                BookingAppointment[]
  bookingSettings             BookingSettings?             @relation("BookingSettings")
  bookingWidgetSettings       BookingWidgetSettings?
  calendarConnections         CalendarConnection[]
  callLogs                    CallLog[]
  campaigns                   Campaign[]
  cashReconciliations         CashReconciliation[]
  cashTransactions            CashTransaction[]
  channelConnections          ChannelConnection[]
  clubOSCommunications        ClubOSCommunication[]        @relation("ClubOSUserCommunications")
  clubOwnerHouseholds         ClubOSHousehold[]            @relation("ClubOSClubOwner")
  clubOSHousehold             ClubOSHousehold?             @relation("ClubOSHousehold")
  clubOSNotificationSettings  ClubOSNotificationSetting[]  @relation("ClubOSNotificationSettings")
  clubOSPrograms              ClubOSProgram[]              @relation("ClubOSUserPrograms")
  clubOSSchedules             ClubOSSchedule[]             @relation("ClubOSUserSchedules")
  clubOSSettings              ClubOSUserRelation?          @relation("ClubOSUserSettings")
  clubOSVenues                ClubOSVenue[]                @relation("ClubOSUserVenues")
  conversations               Conversation[]
  conversationMessages        ConversationMessage[]
  creditApplications          CreditApplication[]
  creditScore                 CreditScore?
  dataExports                 DataExport[]
  dataInsights                DataInsight[]
  dataMonetizationConsents    DataMonetizationConsent[]
  dataMonetizationInsights    DataMonetizationInsight[]
  dataMonetizationRevenues    DataMonetizationRevenue[]
  deals                       Deal[]
  dealActivities              DealActivity[]
  deliveryOrders              DeliveryOrder[]              @relation("UserDeliveryOrders")
  deliveryRatings             DeliveryRating[]             @relation("UserDeliveryRatings")
  deliveryZones               DeliveryZone[]               @relation("UserDeliveryZones")
  driverProfile               Driver?                      @relation("UserDriver")
  ecommerceSyncSettings       EcommerceSyncSettings?       @relation("EcommerceSyncSettings")
  ecommerceWidgets            EcommerceWidget[]
  elevenLabsApiKeys           ElevenLabsApiKey[]           @relation("ElevenLabsApiKeys")
  emailCampaigns              EmailCampaign[]
  emailTemplates             EmailTemplate[]
  smsTemplates               SMSTemplate[]
  scheduledEmails             ScheduledEmail[]
  scheduledSms                ScheduledSms[]
  fraudAlerts                 FraudAlert[]
  generalInventoryAdjustments GeneralInventoryAdjustment[] @relation("InventoryAdjustments")
  generalInventoryCategories  GeneralInventoryCategory[]   @relation("InventoryCategories")
  generalInventoryItems       GeneralInventoryItem[]       @relation("InventoryItems")
  generalInventoryLocations   GeneralInventoryLocation[]   @relation("InventoryLocations")
  generalInventorySuppliers   GeneralInventorySupplier[]   @relation("InventorySuppliers")
  inventoryAdjustments        InventoryAdjustment[]        @relation("UserInventoryAdjustments")
  inventoryItems              InventoryItem[]              @relation("UserInventoryItems")
  invoices                    Invoice[]
  kitchenOrderItems           KitchenOrderItem[]           @relation("UserKitchenOrderItems")
  kitchenStations             KitchenStation[]             @relation("UserKitchenStations")
  knowledgeBase               KnowledgeBase[]
  knowledgeBaseFiles          KnowledgeBaseFile[]          @relation("KnowledgeBaseFiles")
  leads                       Lead[]
  lowStockAlertSettings       LowStockAlertSettings?       @relation("LowStockAlertSettings")
  messages                    Message[]
  notes                       Note[]
  orders                      Order[]
  outboundCalls               OutboundCall[]
  posOrders                   POSOrder[]                   @relation("UserPOSOrders")
  payments                    Payment[]
  paymentProviderSettings     PaymentProviderSettings[]
  pipelines                   Pipeline[]
  products                    Product[]
  productCategories           ProductCategory[]
  purchaseOrders              PurchaseOrder[]              @relation("UserPurchaseOrders")
  purchasedPhoneNumbers       PurchasedPhoneNumber[]
  receipts                    Receipt[]                    @relation("UserReceipts")
  recipes                     Recipe[]                     @relation("UserRecipes")
  referrals                   Referral[]
  relationshipGraphs          RelationshipGraph[]          @relation("UserRelationshipGraphs")
  relationshipMetrics         RelationshipMetrics[]        @relation("UserRelationshipMetrics")
  reservationsAsCustomer      Reservation[]                @relation("CustomerReservations")
  reservationsAsOwner         Reservation[]                @relation("UserReservations")
  reservationSettings         ReservationSettings?         @relation("ReservationSettings")
  restaurantTables            RestaurantTable[]            @relation("RestaurantTables")
  seatingPreferences          SeatingPreference[]          @relation("CustomerSeatingPreferences")
  sessions                    Session[]
  shifts                      Shift[]                      @relation("UserShifts")
  smsCampaigns                SmsCampaign[]
  staff                       Staff[]                      @relation("UserStaff")
  stockAlerts                 StockAlert[]                 @relation("UserStockAlerts")
  storefront                  Storefront?
  impersonatedSessions        SuperAdminSession[]          @relation("ImpersonatedSessions")
  superAdminSessions          SuperAdminSession[]          @relation("SuperAdminSessions")
  suppliers                   Supplier[]                   @relation("UserSuppliers")
  tableLayouts                TableLayout[]                @relation("TableLayouts")
  assignedTasks               Task[]                       @relation("AssignedTasks")
  ownedTasks                  Task[]                       @relation("OwnedTasks")
  taskActivities              TaskActivity[]               @relation("TaskActivities")
  taskAttachments             TaskAttachment[]             @relation("TaskAttachments")
  taskAutomations             TaskAutomation[]             @relation("TaskAutomations")
  taskComments                TaskComment[]                @relation("TaskComments")
  taskTemplates               TaskTemplate[]               @relation("TaskTemplates")
  teamMembers                 TeamMember[]
  toolActions                 ToolAction[]                 @relation("UserToolActions")
  createdToolDefinitions      ToolDefinition[]             @relation("ToolCreator")
  toolHealthMetrics           ToolHealthMetric[]           @relation("UserToolHealthMetrics")
  toolInstances               ToolInstance[]               @relation("UserToolInstances")
  toolRecommendations         ToolRecommendation[]         @relation("UserToolRecommendations")
  toolRelationships           ToolRelationship[]           @relation("UserToolRelationships")
  toolRetirements             ToolRetirement[]             @relation("UserToolRetirements")
  toolUsagePatterns           ToolUsagePattern[]           @relation("UserToolUsagePatterns")
  agency                      Agency?                      @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  featureToggles              UserFeatureToggle[]          @relation("UserFeatureToggles")
  permissions                 UserPermission[]             @relation("UserPermissions")
  subscription                UserSubscription?
  voiceAgents                 VoiceAgent[]
  // Dental Practice Management Relations
  dentalOdontograms           DentalOdontogram[]
  dentalPeriodontalCharts     DentalPeriodontalChart[]
  dentalTreatmentPlans        DentalTreatmentPlan[]
  dentalProcedures            DentalProcedure[]
  dentalForms                 DentalForm[]
  dentalFormResponses         DentalFormResponse[]
  dentalXRays                 DentalXRay[]
  dentalLabOrders             DentalLabOrder[]
  dentalInsuranceClaims       DentalInsuranceClaim[]
  vnaConfigurations           VnaConfiguration[]
  practiceDocuments           PatientDocument[]            @relation("PracticeDocuments")
  documentConsents            DocumentConsent[]
  documentAccessLogs          DocumentAccessLog[]          @relation("DocumentAccessLogUser")
  dataAccessRequests          DataAccessRequest[]          @relation("DataAccessRequestUser")
  // Multi-Clinic Support
  clinicMemberships           UserClinic[]                 @relation("UserClinicMemberships")
  dataBreaches                DataBreach[]                 @relation("DataBreachUser")
  voiceUsage                  VoiceUsage[]
  widgetConfigurations        WidgetConfiguration[]
  widgetEmbeds                WidgetEmbed[]
  workflows                   Workflow[]
  workflowEnrollments         WorkflowEnrollment[]
  workflowOptimizations       WorkflowOptimization[]       @relation("UserWorkflowOptimizations")
  soshoglePaymentCustomer     SoshoglePaymentCustomer?     @relation("SoshoglePaymentCustomer")
  soshoglePaymentMerchant     SoshoglePaymentMerchant?     @relation("SoshoglePaymentMerchant")
  leadGenerationCampaigns     LeadGenerationCampaign[]
  scrapedLeads                ScrapedLead[]
  leadBlacklists              LeadBlacklist[]              @relation("LeadBlacklists")
  abTests                     ABTest[]                     @relation("ABTests")
  socialMediaSettings         SocialMediaSettings[]        @relation("SocialMediaSettings")
  aiEmployees                 AIEmployee[]                 @relation("AIEmployees")
  aiJobs                      AIJob[]                      @relation("AIJobs")
  userAIEmployees             UserAIEmployee[]             @relation("UserAIEmployees")
  aiGeneratedReports          AiGeneratedReport[]          @relation("UserAiGeneratedReports")
  docpenSessions              DocpenSession[]
  docpenVoiceAgents           DocpenVoiceAgent[]
  ehrScheduleSnapshots        EhrScheduleSnapshot[]
  docpenKnowledgeBaseFiles    DocpenKnowledgeBaseFile[]
  feedbackCollections         FeedbackCollection[]
  // Real Estate Industry Relations
  reProperties                REProperty[]                 @relation("REUserProperties")
  reFsboAssignedListings      REFSBOListing[]              @relation("REFSBOAssignedUser")
  reScrapingJobs              REScrapingJob[]              @relation("REScrapingJobUser")
  reMarketStats               REMarketStats[]              @relation("REMarketStatsUser")
  reMarketReports             REMarketReport[]             @relation("REMarketReportUser")
  reStaleDiagnostics          REStaleDiagnostic[]          @relation("REStaleDiagnosticUser")
  reListingPresentations      REListingPresentation[]      @relation("REListingPresentationUser")
  reSellerNetSheets           RESellerNetSheet[]           @relation("RESellerNetSheetUser")
  reCMAReports                RECMAReport[]                @relation("RECMAReportUser")
  reTransactions              RETransaction[]              @relation("RETransactionUser")
  reBuyerCriteria             REBuyerCriteria[]            @relation("REBuyerCriteriaUser")
  reExpiredAssignedListings   REExpiredListing[]           @relation("REExpiredAssignedUser")
  reAIEmployeeExecutions      REAIEmployeeExecution[]      @relation("REAIEmployeeExecutionUser")
  reAIEmployeeAgents          REAIEmployeeAgent[]          @relation("REAIEmployeeAgentUser")
  industryAIEmployeeAgents    IndustryAIEmployeeAgent[]    @relation("IndustryAIEmployeeAgentUser")
  // Real Estate Workflow Relations
  reWorkflowTemplates         REWorkflowTemplate[]         @relation("UserREWorkflowTemplates")
  reWorkflowInstances         REWorkflowInstance[]         @relation("UserREWorkflowInstances")
  reHITLNotifications         REHITLNotification[]         @relation("UserREHITLNotifications")
  // Generic Multi-Industry Workflow Relations
  workflowTemplates           WorkflowTemplate[]           @relation("UserWorkflowTemplates")
  industryWorkflowInstances   WorkflowInstance[]           @relation("UserIndustryWorkflowInstances")
  hitlNotifications           HITLNotification[]           @relation("UserHITLNotifications")
  // White-Label Voice AI Platform Relations
  voiceAISubscription         VoiceAISubscription?         @relation("VoiceAISubscriptionUser")
  voiceAIUsageLogs            VoiceAIUsageLog[]            @relation("VoiceAIUsageLogUser")
  voiceAIBillingRecords       VoiceAIBillingRecord[]       @relation("VoiceAIBillingRecordUser")
  // Website Builder Relations
  websites                    Website[]
}

model Lead {
  id                          String                       @id @default(cuid())
  userId                      String
  businessName                String
  contactPerson               String?
  email                       String?
  phone                       String?
  website                     String?
  address                     String?
  city                        String?
  state                       String?
  zipCode                     String?
  country                     String?
  businessCategory            String?
  googlePlaceId               String?
  rating                      Float?
  status                      LeadStatus                   @default(NEW)
  source                      String                       @default("manual")
  tags                        Json?                        @default("[]")
  contactType                 String?
  lastContactedAt             DateTime?
  dateOfBirth                 DateTime? // Birthday for contact person
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  // AI Lead Generation System fields
  enrichedData                Json? // Company research, decision-makers, email, etc.
  lastEnrichedAt              DateTime? // Last time data was enriched
  leadScore                   Int? // 0-100 weighted score
  engagementHistory           Json? // Email opens, SMS replies, call history
  nextAction                  String? // call, email, sms, manual_followup, etc.
  nextActionDate              DateTime? // When to execute next action
  validationScore             Int? // Data quality score 0-100
  validationErrors            Json? // Array of validation errors
  qualityFlag                 String? // low_quality, high_quality, etc.
  mergeHistory                Json? // Track lead merges for deduplication
  contactAppointments         BookingAppointment[]         @relation("contact_appointments")
  leadAppointments            BookingAppointment[]         @relation("lead_appointments")
  callLogs                    CallLog[]
  campaignLeads               CampaignLead[]
  conversations               Conversation[]
  deals                       Deal[]
  emailCampaignDeals          EmailCampaignDeal[]
  invoices                    Invoice[]
  user                        User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages                    Message[]
  notes                       Note[]
  outboundCalls               OutboundCall[]
  payments                    Payment[]
  referralConverted           Referral[]                   @relation("ConvertedFromReferral")
  referralsMade               Referral[]                   @relation("ReferrerLeads")
  reviews                     Review[]
  feedbackCollections         FeedbackCollection[]
  smsCampaignDeals            SmsCampaignDeal[]
  smsEnrollments              SmsEnrollment[]
  scheduledEmails             ScheduledEmail[]
  scheduledSms                ScheduledSms[]
  tasks                       Task[]
  docpenSessions              DocpenSession[]
  // Real Estate Industry Relations
  rePropertySeller            REProperty[]                 @relation("REPropertySeller")
  reFsboConvertedLead         REFSBOListing[]              @relation("REFSBOConvertedLead")
  // Dental Industry Relations
  familyGroupId               String? // For family grouping (links to same familyGroupId)
  dentalHistory               Json? // Dental history, allergies, medications, etc.
  insuranceInfo               Json? // Insurance provider, policy number, coverage, etc.
  dentalOdontograms           DentalOdontogram[]
  dentalPeriodontalCharts     DentalPeriodontalChart[]
  dentalTreatmentPlans        DentalTreatmentPlan[]
  dentalProcedures            DentalProcedure[]
  dentalFormResponses         DentalFormResponse[]
  dentalXRays                 DentalXRay[]
  dentalLabOrders             DentalLabOrder[]
  dentalInsuranceClaims       DentalInsuranceClaim[]
  patientDocuments            PatientDocument[]            @relation("PatientDocuments")
  documentConsents            DocumentConsent[]
  dataAccessRequests          DataAccessRequest[]
  reTransactions              RETransaction[]              @relation("RETransactionLead")
  reBuyerCriteria             REBuyerCriteria?             @relation("REBuyerCriteriaLead")
  reExpiredConvertedLead      REExpiredListing[]           @relation("REExpiredConvertedLead")
  // Real Estate Workflow Relations
  reWorkflowInstances         REWorkflowInstance[]         @relation("LeadREWorkflowInstances")
  // Generic Multi-Industry Workflow Relations
  workflowInstances           WorkflowInstance[]           @relation("LeadWorkflowInstances")
  workflowEnrollments         WorkflowEnrollment[]         @relation("LeadWorkflowEnrollments")
  workflowTemplateEnrollments WorkflowTemplateEnrollment[] @relation("LeadWorkflowTemplateEnrollments")
  // Website Orders Relations
  websiteOrders               WebsiteOrder[]

  @@index([userId])
  @@index([status])
  @@index([contactType])
  @@index([dateOfBirth])
}

model Note {
  id        String   @id @default(cuid())
  leadId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

model Message {
  id          String   @id @default(cuid())
  leadId      String
  userId      String
  content     String
  messageType String   @default("ai_generated")
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  service   String
  keyName   String
  keyValue  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, service, keyName])
  @@index([userId])
}

model EhrScheduleSnapshot {
  id            String   @id @default(cuid())
  userId        String
  clinicId      String?
  ehrType       String   // dentrix, dentitek, etc.
  captureDate   DateTime // Date the schedule is for
  snapshotAt    DateTime @default(now())
  availability  Json     // { slots: ["09:00", "10:30", ...], booked: [{time, patient}], dateRange }
  source        String   @default("screenshot") // "screenshot" | "dom"
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, captureDate])
}

model Campaign {
  id              String            @id @default(cuid())
  userId          String
  name            String
  description     String?
  type            CampaignType
  status          CampaignStatus    @default(DRAFT)
  smsTemplate     String?
  reviewUrl       String?
  referralReward  String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  aiGenerated     Boolean           @default(false)
  aiPrompt        String?
  clickRate       Float?
  clickedCount    Int               @default(0)
  deliveredCount  Int               @default(0)
  emailBody       String?
  emailHtml       String?
  emailSubject    String?
  frequency       CampaignFrequency @default(ONE_TIME)
  lastRunAt       DateTime?
  openRate        Float?
  openedCount     Int               @default(0)
  recurringDays   Int[]             @default([])
  scheduledFor    DateTime?
  sentCount       Int               @default(0)
  targetAudience  Json?
  totalRecipients Int               @default(0)
  callScript      String?
  voiceAgentId    String?

  // Voice Campaign specific fields (Phase 2)
  maxCallsPerDay   Int?    @default(50)
  callWindowStart  String? @default("09:00")
  callWindowEnd    String? @default("17:00")
  retryFailedCalls Boolean @default(true)
  maxRetries       Int?    @default(2)
  minLeadScore     Int?    @default(75)

  // Voice analytics
  totalCalls      Int @default(0)
  answeredCalls   Int @default(0)
  voicemails      Int @default(0)
  avgCallDuration Int @default(0)

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceAgent    VoiceAgent?       @relation(fields: [voiceAgentId], references: [id])
  campaignLeads CampaignLead[]
  messages      CampaignMessage[]
  reviews       Review[]

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
  @@index([minLeadScore])
}

model CampaignMessage {
  id             String    @id @default(cuid())
  campaignId     String
  recipientType  String
  recipientId    String
  recipientEmail String?
  recipientPhone String?
  recipientName  String?
  status         String    @default("PENDING")
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  errorMessage   String?
  twilioSid      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  callDuration   Int?
  callLogId      String?
  callStatus     String?
  callLog        CallLog?  @relation(fields: [callLogId], references: [id])
  campaign       Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([status])
  @@index([recipientId])
}

model CampaignLead {
  id           String             @id @default(cuid())
  campaignId   String
  leadId       String
  status       CampaignLeadStatus @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  respondedAt  DateTime?
  twilioSid    String?
  errorMessage String?
  attempts     Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  campaign     Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead         Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([campaignId, leadId])
  @@index([campaignId])
  @@index([leadId])
}

model Review {
  id         String       @id @default(cuid())
  campaignId String
  leadId     String
  source     ReviewSource
  rating     Int
  reviewText String?
  reviewUrl  String?
  isPublic   Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  campaign   Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead       Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([leadId])
}

model FeedbackCollection {
  id            String    @id @default(cuid())
  userId        String
  leadId        String
  appointmentId String?
  method        String // SMS, VOICE, BOTH
  status        String    @default("PENDING") // PENDING, COMPLETED, FAILED
  sentiment     String? // POSITIVE, NEGATIVE, NEUTRAL
  rating        Int?
  feedbackText  String?
  triggeredAt   DateTime  @default(now())
  completedAt   DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([appointmentId])
  @@index([status])
}

model Referral {
  id              String         @id @default(cuid())
  userId          String
  referrerId      String
  referredName    String
  referredEmail   String?
  referredPhone   String?
  status          ReferralStatus @default(PENDING)
  notes           String?
  rewardGiven     Boolean        @default(false)
  rewardDetails   String?
  convertedLeadId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  convertedLead   Lead?          @relation("ConvertedFromReferral", fields: [convertedLeadId], references: [id])
  referrer        Lead           @relation("ReferrerLeads", fields: [referrerId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([referrerId])
  @@index([status])
}

model VoiceAgent {
  id                      String           @id @default(cuid())
  userId                  String
  name                    String
  description             String?
  type                    VoiceAgentType   @default(INBOUND)
  status                  VoiceAgentStatus @default(TESTING)
  twilioPhoneNumber       String?
  twilioAccountId         String? // Which Twilio account owns this number
  backupPhoneNumber       String? // Backup number if failover occurred
  lastHealthCheck         DateTime?
  healthStatus            String? // HEALTHY, DEGRADED, FAILED
  businessName            String
  businessIndustry        String?
  knowledgeBase           String?
  knowledgeBaseSources    Json?
  greetingMessage         String?
  voiceId                 String?
  elevenLabsAgentId       String?
  stability               Float?           @default(0.5)
  similarityBoost         Float?           @default(0.75)
  style                   Float?           @default(0.0)
  useSpeakerBoost         Boolean?         @default(true)
  ttsModel                String?          @default("eleven_turbo_v2")
  outputFormat            String?          @default("pcm_16000")
  llmModel                String?          @default("gpt-4")
  temperature             Float?           @default(0.7)
  maxTokens               Int?             @default(500)
  firstMessage            String?
  systemPrompt            String?
  maxCallDuration         Int?             @default(600)
  enableInterruptions     Boolean?         @default(true)
  responseDelay           Int?             @default(100)
  pronunciationDict       String?
  language                String?          @default("en")
  googleCalendarId        String?
  availableHours          String?
  appointmentDuration     Int?             @default(30)
  transferPhone           String?
  enableVoicemail         Boolean?         @default(false)
  voicemailMessage        String?
  webhookUrl              String?
  customData              String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  enableCallRecording     Boolean?         @default(true)
  enableTranscription     Boolean?         @default(true)
  recordingEmailAddress   String?
  sendRecordingEmail      Boolean?         @default(false)
  elevenLabsPhoneNumberId String?
  enableReservations      Boolean?         @default(false)
  inboundGreeting         String?
  outboundGreeting        String?

  // Relations
  twilioAccount      TwilioAccount?                @relation(fields: [twilioAccountId], references: [id], onDelete: SetNull)
  callLogs           CallLog[]
  campaigns          Campaign[]
  outboundCalls      OutboundCall[]
  user               User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  knowledgeBaseFiles VoiceAgentKnowledgeBaseFile[] @relation("VoiceAgentKnowledgeFiles")
  usageRecords       VoiceUsage[]

  @@index([userId])
  @@index([status])
  @@index([twilioAccountId])
  @@index([healthStatus])
}

model PurchasedPhoneNumber {
  id               String         @id @default(cuid())
  userId           String
  phoneNumber      String
  friendlyName     String?
  country          String
  capabilities     Json?
  twilioSid        String         @unique
  twilioAccountId  String?        // Which Twilio account owns this number
  status           String         @default("active")
  purchasedAt      DateTime       @default(now())
  lastUsedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  twilioAccount     TwilioAccount? @relation(fields: [twilioAccountId], references: [id], onDelete: SetNull)

  @@unique([userId, phoneNumber])
  @@index([userId])
  @@index([phoneNumber])
  @@index([twilioAccountId])
}

model CallLog {
  id                       String              @id @default(cuid())
  userId                   String
  voiceAgentId             String?
  leadId                   String?
  direction                CallDirection
  status                   CallStatus          @default(INITIATED)
  outcome                  CallOutcome?
  fromNumber               String
  toNumber                 String
  duration                 Int?
  recordingUrl             String?
  transcription            String?
  transcript               String?
  conversationData         String?
  twilioCallSid            String?             @unique
  cost                     Float?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  elevenLabsConversationId String?             @unique
  endedAt                  DateTime?
  emailSent                Boolean             @default(false)
  emailSentAt              DateTime?
  conversationAnalysis     Json?
  sentiment                String?
  callOutcome              String?
  phoneNumber              String?
  appointment              BookingAppointment?
  lead                     Lead?               @relation(fields: [leadId], references: [id])
  user                     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceAgent               VoiceAgent?         @relation(fields: [voiceAgentId], references: [id])
  campaignMessages         CampaignMessage[]
  outboundCall             OutboundCall?
  voiceUsage               VoiceUsage?

  @@index([userId])
  @@index([voiceAgentId])
  @@index([leadId])
  @@index([status])
  @@index([elevenLabsConversationId])
  @@index([emailSent])
}

model OutboundCall {
  id              String             @id @default(cuid())
  userId          String
  voiceAgentId    String
  leadId          String?
  name            String
  phoneNumber     String
  status          OutboundCallStatus @default(SCHEDULED)
  scheduledFor    DateTime?
  attemptCount    Int                @default(0)
  maxAttempts     Int                @default(3)
  callLogId       String?            @unique
  purpose         String?
  notes           String?
  customVariables String?
  lastAttemptAt   DateTime?
  completedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  callLog         CallLog?           @relation(fields: [callLogId], references: [id])
  lead            Lead?              @relation(fields: [leadId], references: [id])
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceAgent      VoiceAgent         @relation(fields: [voiceAgentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([voiceAgentId])
  @@index([status])
}

model CalendarConnection {
  id                String               @id @default(cuid())
  userId            String
  provider          CalendarProvider
  providerAccountId String?
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  calendarId        String?
  calendarName      String?
  syncEnabled       Boolean              @default(true)
  lastSyncAt        DateTime?
  syncStatus        SyncStatus           @default(PENDING)
  webhookUrl        String?
  apiKey            String?
  settings          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  appointments      BookingAppointment[]
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

model ChannelConnection {
  id                String                  @id @default(cuid())
  userId            String
  channelType       ChannelType
  channelIdentifier String?
  displayName       String?
  status            ChannelConnectionStatus @default(PENDING_AUTH)
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  tokenExpiresAt    DateTime?
  providerType      String                  @default("internal")
  providerAccountId String?
  providerData      Json?
  metadata          Json?
  isDefault         Boolean                 @default(false)
  isActive          Boolean                 @default(true)
  syncEnabled       Boolean                 @default(true)
  lastSyncAt        DateTime?
  lastSyncedAt      DateTime?
  lastSyncCursor    String?
  errorMessage      String?
  webhookSecret     String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations     Conversation[]

  @@index([userId])
  @@index([channelType])
  @@index([userId, providerType, channelType])
}

model Conversation {
  id                     String                @id @default(cuid())
  userId                 String
  channelConnectionId    String
  leadId                 String?
  contactName            String
  contactIdentifier      String
  contactAvatar          String?
  status                 ConversationStatus    @default(ACTIVE)
  unreadCount            Int                   @default(0)
  lastMessageAt          DateTime?
  lastMessagePreview     String?
  externalConversationId String?
  metadata               Json?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  channelConnection      ChannelConnection     @relation(fields: [channelConnectionId], references: [id], onDelete: Cascade)
  lead                   Lead?                 @relation(fields: [leadId], references: [id])
  user                   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages               ConversationMessage[]

  @@unique([channelConnectionId, contactIdentifier])
  @@index([userId])
  @@index([channelConnectionId])
  @@index([leadId])
  @@index([status])
}

model ConversationMessage {
  id                String           @id @default(cuid())
  conversationId    String
  userId            String
  direction         MessageDirection
  status            MessageStatus    @default(SENT)
  content           String
  attachments       Json?
  sentAt            DateTime         @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?
  externalMessageId String?
  providerData      Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
  @@index([sentAt])
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String
  category  String?
  tags      String?
  isActive  Boolean  @default(true)
  priority  Int      @default(0)
  fileUrl   String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model AutoReplySettings {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  isEnabled              Boolean  @default(false)
  responseTone           String   @default("professional")
  responseLanguage       String   @default("en")
  businessHoursEnabled   Boolean  @default(true)
  businessHoursStart     String?
  businessHoursEnd       String?
  businessDays           String?
  timezone               String   @default("America/New_York")
  afterHoursMessage      String?
  channelSettings        Json?
  maxResponseLength      Int      @default(500)
  confidenceThreshold    Float    @default(0.7)
  useConversationHistory Boolean  @default(true)
  historyDepth           Int      @default(10)
  escalationKeywords     String?
  escalationTopics       String?
  notifyOnEscalation     Boolean  @default(true)
  notificationEmail      String?
  notificationPhone      String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Pipeline {
  id           String          @id @default(cuid())
  userId       String
  name         String
  description  String?
  color        String?
  isDefault    Boolean         @default(false)
  displayOrder Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  deals        Deal[]
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  stages       PipelineStage[]

  @@index([userId])
  @@index([isDefault])
}

model PipelineStage {
  id              String   @id @default(cuid())
  pipelineId      String
  name            String
  displayOrder    Int      @default(0)
  probability     Int      @default(0)
  rottenAfterDays Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deals           Deal[]
  pipeline        Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([pipelineId])
  @@index([displayOrder])
}

model Deal {
  id                  String               @id @default(cuid())
  userId              String
  pipelineId          String
  stageId             String
  leadId              String?
  title               String
  description         String?
  value               Float                @default(0)
  currency            String               @default("USD")
  probability         Int                  @default(0)
  priority            DealPriority         @default(MEDIUM)
  expectedCloseDate   DateTime?
  actualCloseDate     DateTime?
  lostReason          String?
  assignedToId        String?
  tags                String?
  customFields        Json?
  rottenSince         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  assignedTo          TeamMember?          @relation("AssignedDeals", fields: [assignedToId], references: [id])
  lead                Lead?                @relation(fields: [leadId], references: [id])
  pipeline            Pipeline             @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage               PipelineStage        @relation(fields: [stageId], references: [id])
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities          DealActivity[]
  emailCampaignDeals  EmailCampaignDeal[]
  invoices            Invoice[]
  payments            Payment[]
  smsCampaignDeals    SmsCampaignDeal[]
  tasks               Task[]
  workflowEnrollments WorkflowEnrollment[]
  // Real Estate Workflow Relations
  reWorkflowInstances REWorkflowInstance[] @relation("DealREWorkflowInstances")
  // Generic Multi-Industry Workflow Relations
  workflowInstances   WorkflowInstance[]   @relation("DealWorkflowInstances")

  @@index([userId])
  @@index([pipelineId])
  @@index([stageId])
  @@index([leadId])
}

model DealActivity {
  id          String           @id @default(cuid())
  dealId      String
  userId      String
  type        DealActivityType
  description String
  metadata    Json?
  createdAt   DateTime         @default(now())
  deal        Deal             @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([createdAt])
}

model Workflow {
  id            String               @id @default(cuid())
  userId        String
  name          String
  description   String?
  status        WorkflowStatus       @default(DRAFT)
  triggerType   WorkflowTriggerType
  triggerConfig Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  metadata      Json?
  scheduledDate DateTime?
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  actions       WorkflowAction[]
  enrollments   WorkflowEnrollment[]

  @@index([userId])
  @@index([status])
  @@index([scheduledDate])
}

model WorkflowAction {
  id             String                    @id @default(cuid())
  workflowId     String
  type           WorkflowActionType
  displayOrder   Int                       @default(0)
  actionConfig   Json
  delayMinutes   Int?
  parentActionId String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  parentAction   WorkflowAction?           @relation("ActionBranches", fields: [parentActionId], references: [id], onDelete: Cascade)
  childActions   WorkflowAction[]          @relation("ActionBranches")
  workflow       Workflow                  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executions     WorkflowActionExecution[]

  @@index([workflowId])
  @@index([displayOrder])
}

model WorkflowEnrollment {
  id          String                    @id @default(cuid())
  workflowId  String
  userId      String
  leadId      String?
  dealId      String?
  status      WorkflowEnrollmentStatus  @default(ACTIVE)
  enrolledAt  DateTime                  @default(now())
  completedAt DateTime?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  executions  WorkflowActionExecution[]
  deal        Deal?                     @relation(fields: [dealId], references: [id])
  lead        Lead?                     @relation("LeadWorkflowEnrollments", fields: [leadId], references: [id])
  user        User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow    Workflow                  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([userId])
  @@index([status])
}

model WorkflowActionExecution {
  id           String                        @id @default(cuid())
  enrollmentId String
  actionId     String
  status       WorkflowActionExecutionStatus @default(PENDING)
  scheduledFor DateTime?
  executedAt   DateTime?
  errorMessage String?
  result       Json?
  createdAt    DateTime                      @default(now())
  updatedAt    DateTime                      @updatedAt
  action       WorkflowAction                @relation(fields: [actionId], references: [id], onDelete: Cascade)
  enrollment   WorkflowEnrollment            @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([actionId])
  @@index([status])
}

model EmailCampaign {
  id           String              @id @default(cuid())
  userId       String
  name         String
  subject      String
  previewText  String?
  htmlContent  String
  textContent  String?
  status       EmailCampaignStatus @default(DRAFT)
  fromName     String?
  fromEmail    String?
  replyTo      String?
  scheduledFor DateTime?
  sentAt       DateTime?
  tags         String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipients   EmailCampaignDeal[]

  @@index([userId])
  @@index([status])
}

model EmailCampaignDeal {
  id             String                  @id @default(cuid())
  campaignId     String
  dealId         String?
  leadId         String?
  recipientEmail String
  recipientName  String?
  status         EmailCampaignDealStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  errorMessage   String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  campaign       EmailCampaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  deal           Deal?                   @relation(fields: [dealId], references: [id])
  lead           Lead?                   @relation(fields: [leadId], references: [id])

  @@index([campaignId])
  @@index([status])
}

// AI-drafted emails pending user approval - send now or schedule for later
model ScheduledEmail {
  id           String    @id @default(cuid())
  userId       String
  leadId       String
  toEmail      String
  toName       String?
  subject      String
  body         String    @db.Text
  scheduledFor DateTime // When to send (now = immediate, future = scheduled)
  status       String    @default("PENDING") // PENDING, SENT, CANCELLED
  sentAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead         Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

// AI-drafted SMS pending user approval - send now or schedule for later
model ScheduledSms {
  id           String    @id @default(cuid())
  userId       String
  leadId       String
  toPhone      String
  toName       String?
  message      String    @db.Text
  scheduledFor DateTime
  status       String    @default("PENDING") // PENDING, SENT, CANCELLED
  sentAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead         Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

// Reusable email templates (for campaigns, workflows, AI drafting)
model EmailTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  subject     String
  body        String   @db.Text
  bodyHtml    String?  @db.Text
  variables   Json?    // e.g. ["firstName", "companyName"] for AI personalization
  category    String?  // welcome, follow_up, invoice, etc.
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
}

// Reusable SMS templates (for campaigns, workflows, AI drafting)
model SMSTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  message     String   @db.Text
  variables   Json?    // e.g. ["firstName", "companyName"]
  category    String?  // welcome, reminder, appointment, etc.
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
}

model SmsCampaign {
  id              String            @id @default(cuid())
  userId          String
  name            String
  message         String
  status          SmsCampaignStatus @default(DRAFT)
  fromNumber      String?
  scheduledFor    DateTime?
  sentAt          DateTime?
  completedAt     DateTime?
  tags            String?
  // Phase 1: Lead filtering
  minLeadScore    Int?              @default(75) // Only send to leads with score >= this value
  targetLeadIds   Json? // Optional: specific lead IDs to target
  // Phase 1: Frequency capping
  dailyLimit      Int? // Max messages per day (null = unlimited)
  weeklyLimit     Int? // Max messages per week (null = unlimited)
  lastSentDate    DateTime? // Track when last message was sent for rate limiting
  sentToday       Int               @default(0) // Counter for messages sent today
  sentThisWeek    Int               @default(0) // Counter for messages sent this week
  // Phase 1: Campaign metrics
  totalRecipients Int               @default(0) // Total leads targeted
  totalSent       Int               @default(0) // Total successfully sent
  totalDelivered  Int               @default(0) // Total delivered
  totalReplied    Int               @default(0) // Total replied
  totalFailed     Int               @default(0) // Total failed
  // Multi-step sequence support
  isSequence      Boolean           @default(false) // Whether this is a multi-step campaign
  triggerType     String? // MANUAL, LEAD_CREATED, etc.
  avgReplyRate    Float             @default(0) // Average reply rate across sequences
  totalCompleted  Int               @default(0) // Total leads who completed sequence
  totalEnrolled   Int               @default(0) // Total leads enrolled
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipients      SmsCampaignDeal[]
  sequences       SmsSequence[]
  enrollments     SmsEnrollment[]

  @@index([userId])
  @@index([status])
  @@index([minLeadScore])
}

// Multi-step SMS sequences
model SmsSequence {
  id            String @id @default(cuid())
  campaignId    String
  sequenceOrder Int // Order in the sequence (1, 2, 3, etc.)
  name          String
  message       String

  // Timing
  delayDays  Int     @default(0) // Days to wait after previous SMS
  delayHours Int     @default(0) // Additional hours to wait
  sendTime   String? // Preferred send time (HH:MM)

  // Conditions
  skipIfReplied Boolean @default(false) // Skip if lead replied to previous SMS

  // Analytics
  totalSent      Int @default(0)
  totalDelivered Int @default(0)
  totalReplied   Int @default(0)
  totalFailed    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign SmsCampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages SmsSequenceMessage[]

  @@unique([campaignId, sequenceOrder])
  @@index([campaignId])
  @@index([sequenceOrder])
}

// Track leads enrolled in SMS sequences
model SmsEnrollment {
  id         String @id @default(cuid())
  campaignId String
  leadId     String
  status     String @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED, CANCELLED

  // Progress tracking
  currentSequenceId String? // Current sequence in the campaign
  currentStep       Int       @default(0) // Current step number
  nextSendAt        DateTime? // When to send next SMS

  // Engagement tracking
  totalReplied  Int       @default(0)
  lastRepliedAt DateTime?

  // Status tracking
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  pausedAt    DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign SmsCampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead     Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages SmsSequenceMessage[]

  @@unique([campaignId, leadId])
  @@index([campaignId])
  @@index([leadId])
  @@index([status])
  @@index([nextSendAt])
}

// Track individual SMS messages in sequences
model SmsSequenceMessage {
  id           String @id @default(cuid())
  enrollmentId String
  sequenceId   String

  // Recipient info
  recipientPhone String
  recipientName  String?

  // Message content (snapshot at send time)
  message String

  // Delivery tracking
  status       String    @default("PENDING") // PENDING, SENT, DELIVERED, FAILED
  scheduledFor DateTime
  sentAt       DateTime?
  deliveredAt  DateTime?
  repliedAt    DateTime?

  // Provider data
  twilioSid    String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollment SmsEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  sequence   SmsSequence   @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([sequenceId])
  @@index([status])
  @@index([scheduledFor])
  @@index([recipientPhone])
}

model SmsCampaignDeal {
  id             String                @id @default(cuid())
  campaignId     String
  dealId         String?
  leadId         String?
  recipientPhone String
  recipientName  String?
  status         SmsCampaignDealStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  clickedAt      DateTime?
  repliedAt      DateTime?
  twilioSid      String?
  errorMessage   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  campaign       SmsCampaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  deal           Deal?                 @relation(fields: [dealId], references: [id])
  lead           Lead?                 @relation(fields: [leadId], references: [id])

  @@index([campaignId])
  @@index([status])
}

model TeamMember {
  id            String           @id @default(cuid())
  userId        String
  email         String
  name          String
  role          TeamMemberRole   @default(AGENT)
  status        TeamMemberStatus @default(INVITED)
  avatar        String?
  phone         String?
  invitedAt     DateTime         @default(now())
  joinedAt      DateTime?
  lastActiveAt  DateTime?
  permissions   Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  assignedDeals Deal[]           @relation("AssignedDeals")
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([userId])
  @@index([status])
}

model AppointmentType {
  id                String                  @id @default(cuid())
  userId            String
  name              String
  description       String?
  category          AppointmentTypeCategory @default(CONSULTATION)
  duration          Int                     @default(30)
  price             Float?
  currency          String                  @default("USD")
  color             String?
  isActive          Boolean                 @default(true)
  requiresPayment   Boolean                 @default(false)
  paymentRequired   String?                 @default("none")
  depositPercentage Float?
  bufferTimeBefore  Int?                    @default(0)
  bufferTimeAfter   Int?                    @default(0)
  maxBookingsPerDay Int?
  bookingLeadTime   Int?                    @default(60)
  questions         Json?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings          BookingAppointment[]

  @@index([userId])
  @@index([isActive])
}

model BookingAppointment {
  id                   String              @id @default(cuid())
  userId               String
  clinicId             String?
  appointmentTypeId    String?
  leadId               String?
  calendarConnectionId String?
  callLogId            String?             @unique
  customerName         String
  customerEmail        String?
  customerPhone        String
  customerTimezone     String?
  appointmentDate      DateTime
  duration             Int                 @default(30)
  status               AppointmentStatus   @default(SCHEDULED)
  notes                String?
  customerResponses    Json?
  internalNotes        String?
  externalEventId      String?
  externalEventLink    String?
  syncStatus           SyncStatus          @default(PENDING)
  lastSyncAt           DateTime?
  reminderSent         Boolean             @default(false)
  reminderSentAt       DateTime?
  confirmationSent     Boolean             @default(false)
  cancellationReason   String?
  cancelledAt          DateTime?
  cancelledBy          String?
  requiresPayment      Boolean             @default(false)
  paymentId            String?             @unique
  meetingLocation      String?
  meetingLink          String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  contactId            String?
  confirmationCode     String?
  meetingType          MeetingType?        @default(PHONE_CALL)
  appointmentType      AppointmentType?    @relation(fields: [appointmentTypeId], references: [id])
  calendarConnection   CalendarConnection? @relation(fields: [calendarConnectionId], references: [id])
  callLog              CallLog?            @relation(fields: [callLogId], references: [id])
  contact              Lead?               @relation("contact_appointments", fields: [contactId], references: [id])
  lead                 Lead?               @relation("lead_appointments", fields: [leadId], references: [id])
  payment              Payment?            @relation(fields: [paymentId], references: [id])
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic               Clinic?             @relation(fields: [clinicId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clinicId])
  @@index([appointmentTypeId])
  @@index([leadId])
  @@index([contactId])
  @@index([appointmentDate])
  @@index([status])
}

model PaymentProviderSettings {
  id             String          @id @default(cuid())
  userId         String
  provider       PaymentProvider
  isActive       Boolean         @default(false)
  isDefault      Boolean         @default(false)
  publishableKey String?
  secretKey      String?
  webhookSecret  String?
  merchantId     String?
  clientId       String?
  accountId      String?
  currency       String          @default("USD")
  testMode       Boolean         @default(true)
  settings       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  payments       Payment[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([isActive])
}

model Payment {
  id                 String                   @id @default(cuid())
  userId             String
  providerId         String?
  provider           PaymentProvider          @default(STRIPE)
  providerPaymentId  String?
  providerCustomerId String?
  amount             Float
  currency           String                   @default("USD")
  status             PaymentStatus            @default(PENDING)
  paymentType        PaymentType              @default(OTHER)
  customerName       String
  customerEmail      String
  customerPhone      String?
  dealId             String?
  leadId             String?
  invoiceId          String?
  paymentMethod      String?
  last4              String?
  cardBrand          String?
  description        String?
  metadata           Json?
  refundedAmount     Float                    @default(0)
  refundReason       String?
  refundedAt         DateTime?
  receiptUrl         String?
  receiptNumber      String?
  errorMessage       String?
  paidAt             DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  bookingAppointment BookingAppointment?
  deal               Deal?                    @relation(fields: [dealId], references: [id])
  invoice            Invoice?                 @relation(fields: [invoiceId], references: [id])
  lead               Lead?                    @relation(fields: [leadId], references: [id])
  paymentProvider    PaymentProviderSettings? @relation(fields: [providerId], references: [id])
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
  @@index([status])
  @@index([paymentType])
}

model Invoice {
  id             String        @id @default(cuid())
  userId         String
  invoiceNumber  String        @unique
  customerName   String
  customerEmail  String
  customerPhone  String?
  billingAddress Json?
  status         InvoiceStatus @default(DRAFT)
  issueDate      DateTime      @default(now())
  dueDate        DateTime?
  items          Json
  subtotal       Float
  taxRate        Float?        @default(0)
  taxAmount      Float?        @default(0)
  discountAmount Float?        @default(0)
  totalAmount    Float
  paidAmount     Float         @default(0)
  currency       String        @default("USD")
  paymentTerms   String?
  notes          String?
  dealId         String?
  leadId         String?
  pdfUrl         String?
  publicUrl      String?
  lastViewedAt   DateTime?
  sentAt         DateTime?
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deal           Deal?         @relation(fields: [dealId], references: [id])
  lead           Lead?         @relation(fields: [leadId], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments       Payment[]

  @@index([userId])
  @@index([status])
}

model BookingWidgetSettings {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  primaryColor           String   @default("#3b82f6")
  logo                   String?
  businessName           String
  businessDescription    String?
  requireEmail           Boolean  @default(true)
  requirePhone           Boolean  @default(true)
  showAvailability       Boolean  @default(true)
  timeSlotInterval       Int      @default(30)
  timezone               String   @default("America/New_York")
  availabilityHours      Json?
  sendConfirmationEmail  Boolean  @default(true)
  sendReminderEmail      Boolean  @default(true)
  reminderHoursBefore    Int?     @default(24)
  acceptPayments         Boolean  @default(false)
  defaultPaymentProvider String?
  customCss              String?
  customMessages         Json?
  embedCode              String?
  publicUrl              String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id           String        @id @default(cuid())
  userId       String?
  action       AuditAction
  severity     AuditSeverity @default(LOW)
  entityType   String
  entityId     String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  success      Boolean       @default(true)
  errorMessage String?
  createdAt    DateTime      @default(now())
  user         User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([entityType])
  @@index([createdAt])
}

model VoiceUsage {
  id               String      @id @default(cuid())
  userId           String
  voiceAgentId     String?
  callLogId        String?     @unique
  durationSeconds  Int
  elevenLabsCallId String?
  costUSD          Float       @default(0.0)
  minutesUsed      Float       @default(0.0)
  billingStatus    String      @default("PENDING")
  billedAt         DateTime?
  billingPeriod    String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  callLog          CallLog?    @relation(fields: [callLogId], references: [id])
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceAgent       VoiceAgent? @relation(fields: [voiceAgentId], references: [id])

  @@index([userId])
  @@index([voiceAgentId])
  @@index([billingStatus])
  @@index([billingPeriod])
  @@index([createdAt])
}

model UserSubscription {
  id                    String           @id @default(cuid())
  userId                String           @unique
  status                String           @default("ACTIVE")
  monthlyMinutes        Int              @default(100)
  minutesUsed           Float            @default(0.0)
  overage               Float            @default(0.0)
  basePriceUSD          Float            @default(0.00)
  perMinutePriceUSD     Float            @default(0.15)
  stripeCustomerId      String?          @unique
  stripeSubscriptionId  String?          @unique
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  lastResetAt           DateTime         @default(now())
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  cancelAt              DateTime?
  cancelAtPeriodEnd     Boolean          @default(false)
  canceledAt            DateTime?
  lastPaymentError      String?
  lastPaymentStatus     String?
  nextPaymentAttempt    DateTime?
  stripePaymentMethodId String?
  stripePriceId         String?
  tier                  SubscriptionTier @default(PRO)
  totalChargesUSD       Float            @default(0.00)
  trialEnd              DateTime?
  trialStart            DateTime?
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([tier])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model SoshoglePaymentCustomer {
  id                     String                   @id @default(cuid())
  userId                 String                   @unique
  soshogleCustomerId     String?                  @unique
  email                  String
  phone                  String?
  defaultPaymentMethodId String?
  metadata               Json                     @default("{}")
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  fraudDetections        SoshoglefraudDetection[]
  loyaltyPoints          SoshogleLoyaltyPoints[]
  user                   User                     @relation("SoshoglePaymentCustomer", fields: [userId], references: [id], onDelete: Cascade)
  paymentIntents         SoshoglePaymentIntent[]
  paymentMethods         SoshoglePaymentMethod[]
  transactions           SoshogleTransaction[]
  trustScores            SoshogleTrustScore[]
  wallet                 SoshogleWallet?

  @@index([soshogleCustomerId])
  @@index([email])
  @@map("soshogle_payment_customers")
}

model SoshoglePaymentMerchant {
  id                  String                 @id @default(cuid())
  userId              String                 @unique
  soshogleMerchantId  String?                @unique
  businessName        String
  businessType        String?
  country             String?
  currency            String                 @default("USD")
  accountStatus       SoshogleMerchantStatus @default(PENDING)
  metadata            Json                   @default("{}")
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  cashReconciliations CashReconciliation[]
  cashTransactions    CashTransaction[]
  user                User                   @relation("SoshoglePaymentMerchant", fields: [userId], references: [id], onDelete: Cascade)

  @@index([soshogleMerchantId])
  @@map("soshogle_payment_merchants")
}

model SoshoglePaymentMethod {
  id               String                  @id @default(cuid())
  customerId       String
  soshogleMethodId String?                 @unique
  type             SoshogleMethodType
  last4            String?
  brand            String?
  expiryMonth      Int?
  expiryYear       Int?
  isDefault        Boolean                 @default(false)
  isActive         Boolean                 @default(true)
  metadata         Json                    @default("{}")
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  customer         SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([soshogleMethodId])
  @@map("soshogle_payment_methods")
}

model SoshoglePaymentIntent {
  id               String                  @id @default(cuid())
  customerId       String
  soshogleIntentId String?                 @unique
  amount           Int
  currency         String                  @default("USD")
  status           SoshogleIntentStatus    @default(PENDING)
  paymentMethodId  String?
  description      String?
  captureMethod    String                  @default("automatic")
  clientSecret     String?
  errorMessage     String?
  metadata         Json                    @default("{}")
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  processedAt      DateTime?
  canceledAt       DateTime?
  disputes         SoshogleDispute[]
  customer         SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions     SoshogleTransaction[]

  @@index([customerId])
  @@index([soshogleIntentId])
  @@index([status])
  @@map("soshogle_payment_intents")
}

model SoshogleTransaction {
  id              String                  @id @default(cuid())
  paymentIntentId String
  customerId      String
  amount          Int
  currency        String                  @default("USD")
  status          String
  type            String
  processedAt     DateTime?
  metadata        Json                    @default("{}")
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  fraudAlerts     FraudAlert[]
  customer        SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentIntent   SoshoglePaymentIntent   @relation(fields: [paymentIntentId], references: [id], onDelete: Cascade)

  @@index([paymentIntentId])
  @@index([customerId])
  @@index([status])
  @@map("soshogle_transactions")
}

model SoshogleWallet {
  id                String                      @id @default(cuid())
  customerId        String                      @unique
  balance           Float                       @default(0)
  currency          String                      @default("USD")
  isActive          Boolean                     @default(true)
  lastTransactionAt DateTime?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  transactions      SoshogleWalletTransaction[]
  customer          SoshoglePaymentCustomer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("soshogle_wallets")
}

model SoshogleWalletTransaction {
  id            String         @id @default(cuid())
  walletId      String
  amount        Float
  type          String
  balanceBefore Float
  balanceAfter  Float
  description   String?
  metadata      Json           @default("{}")
  createdAt     DateTime       @default(now())
  wallet        SoshogleWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@map("soshogle_wallet_transactions")
}

model SoshogleLoyaltyProgram {
  id          String                  @id @default(cuid())
  name        String
  description String?
  pointsRatio Float                   @default(1)
  isActive    Boolean                 @default(true)
  benefits    String?
  metadata    Json                    @default("{}")
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  points      SoshogleLoyaltyPoints[]

  @@map("soshogle_loyalty_programs")
}

model SoshogleLoyaltyPoints {
  id             String                  @id @default(cuid())
  customerId     String
  programId      String
  points         Int                     @default(0)
  tier           SoshogleLoyaltyTier     @default(BRONZE)
  lastEarnedAt   DateTime?
  lastRedeemedAt DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  customer       SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  program        SoshogleLoyaltyProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([customerId, programId])
  @@index([customerId])
  @@index([programId])
  @@map("soshogle_loyalty_points")
}

model SoshogleFinancingPlan {
  id           String                     @id @default(cuid())
  name         String
  description  String?
  interestRate Float
  termMonths   Int
  minAmount    Int
  maxAmount    Int
  isActive     Boolean                    @default(true)
  metadata     Json                       @default("{}")
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  payments     SoshogleFinancingPayment[]

  @@map("soshogle_financing_plans")
}

model SoshogleFinancingPayment {
  id                String                  @id @default(cuid())
  planId            String
  customerId        String
  principalAmount   Int
  interestAmount    Int
  installmentAmount Int
  installmentsDue   Int
  installmentsPaid  Int
  status            SoshogleFinancingStatus @default(ACTIVE)
  nextDueDate       DateTime?
  metadata          Json                    @default("{}")
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  plan              SoshogleFinancingPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([customerId])
  @@index([status])
  @@map("soshogle_financing_payments")
}

model SoshogleDispute {
  id                String                @id @default(cuid())
  soshogleDisputeId String?               @unique
  paymentIntentId   String
  amount            Int
  currency          String                @default("USD")
  reason            String
  status            SoshogleDisputeStatus @default(NEEDS_RESPONSE)
  evidence          Json                  @default("{}")
  metadata          Json                  @default("{}")
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  resolvedAt        DateTime?
  paymentIntent     SoshoglePaymentIntent @relation(fields: [paymentIntentId], references: [id], onDelete: Cascade)

  @@index([paymentIntentId])
  @@index([status])
  @@map("soshogle_disputes")
}

model SoshogleWebhook {
  id           String   @id @default(cuid())
  eventId      String   @unique
  eventType    String
  payload      Json
  status       String
  errorMessage String?
  processedAt  DateTime
  createdAt    DateTime @default(now())

  @@index([eventType])
  @@index([status])
  @@map("soshogle_webhooks")
}

model SoshogleTrustScore {
  id          String                  @id @default(cuid())
  customerId  String
  score       Int                     @default(50)
  factors     Json                    @default("{}")
  lastUpdated DateTime                @default(now())
  createdAt   DateTime                @default(now())
  customer    SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("soshogle_trust_scores")
}

model SoshoglefraudDetection {
  id         String                  @id @default(cuid())
  customerId String
  riskScore  Float
  riskLevel  String
  isBlocked  Boolean                 @default(false)
  reason     String?
  metadata   Json                    @default("{}")
  createdAt  DateTime                @default(now())
  customer   SoshoglePaymentCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([riskLevel])
  @@map("soshogle_fraud_detections")
}

model Product {
  id              String           @id @default(cuid())
  userId          String
  name            String
  description     String?
  price           Int
  compareAtPrice  Int?
  sku             String           @unique
  inventory       Int              @default(0)
  categoryId      String?
  imageUrl        String?
  images          String[]
  active          Boolean          @default(true)
  featured        Boolean          @default(false)
  weight          Float?
  dimensions      String?
  tags            String[]
  metaTitle       String?
  metaDescription String?
  productType     String           @default("PHYSICAL") // PHYSICAL, DIGITAL
  downloadUrl     String?          // For digital: file URL
  accessCodeTemplate String?       // For digital: e.g. "COURSE-{code}" - codes stored in ProductAccessCode
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  orders          OrderItem[]
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  websiteProducts WebsiteProduct[]
  accessCodes     ProductAccessCode[]

  @@index([userId])
  @@index([categoryId])
  @@index([active])
  @@index([productType])
}

model ProductAccessCode {
  id          String   @id @default(cuid())
  productId   String
  code        String   @unique
  orderId     String?
  redeemedAt  DateTime?
  createdAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([code])
}

model ProductCategory {
  id          String            @id @default(cuid())
  userId      String
  name        String
  description String?
  slug        String            @unique
  parentId    String?
  active      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  products    Product[]
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
}

model Storefront {
  id               String            @id @default(cuid())
  userId           String            @unique
  storeName        String
  domain           String?           @unique
  subdomain        String?           @unique
  logoUrl          String?
  bannerUrl        String?
  faviconUrl       String?
  primaryColor     String            @default("#8b5cf6")
  secondaryColor   String            @default("#ffffff")
  accentColor      String            @default("#ec4899")
  description      String?
  aboutPage        String?
  shippingPolicy   String?
  returnPolicy     String?
  privacyPolicy    String?
  termsOfService   String?
  socialMedia      Json?
  contactEmail     String?
  contactPhone     String?
  active           Boolean           @default(false)
  published        Boolean           @default(false)
  publishedAt      DateTime?
  customCSS        String?
  customJS         String?
  metaTags         Json?
  analyticsId      String?
  facebookPixel    String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ecommerceWidgets EcommerceWidget[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([domain])
  @@index([subdomain])
}

model Order {
  id                   String         @id @default(cuid())
  userId               String
  orderNumber          String         @unique
  customerName         String
  customerEmail        String
  customerPhone        String?
  shippingAddress      Json?
  billingAddress       Json?
  status               OrderStatus    @default(PENDING)
  paymentStatus        PaymentStatus  @default(PENDING)
  paymentMethod        String?
  subtotal             Int
  tax                  Int            @default(0)
  shipping             Int            @default(0)
  discount             Int            @default(0)
  total                Int
  notes                String?
  trackingNumber       String?
  trackingUrl          String?
  fulfilledAt          DateTime?
  canceledAt           DateTime?
  cancelReason         String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                OrderItem[]
  reservationPreOrders Reservation[]
  websiteOrders        WebsiteOrder[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([customerEmail])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productName String
  productSku  String
  quantity    Int
  price       Int
  total       Int
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model CreditScore {
  id                String              @id @default(cuid())
  userId            String              @unique
  score             Int
  scoreDate         DateTime            @default(now())
  trustScore        Int?
  trustScoreDate    DateTime?
  riskLevel         RiskLevel           @default(MEDIUM)
  creditLimit       Int                 @default(0)
  availableCredit   Int                 @default(0)
  paymentHistory    Int?
  creditUtilization Float?
  creditAge         Int?
  accountMix        String?
  recentInquiries   Int?
  experianScore     Int?
  equifaxScore      Int?
  transUnionScore   Int?
  insights          Json?
  recommendations   String[]
  lastUpdated       DateTime            @updatedAt
  nextReviewDate    DateTime?
  frozen            Boolean             @default(false)
  createdAt         DateTime            @default(now())
  applications      CreditApplication[]
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([riskLevel])
  @@index([score])
}

model CreditApplication {
  id               String            @id @default(cuid())
  userId           String
  creditScoreId    String?
  applicationType  ApplicationType   @default(CREDIT_INCREASE)
  requestedAmount  Int
  purpose          String?
  status           ApplicationStatus @default(PENDING)
  decision         String?
  decisionDate     DateTime?
  approvedAmount   Int?
  denialReason     String?
  annualIncome     Int?
  employmentStatus String?
  employerName     String?
  housingStatus    String?
  monthlyRent      Int?
  reviewedBy       String?
  reviewNotes      String?
  riskAssessment   Json?
  submittedAt      DateTime          @default(now())
  completedAt      DateTime?
  expiresAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  creditScore      CreditScore?      @relation(fields: [creditScoreId], references: [id])
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([creditScoreId])
  @@index([status])
}

model AchSettlement {
  id               String                     @id @default(cuid())
  userId           String
  batchId          String                     @unique
  settlementDate   DateTime
  status           AchSettlementStatus        @default(PENDING)
  totalAmount      Int
  transactionCount Int
  successCount     Int                        @default(0)
  failedCount      Int                        @default(0)
  processingFee    Int                        @default(0)
  netAmount        Int
  bankName         String?
  accountLast4     String?
  routingNumber    String?
  initiatedAt      DateTime                   @default(now())
  processedAt      DateTime?
  completedAt      DateTime?
  failureReason    String?
  notes            String?
  metadata         Json?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  user             User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions     AchSettlementTransaction[]

  @@index([userId])
  @@index([status])
  @@index([settlementDate])
  @@index([batchId])
}

model AchSettlementTransaction {
  id               String              @id @default(cuid())
  settlementId     String
  transactionType  AchTransactionType
  amount           Int
  status           AchSettlementStatus @default(PENDING)
  recipientName    String
  recipientAccount String?
  recipientEmail   String?
  description      String?
  referenceNumber  String?
  traceNumber      String?
  processedAt      DateTime?
  failureReason    String?
  retryCount       Int                 @default(0)
  metadata         Json?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  settlement       AchSettlement       @relation(fields: [settlementId], references: [id], onDelete: Cascade)

  @@index([settlementId])
  @@index([status])
  @@index([transactionType])
}

model BnplApplication {
  id                 String            @id @default(cuid())
  userId             String
  purchaseAmount     Int
  downPayment        Int               @default(0)
  financedAmount     Int
  status             BnplStatus        @default(PENDING)
  installmentCount   Int
  installmentAmount  Int
  interestRate       Float             @default(0)
  totalInterest      Int               @default(0)
  totalRepayment     Int
  creditCheckScore   Int?
  riskLevel          RiskLevel         @default(MEDIUM)
  creditCheckDate    DateTime?
  approvedAt         DateTime?
  approvedBy         String?
  denialReason       String?
  merchantName       String?
  merchantId         String?
  productDescription String?
  orderId            String?
  firstPaymentDate   DateTime?
  lastPaymentDate    DateTime?
  nextPaymentDate    DateTime?
  paidInstallments   Int               @default(0)
  remainingBalance   Int
  totalPaid          Int               @default(0)
  missedPayments     Int               @default(0)
  lateFeeAmount      Int               @default(0)
  totalLateFees      Int               @default(0)
  notes              String?
  metadata           Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  completedAt        DateTime?
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  installments       BnplInstallment[]

  @@index([userId])
  @@index([status])
  @@index([nextPaymentDate])
  @@index([riskLevel])
}

model BnplInstallment {
  id                String                @id @default(cuid())
  bnplApplicationId String
  installmentNumber Int
  dueDate           DateTime
  amount            Int
  status            BnplInstallmentStatus @default(SCHEDULED)
  paidAmount        Int                   @default(0)
  paidDate          DateTime?
  paymentMethod     String?
  transactionId     String?
  lateFee           Int                   @default(0)
  gracePeriodEnd    DateTime?
  overdueDate       DateTime?
  reminderSentAt    DateTime?
  reminderCount     Int                   @default(0)
  notes             String?
  metadata          Json?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  bnplApplication   BnplApplication       @relation(fields: [bnplApplicationId], references: [id], onDelete: Cascade)

  @@unique([bnplApplicationId, installmentNumber])
  @@index([bnplApplicationId])
  @@index([status])
  @@index([dueDate])
}

model DataInsight {
  id                    String        @id @default(cuid())
  userId                String
  insightType           InsightType
  period                InsightPeriod
  startDate             DateTime
  endDate               DateTime
  totalTransactions     Int           @default(0)
  totalRevenue          Int           @default(0)
  averageOrderValue     Int           @default(0)
  uniqueCustomers       Int           @default(0)
  cardPayments          Int           @default(0)
  walletPayments        Int           @default(0)
  bnplPayments          Int           @default(0)
  achPayments           Int           @default(0)
  successRate           Float         @default(0)
  fraudRate             Float         @default(0)
  averageProcessingTime Int           @default(0)
  growthRate            Float         @default(0)
  trendData             Json?
  dataPoints            Int           @default(0)
  confidenceScore       Float         @default(0)
  notes                 String?
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([insightType])
  @@index([period])
  @@index([startDate, endDate])
}

model DataExport {
  id                  String           @id @default(cuid())
  userId              String
  exportType          String
  format              DataExportFormat
  status              DataExportStatus @default(PENDING)
  startDate           DateTime
  endDate             DateTime
  includeFields       String[]
  excludeFields       String[]
  filters             Json?
  recordCount         Int              @default(0)
  fileSize            Int              @default(0)
  downloadUrl         String?
  expiresAt           DateTime?
  processingStartedAt DateTime?
  completedAt         DateTime?
  failureReason       String?
  anonymized          Boolean          @default(false)
  ipAddress           String?
  userAgent           String?
  notes               String?
  metadata            Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([exportType])
  @@index([createdAt])
}

model WidgetConfiguration {
  id               String        @id @default(cuid())
  userId           String
  name             String
  description      String?
  isActive         Boolean       @default(true)
  layout           WidgetLayout  @default(GRID)
  theme            WidgetTheme   @default(LIGHT)
  primaryColor     String        @default("#3b82f6")
  secondaryColor   String        @default("#6b7280")
  fontFamily       String        @default("system-ui")
  showPrices       Boolean       @default(true)
  showImages       Boolean       @default(true)
  showDescription  Boolean       @default(true)
  showAddToCart    Boolean       @default(true)
  showQuickView    Boolean       @default(false)
  featuredProducts String[]
  maxProducts      Int           @default(12)
  sortBy           String        @default("createdAt")
  sortOrder        String        @default("desc")
  categoryFilter   String[]
  showCategories   Boolean       @default(true)
  customCss        String?
  customJs         String?
  headerText       String?
  footerText       String?
  callToAction     String        @default("Shop Now")
  embedCode        String
  apiKey           String        @unique @default(cuid())
  impressions      Int           @default(0)
  clicks           Int           @default(0)
  conversions      Int           @default(0)
  metadata         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  embeds           WidgetEmbed[]

  @@index([userId])
  @@index([isActive])
  @@index([apiKey])
}

model WidgetEmbed {
  id                 String              @id @default(cuid())
  widgetConfigId     String
  userId             String
  domain             String
  pageUrl            String
  pageTitle          String?
  impressions        Int                 @default(0)
  uniqueVisitors     Int                 @default(0)
  clicks             Int                 @default(0)
  addToCartClicks    Int                 @default(0)
  purchases          Int                 @default(0)
  revenue            Int                 @default(0)
  lastActiveAt       DateTime            @default(now())
  averageSessionTime Int                 @default(0)
  bounceRate         Float               @default(0)
  userAgent          String?
  referrer           String?
  deviceType         String?
  browserName        String?
  loadTime           Int                 @default(0)
  errorCount         Int                 @default(0)
  lastError          String?
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgetConfig       WidgetConfiguration @relation(fields: [widgetConfigId], references: [id], onDelete: Cascade)

  @@index([widgetConfigId])
  @@index([userId])
  @@index([domain])
  @@index([lastActiveAt])
}

model CashTransaction {
  id               String                   @id @default(cuid())
  userId           String
  merchantId       String?
  type             CashTransactionType      @default(SALE)
  amount           Int
  customerName     String?
  customerPhone    String?
  customerEmail    String?
  transactionDate  DateTime                 @default(now())
  notes            String?
  receiptNumber    String?                  @unique
  reconciliationId String?
  isReconciled     Boolean                  @default(false)
  createdBy        String
  updatedBy        String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  deletedAt        DateTime?
  metadata         Json?
  merchant         SoshoglePaymentMerchant? @relation(fields: [merchantId], references: [id])
  reconciliation   CashReconciliation?      @relation(fields: [reconciliationId], references: [id])
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([merchantId])
  @@index([reconciliationId])
  @@index([transactionDate])
  @@index([receiptNumber])
}

model CashReconciliation {
  id                 String                   @id @default(cuid())
  userId             String
  merchantId         String?
  reconciliationDate DateTime                 @default(now())
  startDate          DateTime
  endDate            DateTime
  startingCash       Int                      @default(0)
  expectedCash       Int                      @default(0)
  actualCash         Int                      @default(0)
  discrepancy        Int                      @default(0)
  totalSales         Int                      @default(0)
  totalRefunds       Int                      @default(0)
  totalExpenses      Int                      @default(0)
  totalAdjustments   Int                      @default(0)
  transactionCount   Int                      @default(0)
  notes              String?
  status             String                   @default("PENDING")
  reviewedBy         String?
  reviewedAt         DateTime?
  createdBy          String
  updatedBy          String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  metadata           Json?
  merchant           SoshoglePaymentMerchant? @relation(fields: [merchantId], references: [id])
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       CashTransaction[]

  @@index([userId])
  @@index([merchantId])
  @@index([reconciliationDate])
  @@index([status])
}

model DataMonetizationConsent {
  id                     String            @id @default(cuid())
  userId                 String
  status                 DataConsentStatus @default(PENDING)
  sharingLevel           DataSharingLevel  @default(NONE)
  consentedAt            DateTime?
  revokedAt              DateTime?
  expiresAt              DateTime?
  allowTransactionData   Boolean           @default(false)
  allowBehaviorData      Boolean           @default(false)
  allowDemographicData   Boolean           @default(false)
  allowLocationData      Boolean           @default(false)
  revenueShareEnabled    Boolean           @default(false)
  revenueSharePercentage Int               @default(0)
  ipAddress              String?
  userAgent              String?
  consentVersion         String            @default("1.0")
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  user                   User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model DataMonetizationInsight {
  id               String   @id @default(cuid())
  userId           String
  insightType      String
  category         String?
  title            String
  description      String
  dataPoints       Json
  timeRange        String
  confidence       Float    @default(0.0)
  accessCount      Int      @default(0)
  revenueGenerated Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([insightType])
  @@index([createdAt])
}

model DataMonetizationRevenue {
  id              String    @id @default(cuid())
  userId          String
  period          String
  amount          Int       @default(0)
  dataAccessCount Int       @default(0)
  transactionData Int       @default(0)
  behaviorData    Int       @default(0)
  demographicData Int       @default(0)
  locationData    Int       @default(0)
  status          String    @default("PENDING")
  paidAt          DateTime?
  paymentMethod   String?
  transactionId   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([period])
  @@index([status])
}

model EcommerceWidget {
  id              String            @id @default(cuid())
  userId          String
  storefrontId    String?
  name            String
  description     String?
  isActive        Boolean           @default(true)
  theme           WidgetTheme       @default(LIGHT)
  layout          WidgetLayout      @default(GRID)
  primaryColor    String            @default("#3b82f6")
  accentColor     String            @default("#10b981")
  borderRadius    Int               @default(8)
  productIds      String[]
  categoryFilter  String?
  maxProducts     Int               @default(12)
  showOutOfStock  Boolean           @default(false)
  showPrices      Boolean           @default(true)
  showAddToCart   Boolean           @default(true)
  showQuickView   Boolean           @default(true)
  showSearch      Boolean           @default(true)
  enableCheckout  Boolean           @default(true)
  checkoutUrl     String?
  impressions     Int               @default(0)
  clicks          Int               @default(0)
  conversions     Int               @default(0)
  allowedDomains  String[]
  apiKey          String            @unique @default(cuid())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  storefront      Storefront?       @relation(fields: [storefrontId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgetAnalytics WidgetAnalytics[]

  @@index([userId])
  @@index([storefrontId])
  @@index([isActive])
}

model WidgetAnalytics {
  id              String          @id @default(cuid())
  widgetId        String
  eventType       String
  productId       String?
  sessionId       String?
  domain          String?
  referrer        String?
  userAgent       String?
  deviceType      String?
  conversionValue Int?
  timestamp       DateTime        @default(now())
  widget          EcommerceWidget @relation(fields: [widgetId], references: [id], onDelete: Cascade)

  @@index([widgetId])
  @@index([eventType])
  @@index([timestamp])
}

model FraudAlert {
  id                 String               @id @default(cuid())
  userId             String
  transactionId      String?
  alertType          String
  riskLevel          FraudRiskLevel
  riskScore          Float
  detectedAt         DateTime             @default(now())
  detectionRules     String[]
  reason             String
  status             FraudReviewStatus    @default(PENDING)
  reviewedBy         String?
  reviewedAt         DateTime?
  reviewNotes        String?
  actionTaken        String?
  notificationSent   Boolean              @default(false)
  isFalsePositive    Boolean              @default(false)
  falsePositiveNotes String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  transaction        SoshogleTransaction? @relation(fields: [transactionId], references: [id])
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([transactionId])
  @@index([riskLevel])
  @@index([status])
  @@index([detectedAt])
}

model FraudPattern {
  id                String         @id @default(cuid())
  patternType       String
  patternName       String
  description       String
  criteria          Json
  threshold         Float          @default(0.7)
  isActive          Boolean        @default(true)
  detectionCount    Int            @default(0)
  falsePositiveRate Float          @default(0.0)
  severity          FraudRiskLevel
  recommendedAction String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([patternType])
  @@index([isActive])
}

model RestaurantTable {
  id           String        @id @default(cuid())
  userId       String
  tableName    String
  capacity     Int
  minCapacity  Int?
  maxCapacity  Int?
  section      String?
  position     Json?
  isActive     Boolean       @default(true)
  isPremium    Boolean       @default(false)
  features     String[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  reservations Reservation[]
  user         User          @relation("RestaurantTables", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
}

model TableLayout {
  id            String   @id @default(cuid())
  userId        String
  name          String
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)
  layout        Json
  sections      Json?
  availableFrom String?
  availableTo   String?
  daysOfWeek    Int[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation("TableLayouts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
}

model Reservation {
  id                  String                @id @default(cuid())
  userId              String
  customerId          String?
  reservationDate     DateTime
  reservationTime     String
  partySize           Int
  duration            Int                   @default(120)
  tableId             String?
  section             String?
  status              ReservationStatus     @default(PENDING)
  confirmationCode    String                @unique
  customerName        String
  customerEmail       String?
  customerPhone       String
  specialRequests     String?
  dietaryRestrictions String?
  occasion            String?
  hasPreOrder         Boolean               @default(false)
  preOrderId          String?
  requiresDeposit     Boolean               @default(false)
  depositAmount       Decimal?              @db.Decimal(10, 2)
  depositPaid         Boolean               @default(false)
  paymentIntentId     String?
  reminderSent        Boolean               @default(false)
  reminderSentAt      DateTime?
  source              String                @default("website")
  voiceCallId         String?
  internalNotes       String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  customer            User?                 @relation("CustomerReservations", fields: [customerId], references: [id])
  preOrder            Order?                @relation(fields: [preOrderId], references: [id])
  table               RestaurantTable?      @relation(fields: [tableId], references: [id])
  user                User                  @relation("UserReservations", fields: [userId], references: [id], onDelete: Cascade)
  activities          ReservationActivity[]
  reminders           ReservationReminder[]
  preferences         SeatingPreference[]

  @@index([userId])
  @@index([customerId])
  @@index([userId, reservationDate])
  @@index([userId, status])
  @@index([confirmationCode])
}

model ReservationActivity {
  id            String                  @id @default(cuid())
  reservationId String
  type          ReservationActivityType
  description   String
  performedBy   String?
  metadata      Json?
  createdAt     DateTime                @default(now())
  reservation   Reservation             @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([reservationId, createdAt])
}

model ReservationReminder {
  id            String          @id @default(cuid())
  reservationId String
  channel       ReminderChannel
  scheduledFor  DateTime
  status        ReminderStatus  @default(PENDING)
  subject       String?
  message       String
  sentAt        DateTime?
  failureReason String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  reservation   Reservation     @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([status, scheduledFor])
}

model SeatingPreference {
  id                String       @id @default(cuid())
  customerId        String
  preferredSection  String?
  preferredFeatures String[]
  avoidances        String[]
  notes             String?
  reservationId     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  customer          User         @relation("CustomerSeatingPreferences", fields: [customerId], references: [id], onDelete: Cascade)
  reservation       Reservation? @relation(fields: [reservationId], references: [id])

  @@index([customerId])
}

model ReservationSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  acceptReservations    Boolean  @default(true)
  minAdvanceHours       Int      @default(2)
  maxAdvanceDays        Int      @default(90)
  slotDuration          Int      @default(30)
  bufferBetweenSlots    Int      @default(15)
  operatingHours        Json
  requireDeposit        Boolean  @default(false)
  depositAmount         Decimal? @db.Decimal(10, 2)
  depositMinPartySize   Int?
  cancellationPolicy    String?
  cancellationHours     Int      @default(24)
  sendReminders         Boolean  @default(true)
  reminderHoursBefore   Int      @default(24)
  reminderChannels      String[] @default(["email", "sms"])
  maxPartySizeOnline    Int      @default(8)
  allowOverbooking      Boolean  @default(false)
  overbookingPercentage Int?
  allowPreOrders        Boolean  @default(false)
  preOrderDeadlineHours Int?
  enableVoiceBooking    Boolean  @default(true)
  voiceAgentId          String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation("ReservationSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DeliveryOrder {
  id                    String           @id @default(cuid())
  userId                String
  driverId              String?
  orderNumber           String?
  orderValue            Decimal          @db.Decimal(10, 2)
  pickupAddress         String
  deliveryAddress       String
  pickupLat             Decimal?         @db.Decimal(10, 8)
  pickupLng             Decimal?         @db.Decimal(11, 8)
  deliveryLat           Decimal?         @db.Decimal(10, 8)
  deliveryLng           Decimal?         @db.Decimal(11, 8)
  distanceKm            Decimal?         @db.Decimal(5, 2)
  estimatedDurationMin  Int?
  status                DeliveryStatus   @default(PENDING)
  scheduledPickupTime   DateTime?
  actualPickupTime      DateTime?
  estimatedDeliveryTime DateTime?
  actualDeliveryTime    DateTime?
  deliveryInstructions  String?
  customerName          String
  customerPhone         String
  customerEmail         String?
  deliveryFee           Decimal          @db.Decimal(10, 2)
  commissionRate        Decimal          @default(27.5) @db.Decimal(5, 2)
  commissionAmount      Decimal?         @db.Decimal(10, 2)
  driverEarnings        Decimal?         @db.Decimal(10, 2)
  trackingCode          String           @unique @default(cuid())
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  driver                Driver?          @relation("DriverDeliveryOrders", fields: [driverId], references: [id])
  user                  User             @relation("UserDeliveryOrders", fields: [userId], references: [id], onDelete: Cascade)
  ratings               DeliveryRating[]
  locations             DriverLocation[]

  @@index([userId])
  @@index([driverId])
  @@index([status])
  @@index([trackingCode])
  @@index([createdAt])
}

model Driver {
  id              String           @id @default(cuid())
  userId          String?          @unique
  name            String
  phone           String           @unique
  email           String?
  photoUrl        String?
  vehicleType     VehicleType      @default(CAR)
  licensePlate    String?
  vehicleColor    String?
  vehicleModel    String?
  status          DriverStatus     @default(OFFLINE)
  isAvailable     Boolean          @default(false)
  isActive        Boolean          @default(true)
  rating          Decimal          @default(5.0) @db.Decimal(3, 2)
  totalDeliveries Int              @default(0)
  totalEarnings   Decimal          @default(0) @db.Decimal(10, 2)
  pendingEarnings Decimal          @default(0) @db.Decimal(10, 2)
  licenseUrl      String?
  insuranceUrl    String?
  vehicleRegUrl   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deliveryOrders  DeliveryOrder[]  @relation("DriverDeliveryOrders")
  ratings         DeliveryRating[]
  user            User?            @relation("UserDriver", fields: [userId], references: [id])
  earnings        DriverEarning[]
  locations       DriverLocation[]
  zones           DriverZone[]

  @@index([userId])
  @@index([phone])
  @@index([status])
  @@index([isAvailable])
}

model DriverLocation {
  id              String         @id @default(cuid())
  driverId        String
  deliveryOrderId String?
  lat             Decimal        @db.Decimal(10, 8)
  lng             Decimal        @db.Decimal(11, 8)
  heading         Decimal?       @db.Decimal(5, 2)
  speed           Decimal?       @db.Decimal(5, 2)
  accuracy        Decimal?       @db.Decimal(5, 2)
  createdAt       DateTime       @default(now())
  deliveryOrder   DeliveryOrder? @relation(fields: [deliveryOrderId], references: [id])
  driver          Driver         @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([deliveryOrderId])
  @@index([createdAt])
}

model DeliveryZone {
  id               String       @id @default(cuid())
  userId           String
  name             String
  description      String?
  polygon          Json
  deliveryFee      Decimal      @default(0) @db.Decimal(10, 2)
  minimumOrder     Decimal      @default(0) @db.Decimal(10, 2)
  estimatedTimeMin Int          @default(30)
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  user             User         @relation("UserDeliveryZones", fields: [userId], references: [id], onDelete: Cascade)
  drivers          DriverZone[]

  @@index([userId])
  @@index([isActive])
}

model DriverZone {
  id        String       @id @default(cuid())
  driverId  String
  zoneId    String
  createdAt DateTime     @default(now())
  driver    Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  zone      DeliveryZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([driverId, zoneId])
  @@index([driverId])
  @@index([zoneId])
}

model DeliveryRating {
  id              String        @id @default(cuid())
  deliveryOrderId String
  driverId        String
  userId          String
  rating          Int
  comment         String?
  speedRating     Int?
  qualityRating   Int?
  serviceRating   Int?
  createdAt       DateTime      @default(now())
  deliveryOrder   DeliveryOrder @relation(fields: [deliveryOrderId], references: [id], onDelete: Cascade)
  driver          Driver        @relation(fields: [driverId], references: [id])
  user            User          @relation("UserDeliveryRatings", fields: [userId], references: [id])

  @@index([deliveryOrderId])
  @@index([driverId])
  @@index([userId])
}

model DriverEarning {
  id          String    @id @default(cuid())
  driverId    String
  amount      Decimal   @db.Decimal(10, 2)
  description String
  type        String
  isPaid      Boolean   @default(false)
  paidAt      DateTime?
  payoutId    String?
  referenceId String?
  createdAt   DateTime  @default(now())
  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([isPaid])
  @@index([createdAt])
}

model Staff {
  id               String     @id @default(cuid())
  userId           String
  employeeId       String     @unique
  pin              String
  role             StaffRole  @default(CASHIER)
  isActive         Boolean    @default(true)
  hireDate         DateTime   @default(now())
  terminationDate  DateTime?
  canVoidOrders    Boolean    @default(false)
  canGiveDiscounts Boolean    @default(false)
  canAccessReports Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  orders           POSOrder[]
  shifts           Shift[]
  user             User       @relation("UserStaff", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeId])
}

model Shift {
  id             String      @id @default(cuid())
  staffId        String
  userId         String
  clockIn        DateTime
  clockOut       DateTime?
  status         ShiftStatus @default(ACTIVE)
  startingCash   Decimal     @db.Decimal(10, 2)
  endingCash     Decimal?    @db.Decimal(10, 2)
  expectedCash   Decimal?    @db.Decimal(10, 2)
  cashDifference Decimal?    @db.Decimal(10, 2)
  totalSales     Decimal     @default(0) @db.Decimal(10, 2)
  orderCount     Int         @default(0)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  staff          Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  user           User        @relation("UserShifts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([userId])
  @@index([status])
  @@index([clockIn])
}

model POSOrder {
  id            String             @id @default(cuid())
  userId        String
  staffId       String?
  orderNumber   String             @unique
  orderType     POSOrderType       @default(DINE_IN)
  status        POSOrderStatus     @default(PENDING)
  customerName  String?
  customerPhone String?
  customerEmail String?
  tableNumber   String?
  subtotal      Decimal            @db.Decimal(10, 2)
  tax           Decimal            @db.Decimal(10, 2)
  discount      Decimal            @default(0) @db.Decimal(10, 2)
  tip           Decimal            @default(0) @db.Decimal(10, 2)
  total         Decimal            @db.Decimal(10, 2)
  paymentMethod POSPaymentMethod?
  paymentStatus POSPaymentStatus   @default(UNPAID)
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  kitchenItems  KitchenOrderItem[] @relation("OrderKitchenItems")
  staff         Staff?             @relation(fields: [staffId], references: [id])
  user          User               @relation("UserPOSOrders", fields: [userId], references: [id], onDelete: Cascade)
  items         POSOrderItem[]
  receipts      Receipt[]

  @@index([userId])
  @@index([staffId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

model POSOrderItem {
  id              String            @id @default(cuid())
  orderId         String
  name            String
  sku             String?
  quantity        Int
  unitPrice       Decimal           @db.Decimal(10, 2)
  total           Decimal           @db.Decimal(10, 2)
  modifiers       String?
  notes           String?
  discount        Decimal           @default(0) @db.Decimal(10, 2)
  tax             Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  kitchenTracking KitchenOrderItem? @relation("ItemKitchenTracking")
  order           POSOrder          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Receipt {
  id            String      @id @default(cuid())
  userId        String
  orderId       String
  receiptNumber String      @unique
  receiptType   ReceiptType @default(SALE)
  content       String
  emailSentTo   String?
  emailSentAt   DateTime?
  printed       Boolean     @default(false)
  printedAt     DateTime?
  createdAt     DateTime    @default(now())
  order         POSOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user          User        @relation("UserReceipts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderId])
  @@index([receiptNumber])
}

model KitchenStation {
  id              String             @id @default(cuid())
  userId          String
  name            String
  displayName     String
  color           String?
  icon            String?
  isActive        Boolean            @default(true)
  priority        Int                @default(0)
  maxCapacity     Int?
  defaultPrepTime Int                @default(15)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  kitchenItems    KitchenOrderItem[] @relation("StationItems")
  user            User               @relation("UserKitchenStations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model KitchenOrderItem {
  id             String            @id @default(cuid())
  userId         String
  posOrderId     String
  posOrderItemId String            @unique
  stationId      String
  itemName       String
  quantity       Int
  modifiers      String?
  specialNotes   String?
  status         KitchenItemStatus @default(PENDING)
  priority       KitchenPriority   @default(NORMAL)
  receivedAt     DateTime          @default(now())
  startedAt      DateTime?
  completedAt    DateTime?
  expectedTime   Int
  alertAt        DateTime?
  assignedTo     String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  posOrder       POSOrder          @relation("OrderKitchenItems", fields: [posOrderId], references: [id], onDelete: Cascade)
  posOrderItem   POSOrderItem      @relation("ItemKitchenTracking", fields: [posOrderItemId], references: [id], onDelete: Cascade)
  station        KitchenStation    @relation("StationItems", fields: [stationId], references: [id])
  user           User              @relation("UserKitchenOrderItems", fields: [userId], references: [id], onDelete: Cascade)
  prepLogs       PrepLog[]         @relation("ItemPrepLogs")

  @@index([userId])
  @@index([posOrderId])
  @@index([stationId])
  @@index([status])
  @@index([priority])
  @@index([receivedAt])
}

model PrepLog {
  id             String             @id @default(cuid())
  kitchenItemId  String
  action         PrepAction
  previousStatus KitchenItemStatus?
  newStatus      KitchenItemStatus
  staffId        String?
  staffName      String?
  notes          String?
  timestamp      DateTime           @default(now())
  kitchenItem    KitchenOrderItem   @relation("ItemPrepLogs", fields: [kitchenItemId], references: [id], onDelete: Cascade)

  @@index([kitchenItemId])
  @@index([timestamp])
}

model InventoryItem {
  id                 String                @id @default(cuid())
  userId             String
  name               String
  sku                String                @unique
  description        String?
  category           InventoryCategory
  unit               InventoryUnit
  currentStock       Decimal               @db.Decimal(10, 2)
  minimumStock       Decimal               @db.Decimal(10, 2)
  maximumStock       Decimal?              @db.Decimal(10, 2)
  reorderQuantity    Decimal               @db.Decimal(10, 2)
  costPerUnit        Decimal               @db.Decimal(10, 2)
  sellingPrice       Decimal?              @db.Decimal(10, 2)
  supplierId         String?
  expirationDate     DateTime?
  location           String?
  barcode            String?
  trackExpiration    Boolean               @default(false)
  isActive           Boolean               @default(true)
  autoReorder        Boolean               @default(false)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  adjustments        InventoryAdjustment[] @relation("ItemAdjustments")
  supplier           Supplier?             @relation("SupplierItems", fields: [supplierId], references: [id])
  user               User                  @relation("UserInventoryItems", fields: [userId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]   @relation("ItemPurchaseOrders")
  recipeIngredients  RecipeIngredient[]    @relation("ItemRecipes")
  alerts             StockAlert[]          @relation("ItemAlerts")

  @@index([userId])
  @@index([category])
  @@index([currentStock])
  @@index([supplierId])
}

model Supplier {
  id             String          @id @default(cuid())
  userId         String
  name           String
  contactPerson  String?
  email          String?
  phone          String?
  address        String?
  taxId          String?
  paymentTerms   String?
  notes          String?
  isActive       Boolean         @default(true)
  rating         Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  items          InventoryItem[] @relation("SupplierItems")
  purchaseOrders PurchaseOrder[] @relation("SupplierOrders")
  user           User            @relation("UserSuppliers", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  userId        String
  orderNumber   String              @unique
  supplierId    String
  status        PurchaseOrderStatus @default(DRAFT)
  orderDate     DateTime            @default(now())
  expectedDate  DateTime?
  receivedDate  DateTime?
  subtotal      Decimal             @db.Decimal(10, 2)
  tax           Decimal             @default(0) @db.Decimal(10, 2)
  shipping      Decimal             @default(0) @db.Decimal(10, 2)
  total         Decimal             @db.Decimal(10, 2)
  paymentStatus POPaymentStatus     @default(UNPAID)
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  supplier      Supplier            @relation("SupplierOrders", fields: [supplierId], references: [id])
  user          User                @relation("UserPurchaseOrders", fields: [userId], references: [id], onDelete: Cascade)
  items         PurchaseOrderItem[] @relation("OrderItems")

  @@index([userId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  orderId          String
  inventoryItemId  String
  quantity         Decimal       @db.Decimal(10, 2)
  receivedQuantity Decimal       @default(0) @db.Decimal(10, 2)
  unitPrice        Decimal       @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(10, 2)
  createdAt        DateTime      @default(now())
  inventoryItem    InventoryItem @relation("ItemPurchaseOrders", fields: [inventoryItemId], references: [id])
  order            PurchaseOrder @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([inventoryItemId])
}

model InventoryAdjustment {
  id              String         @id @default(cuid())
  userId          String
  inventoryItemId String
  type            AdjustmentType
  quantityChange  Decimal        @db.Decimal(10, 2)
  previousStock   Decimal        @db.Decimal(10, 2)
  newStock        Decimal        @db.Decimal(10, 2)
  reason          String
  notes           String?
  staffId         String?
  staffName       String?
  timestamp       DateTime       @default(now())
  inventoryItem   InventoryItem  @relation("ItemAdjustments", fields: [inventoryItemId], references: [id], onDelete: Cascade)
  user            User           @relation("UserInventoryAdjustments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([inventoryItemId])
  @@index([type])
  @@index([timestamp])
}

model StockAlert {
  id              String        @id @default(cuid())
  userId          String
  inventoryItemId String
  alertType       AlertType
  message         String
  severity        AlertSeverity @default(MEDIUM)
  isRead          Boolean       @default(false)
  isResolved      Boolean       @default(false)
  resolvedAt      DateTime?
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation("ItemAlerts", fields: [inventoryItemId], references: [id], onDelete: Cascade)
  user            User          @relation("UserStockAlerts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([inventoryItemId])
  @@index([isRead])
  @@index([isResolved])
  @@index([createdAt])
}

model Recipe {
  id             String             @id @default(cuid())
  userId         String
  name           String
  description    String?
  category       String?
  servingSize    Int                @default(1)
  prepTime       Int?
  cookTime       Int?
  totalCost      Decimal            @db.Decimal(10, 2)
  costPerServing Decimal            @db.Decimal(10, 2)
  sellingPrice   Decimal?           @db.Decimal(10, 2)
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  user           User               @relation("UserRecipes", fields: [userId], references: [id], onDelete: Cascade)
  ingredients    RecipeIngredient[] @relation("RecipeIngredients")

  @@index([userId])
  @@index([isActive])
}

model RecipeIngredient {
  id              String        @id @default(cuid())
  recipeId        String
  inventoryItemId String
  quantity        Decimal       @db.Decimal(10, 2)
  unit            InventoryUnit
  cost            Decimal       @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation("ItemRecipes", fields: [inventoryItemId], references: [id])
  recipe          Recipe        @relation("RecipeIngredients", fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([inventoryItemId])
}

model UserFeatureToggle {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserFeatureToggles", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature])
  @@index([userId])
  @@index([feature])
}

model AdminAction {
  id              String   @id @default(cuid())
  adminId         String
  adminEmail      String
  targetUserId    String?
  targetUserEmail String?
  action          String
  details         Json?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
}

model ClubOSHousehold {
  id                  String                @id @default(cuid())
  userId              String                @unique
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  emergencyContact    String?
  emergencyPhone      String?
  notes               String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  clubCode            String?
  clubOwnerId         String?
  status              ClubOSHouseholdStatus @default(PENDING)
  verifiedAt          DateTime?
  communications      ClubOSCommunication[]
  clubOwner           User?                 @relation("ClubOSClubOwner", fields: [clubOwnerId], references: [id])
  user                User                  @relation("ClubOSHousehold", fields: [userId], references: [id], onDelete: Cascade)
  invoices            ClubOSInvoice[]
  members             ClubOSMember[]
  payments            ClubOSPayment[]
  registrations       ClubOSRegistration[]

  @@index([userId])
  @@index([primaryContactEmail])
  @@index([primaryContactPhone])
  @@index([clubOwnerId])
  @@index([status])
  @@index([clubCode])
}

model ClubOSMember {
  id                    String                  @id @default(cuid())
  householdId           String
  memberType            ClubOSMemberType
  firstName             String
  lastName              String
  email                 String?
  phone                 String?
  dateOfBirth           DateTime?
  gender                ClubOSGender?
  photoUrl              String?
  medicalNotes          String?
  allergies             String?
  medications           String?
  shirtSize             String?
  waiverSigned          Boolean                 @default(false)
  waiverSignedDate      DateTime?
  backgroundCheckStatus String?
  backgroundCheckDate   DateTime?
  backgroundCheckExpiry DateTime?
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  household             ClubOSHousehold         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  registrations         ClubOSRegistration[]
  staffAssignments      ClubOSStaffAssignment[]
  teamMemberships       ClubOSTeamMember[]

  @@index([householdId])
  @@index([memberType])
  @@index([email])
  @@index([dateOfBirth])
}

model ClubOSProgram {
  id                    String               @id @default(cuid())
  userId                String
  name                  String
  description           String?
  programType           ClubOSProgramType
  status                ClubOSProgramStatus  @default(DRAFT)
  startDate             DateTime
  endDate               DateTime
  registrationOpenDate  DateTime?
  registrationCloseDate DateTime?
  maxParticipants       Int?
  currentParticipants   Int                  @default(0)
  baseFee               Int
  familyDiscount        Int?
  earlyBirdDiscount     Int?
  earlyBirdDeadline     DateTime?
  ageMin                Int?
  ageMax                Int?
  imageUrl              String?
  tags                  String[]
  isActive              Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  divisions             ClubOSDivision[]
  user                  User                 @relation("ClubOSUserPrograms", fields: [userId], references: [id], onDelete: Cascade)
  registrations         ClubOSRegistration[]
  waivers               ClubOSWaiver[]

  @@index([userId])
  @@index([programType])
  @@index([status])
  @@index([startDate])
}

model ClubOSDivision {
  id                String               @id @default(cuid())
  programId         String
  name              String
  ageMin            Int
  ageMax            Int
  gender            ClubOSGender?
  skillLevel        String?
  maxTeams          Int?
  maxPlayersPerTeam Int?
  practiceDay       String?
  practiceTime      String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  program           ClubOSProgram        @relation(fields: [programId], references: [id], onDelete: Cascade)
  registrations     ClubOSRegistration[]
  teams             ClubOSTeam[]

  @@index([programId])
  @@index([ageMin, ageMax])
}

model ClubOSTeam {
  id             String             @id @default(cuid())
  divisionId     String
  name           String
  colorPrimary   String?
  colorSecondary String?
  maxPlayers     Int?
  status         ClubOSTeamStatus   @default(FORMING)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  awayGames      ClubOSSchedule[]   @relation("AwayTeam")
  homeGames      ClubOSSchedule[]   @relation("HomeTeam")
  practices      ClubOSSchedule[]   @relation("PracticeTeam")
  division       ClubOSDivision     @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  members        ClubOSTeamMember[]

  @@index([divisionId])
  @@index([status])
}

model ClubOSTeamMember {
  id           String         @id @default(cuid())
  teamId       String
  memberId     String
  role         ClubOSTeamRole @default(PLAYER)
  jerseyNumber String?
  joinedDate   DateTime       @default(now())
  member       ClubOSMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  team         ClubOSTeam     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, memberId])
  @@index([teamId])
  @@index([memberId])
}

model ClubOSRegistration {
  id                String                   @id @default(cuid())
  householdId       String
  memberId          String
  programId         String
  divisionId        String?
  status            ClubOSRegistrationStatus @default(PENDING)
  registrationDate  DateTime                 @default(now())
  customFields      Json?
  specialRequests   String?
  totalAmount       Int
  amountPaid        Int                      @default(0)
  balanceDue        Int                      @default(0)
  waiverSignedDate  DateTime?
  documentsUploaded Json?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  payments          ClubOSPayment[]
  division          ClubOSDivision?          @relation(fields: [divisionId], references: [id])
  household         ClubOSHousehold          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  member            ClubOSMember             @relation(fields: [memberId], references: [id], onDelete: Cascade)
  program           ClubOSProgram            @relation(fields: [programId], references: [id], onDelete: Cascade)
  waitlistEntry     ClubOSWaitlist?

  @@index([householdId])
  @@index([memberId])
  @@index([programId])
  @@index([divisionId])
  @@index([status])
  @@index([registrationDate])
}

model ClubOSWaitlist {
  id               String             @id @default(cuid())
  registrationId   String             @unique
  position         Int
  notifiedDate     DateTime?
  responseDeadline DateTime?
  promotedDate     DateTime?
  createdAt        DateTime           @default(now())
  registration     ClubOSRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([position])
  @@index([responseDeadline])
}

model ClubOSWaiver {
  id        String        @id @default(cuid())
  programId String
  title     String
  content   String
  version   String
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  program   ClubOSProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
}

model ClubOSVenue {
  id           String           @id @default(cuid())
  userId       String
  name         String
  venueType    ClubOSVenueType
  address      String?
  city         String?
  state        String?
  zipCode      String?
  capacity     Int?
  hasLighting  Boolean          @default(false)
  hasParking   Boolean          @default(false)
  hasRestrooms Boolean          @default(false)
  availability Json?
  notes        String?
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  schedules    ClubOSSchedule[]
  user         User             @relation("ClubOSUserVenues", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([venueType])
}

model ClubOSSchedule {
  id               String                  @id @default(cuid())
  userId           String
  eventType        ClubOSEventType
  status           ClubOSEventStatus       @default(SCHEDULED)
  title            String
  description      String?
  startTime        DateTime
  endTime          DateTime
  venueId          String?
  homeTeamId       String?
  awayTeamId       String?
  practiceTeamId   String?
  homeScore        Int?
  awayScore        Int?
  notes            String?
  notificationsent Boolean                 @default(false)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  awayTeam         ClubOSTeam?             @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeTeam         ClubOSTeam?             @relation("HomeTeam", fields: [homeTeamId], references: [id])
  practiceTeam     ClubOSTeam?             @relation("PracticeTeam", fields: [practiceTeamId], references: [id])
  user             User                    @relation("ClubOSUserSchedules", fields: [userId], references: [id], onDelete: Cascade)
  venue            ClubOSVenue?            @relation(fields: [venueId], references: [id])
  staffAssignments ClubOSStaffAssignment[]

  @@index([userId])
  @@index([eventType])
  @@index([status])
  @@index([startTime])
  @@index([venueId])
  @@index([homeTeamId])
  @@index([awayTeamId])
}

model ClubOSStaffAssignment {
  id         String          @id @default(cuid())
  scheduleId String
  memberId   String
  role       ClubOSStaffRole
  fee        Int?
  confirmed  Boolean         @default(false)
  createdAt  DateTime        @default(now())
  member     ClubOSMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  schedule   ClubOSSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([memberId])
}

model ClubOSPayment {
  id               String                 @id @default(cuid())
  householdId      String
  amount           Int
  paymentMethod    ClubOSPaymentMethod
  status           ClubOSPaymentStatus    @default(PENDING)
  stripePaymentId  String?
  stripeCustomerId String?
  description      String?
  notes            String?
  paidAt           DateTime?
  refundedAt       DateTime?
  refundAmount     Int?
  refundReason     String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  metadata         Json?
  registrationId   String?
  stripeReceiptUrl String?
  invoices         ClubOSInvoicePayment[]
  household        ClubOSHousehold        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  registration     ClubOSRegistration?    @relation(fields: [registrationId], references: [id])

  @@index([householdId])
  @@index([registrationId])
  @@index([status])
  @@index([paidAt])
  @@index([stripeCustomerId])
}

model ClubOSInvoice {
  id                  String                 @id @default(cuid())
  householdId         String
  invoiceNumber       String                 @unique
  status              ClubOSInvoiceStatus    @default(PENDING)
  subtotal            Int
  discounts           Int                    @default(0)
  tax                 Int                    @default(0)
  total               Int
  amountPaid          Int                    @default(0)
  balanceDue          Int
  dueDate             DateTime?
  paidAt              DateTime?
  lineItems           Json
  notes               String?
  paymentPlanEnabled  Boolean                @default(false)
  installmentCount    Int?
  installmentAmount   Int?
  nextInstallmentDate DateTime?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  household           ClubOSHousehold        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  payments            ClubOSInvoicePayment[]

  @@index([householdId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
}

model ClubOSInvoicePayment {
  id        String        @id @default(cuid())
  invoiceId String
  paymentId String
  amount    Int
  createdAt DateTime      @default(now())
  invoice   ClubOSInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment   ClubOSPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, paymentId])
  @@index([invoiceId])
  @@index([paymentId])
}

model ClubOSCommunication {
  id               String                      @id @default(cuid())
  userId           String
  householdId      String?
  type             ClubOSCommunicationType
  status           ClubOSCommunicationStatus   @default(DRAFT)
  priority         ClubOSCommunicationPriority @default(NORMAL)
  subject          String?
  message          String
  recipientType    String
  recipientIds     String[]
  recipientCount   Int                         @default(0)
  deliveredCount   Int                         @default(0)
  failedCount      Int                         @default(0)
  scheduledFor     DateTime?
  sentAt           DateTime?
  twilioMessageSid String?
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  household        ClubOSHousehold?            @relation(fields: [householdId], references: [id])
  user             User                        @relation("ClubOSUserCommunications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([householdId])
  @@index([type])
  @@index([status])
  @@index([scheduledFor])
}

model ClubOSUserRelation {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  seasonStartMonth        Int      @default(8)
  timezone                String   @default("America/New_York")
  allowOnlineRegistration Boolean  @default(true)
  requireWaivers          Boolean  @default(true)
  requireBackgroundChecks Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation("ClubOSUserSettings", fields: [userId], references: [id], onDelete: Cascade)
}

model ClubOSNotificationSetting {
  id                   String                 @id @default(cuid())
  userId               String
  notificationType     ClubOSNotificationType
  enabled              Boolean                @default(true)
  sendEmail            Boolean                @default(true)
  sendSMS              Boolean                @default(false)
  reminderHoursBefore  Int?
  reminderDaysInterval Int?
  emailSubject         String?
  emailBody            String?
  smsTemplate          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  user                 User                   @relation("ClubOSNotificationSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([notificationType])
}

model ElevenLabsApiKey {
  id             String   @id @default(cuid())
  userId         String
  apiKey         String
  label          String
  priority       Int      @default(0)
  isActive       Boolean  @default(true)
  characterLimit Int      @default(0)
  characterUsed  Int      @default(0)
  lastCheckedAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation("ElevenLabsApiKeys", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, priority])
  @@index([userId, isActive])
  @@index([priority])
}

model GeneralInventoryCategory {
  id          String                     @id @default(cuid())
  userId      String
  name        String
  description String?
  parentId    String?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  parent      GeneralInventoryCategory?  @relation("GeneralCategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    GeneralInventoryCategory[] @relation("GeneralCategoryHierarchy")
  user        User                       @relation("InventoryCategories", fields: [userId], references: [id], onDelete: Cascade)
  items       GeneralInventoryItem[]

  @@index([userId])
  @@index([parentId])
}

model GeneralInventorySupplier {
  id          String                 @id @default(cuid())
  userId      String
  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?
  website     String?
  notes       String?
  isActive    Boolean                @default(true)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  items       GeneralInventoryItem[]
  user        User                   @relation("InventorySuppliers", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model GeneralInventoryLocation {
  id              String                       @id @default(cuid())
  userId          String
  name            String
  address         String?
  type            String?
  isDefault       Boolean                      @default(false)
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt
  adjustmentsFrom GeneralInventoryAdjustment[] @relation("GeneralAdjustmentFrom")
  adjustmentsTo   GeneralInventoryAdjustment[] @relation("GeneralAdjustmentTo")
  items           GeneralInventoryItem[]
  user            User                         @relation("InventoryLocations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model GeneralInventoryItem {
  id              String                       @id @default(cuid())
  userId          String
  sku             String
  name            String
  description     String?
  categoryId      String?
  supplierId      String?
  locationId      String?
  quantity        Int                          @default(0)
  reorderLevel    Int                          @default(0)
  reorderQuantity Int                          @default(0)
  unit            String?
  costPrice       Float?
  sellingPrice    Float?
  barcode         String?
  imageUrl        String?
  notes           String?
  isActive        Boolean                      @default(true)
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt
  adjustments     GeneralInventoryAdjustment[]
  category        GeneralInventoryCategory?    @relation(fields: [categoryId], references: [id])
  location        GeneralInventoryLocation?    @relation(fields: [locationId], references: [id])
  supplier        GeneralInventorySupplier?    @relation(fields: [supplierId], references: [id])
  user            User                         @relation("InventoryItems", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sku])
  @@index([userId])
  @@index([categoryId])
  @@index([supplierId])
  @@index([locationId])
}

model GeneralInventoryAdjustment {
  id             String                         @id @default(cuid())
  userId         String
  itemId         String
  type           GeneralInventoryAdjustmentType
  quantity       Int
  quantityBefore Int
  quantityAfter  Int
  fromLocationId String?
  toLocationId   String?
  unitCost       Float?
  totalCost      Float?
  reason         String?
  reference      String?
  notes          String?
  createdAt      DateTime                       @default(now())
  createdBy      String?
  fromLocation   GeneralInventoryLocation?      @relation("GeneralAdjustmentFrom", fields: [fromLocationId], references: [id])
  item           GeneralInventoryItem           @relation(fields: [itemId], references: [id], onDelete: Cascade)
  toLocation     GeneralInventoryLocation?      @relation("GeneralAdjustmentTo", fields: [toLocationId], references: [id])
  user           User                           @relation("InventoryAdjustments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([createdAt])
}

model EcommerceSyncSettings {
  id                        String    @id @default(cuid())
  userId                    String    @unique
  platform                  String
  autoSync                  Boolean   @default(false)
  syncInventory             Boolean   @default(false)
  syncPrices                Boolean   @default(false)
  syncProducts              Boolean   @default(false)
  shopifyDomain             String?
  shopifyAccessToken        String?
  woocommerceUrl            String?
  woocommerceConsumerKey    String?
  woocommerceConsumerSecret String?
  lastSyncAt                DateTime?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  user                      User      @relation("EcommerceSyncSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LowStockAlertSettings {
  id                String    @id @default(cuid())
  userId            String    @unique
  enabled           Boolean   @default(true)
  checkDaily        Boolean   @default(true)
  alertTime         String    @default("09:00")
  sendEmail         Boolean   @default(true)
  emailAddresses    String?
  sendSMS           Boolean   @default(false)
  smsNumbers        String?
  alertOnLowStock   Boolean   @default(true)
  alertOnOutOfStock Boolean   @default(true)
  alertOnCritical   Boolean   @default(true)
  lastAlertSent     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation("LowStockAlertSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Task {
  id              String           @id @default(cuid())
  userId          String
  title           String
  description     String?
  status          TaskStatus       @default(TODO)
  priority        TaskPriority     @default(MEDIUM)
  dueDate         DateTime?
  completedAt     DateTime?
  assignedToId    String?
  dealId          String?
  leadId          String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  actualHours     Float?
  aiContext       Json?
  aiSuggested     Boolean          @default(false)
  autoCreated     Boolean          @default(false)
  automationRule  String?
  category        String?
  dependsOnId     String?
  estimatedHours  Float?
  parentTaskId    String?
  progressPercent Int              @default(0)
  startDate       DateTime?
  tags            String[]
  assignedTo      User?            @relation("AssignedTasks", fields: [assignedToId], references: [id])
  deal            Deal?            @relation(fields: [dealId], references: [id])
  dependsOn       Task?            @relation("TaskDependencies", fields: [dependsOnId], references: [id])
  blockedTasks    Task[]           @relation("TaskDependencies")
  lead            Lead?            @relation(fields: [leadId], references: [id])
  parentTask      Task?            @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks        Task[]           @relation("TaskSubtasks")
  user            User             @relation("OwnedTasks", fields: [userId], references: [id], onDelete: Cascade)
  activityLogs    TaskActivity[]
  attachments     TaskAttachment[]
  comments        TaskComment[]

  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([leadId])
  @@index([dealId])
  @@index([parentTaskId])
  @@index([dependsOnId])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

model TaskAttachment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  fileName  String
  fileUrl   String
  fileSize  Int?
  mimeType  String?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskAttachments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  action    String
  oldValue  String?
  newValue  String?
  metadata  Json?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskActivities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
}

model TaskTemplate {
  id              String       @id @default(cuid())
  userId          String
  name            String
  description     String?
  category        String?
  defaultPriority TaskPriority @default(MEDIUM)
  estimatedHours  Float?
  checklistItems  Json?
  tags            String[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  user            User         @relation("TaskTemplates", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TaskAutomation {
  id                String    @id @default(cuid())
  userId            String
  name              String
  description       String?
  isActive          Boolean   @default(true)
  triggerType       String
  triggerConditions Json
  actionType        String
  actionConfig      Json
  lastRun           DateTime?
  runCount          Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation("TaskAutomations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model UserPermission {
  id        String       @id @default(cuid())
  userId    String
  resource  PageResource
  canRead   Boolean      @default(false)
  canWrite  Boolean      @default(false)
  canDelete Boolean      @default(false)
  grantedBy String?
  grantedAt DateTime     @default(now())
  expiresAt DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  user      User         @relation("UserPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource])
  @@index([userId])
  @@index([resource])
}

model AdminSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  lastActivity DateTime @default(now())
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  user         User     @relation("AdminSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
}

model BookingSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  businessName         String
  businessDescription  String?
  bookingUrl           String
  availabilitySchedule Json
  slotDuration         Int      @default(30)
  bufferTime           Int      @default(0)
  advanceBookingDays   Int      @default(30)
  minNoticeHours       Int      @default(24)
  allowedMeetingTypes  String[] @default(["PHONE", "VIDEO", "IN_PERSON"])
  requireApproval      Boolean  @default(false)
  customMessage        String?
  brandColor           String   @default("#9333ea")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation("BookingSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookingUrl])
}

model SuperAdminSession {
  id                 String    @id @default(cuid())
  superAdminId       String
  impersonatedUserId String
  sessionToken       String    @unique
  ipAddress          String?
  userAgent          String?
  startedAt          DateTime  @default(now())
  lastActivity       DateTime  @default(now())
  endedAt            DateTime?
  isActive           Boolean   @default(true)
  impersonatedUser   User      @relation("ImpersonatedSessions", fields: [impersonatedUserId], references: [id], onDelete: Cascade)
  superAdmin         User      @relation("SuperAdminSessions", fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([impersonatedUserId])
  @@index([sessionToken])
}

model KnowledgeBaseFile {
  id            String                        @id @default(cuid())
  userId        String
  fileName      String
  fileType      String
  fileSize      Int
  extractedText String
  createdAt     DateTime                      @default(now())
  updatedAt     DateTime                      @updatedAt
  user          User                          @relation("KnowledgeBaseFiles", fields: [userId], references: [id], onDelete: Cascade)
  voiceAgents   VoiceAgentKnowledgeBaseFile[]

  @@index([userId])
  @@index([createdAt])
}

model VoiceAgentKnowledgeBaseFile {
  id                  String            @id @default(cuid())
  voiceAgentId        String
  knowledgeBaseFileId String
  addedAt             DateTime          @default(now())
  knowledgeBaseFile   KnowledgeBaseFile @relation(fields: [knowledgeBaseFileId], references: [id], onDelete: Cascade)
  voiceAgent          VoiceAgent        @relation("VoiceAgentKnowledgeFiles", fields: [voiceAgentId], references: [id], onDelete: Cascade)

  @@unique([voiceAgentId, knowledgeBaseFileId])
  @@index([voiceAgentId])
  @@index([knowledgeBaseFileId])
}

model RelationshipGraph {
  id                String           @id @default(cuid())
  userId            String
  sourceType        EntityType
  sourceId          String
  targetType        EntityType
  targetId          String
  relationshipType  RelationshipType
  strength          Float            @default(1.0)
  interactionCount  Int              @default(1)
  lastInteractionAt DateTime         @default(now())
  firstCreatedAt    DateTime         @default(now())
  context           Json?
  isAutomatic       Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation("UserRelationshipGraphs", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sourceType, sourceId, targetType, targetId, relationshipType])
  @@index([userId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([strength])
  @@index([lastInteractionAt])
}

model RelationshipMetrics {
  id             String     @id @default(cuid())
  userId         String
  entityType     EntityType
  entityId       String
  totalRelations Int        @default(0)
  avgStrength    Float      @default(0)
  strongestType  String?
  lastUpdated    DateTime   @default(now())
  user           User       @relation("UserRelationshipMetrics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, entityId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([avgStrength])
}

model ToolDefinition {
  id               String               @id @default(cuid())
  name             String
  slug             String               @unique
  description      String
  category         ToolCategory
  baseUrl          String?
  authType         ToolAuthType
  authConfig       Json?
  openApiSpec      Json?
  apiVersion       String?
  capabilities     Json
  requiredScopes   String[]
  webhookSupport   Boolean              @default(false)
  rateLimits       Json?
  isPublic         Boolean              @default(false)
  isOfficial       Boolean              @default(false)
  logoUrl          String?
  documentationUrl String?
  installCount     Int                  @default(0)
  rating           Float?
  createdById      String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  createdBy        User?                @relation("ToolCreator", fields: [createdById], references: [id])
  instances        ToolInstance[]
  recommendations  ToolRecommendation[] @relation("ToolRecommendations")

  @@index([category])
  @@index([slug])
  @@index([isPublic])
}

model ToolInstance {
  id                  String             @id @default(cuid())
  userId              String
  definitionId        String
  name                String
  description         String?
  status              ToolStatus         @default(TESTING)
  credentials         Json
  config              Json?
  lastUsed            DateTime?
  totalCalls          Int                @default(0)
  successfulCalls     Int                @default(0)
  failedCalls         Int                @default(0)
  avgResponseTime     Float?
  uptime              Float?
  lastError           String?
  lastErrorAt         DateTime?
  consecutiveErrors   Int                @default(0)
  installedAt         DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  actions             ToolAction[]
  healthMetrics       ToolHealthMetric[] @relation("ToolHealthMetrics")
  definition          ToolDefinition     @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  user                User               @relation("UserToolInstances", fields: [userId], references: [id], onDelete: Cascade)
  sourceRelationships ToolRelationship[] @relation("SourceToolRelationships")
  targetRelationships ToolRelationship[] @relation("TargetToolRelationships")
  retirements         ToolRetirement[]   @relation("ToolRetirements")

  @@unique([userId, definitionId])
  @@index([userId])
  @@index([status])
}

model ToolAction {
  id              String       @id @default(cuid())
  userId          String
  instanceId      String
  actionType      String
  method          String
  endpoint        String
  requestPayload  Json?
  responsePayload Json?
  statusCode      Int?
  duration        Int?
  success         Boolean
  errorMessage    String?
  errorCode       String?
  retryCount      Int          @default(0)
  triggeredBy     String?
  context         Json?
  executedAt      DateTime     @default(now())
  instance        ToolInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  user            User         @relation("UserToolActions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
  @@index([success])
  @@index([executedAt])
}

model AIWorkflowTemplate {
  id                 String               @id @default(cuid())
  name               String
  description        String
  pattern            Json
  confidence         Float
  detectedFromUserId String?
  workflowDefinition Json
  nodes              Json
  edges              Json
  avgExecutionTime   Float?
  avgSuccessRate     Float?
  totalExecutions    Int                  @default(0)
  successfulRuns     Int                  @default(0)
  failedRuns         Int                  @default(0)
  isVariant          Boolean              @default(false)
  variantOf          String?
  conversionRate     Float?
  isPublic           Boolean              @default(false)
  category           String?
  tags               String[]
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  instances          AIWorkflowInstance[]

  @@index([detectedFromUserId])
  @@index([category])
}

model AIWorkflowInstance {
  id               String                @id @default(cuid())
  userId           String
  templateId       String?
  name             String
  description      String?
  status           AIWorkflowStatus      @default(DRAFT)
  definition       Json
  version          Int                   @default(1)
  triggerType      AIWorkflowTriggerType
  triggerConfig    Json
  totalExecutions  Int                   @default(0)
  successfulRuns   Int                   @default(0)
  failedRuns       Int                   @default(0)
  avgExecutionTime Float?
  lastExecutedAt   DateTime?
  outcomeMetric    String?
  outcomeValue     Float?
  previousVersions Json?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  executions       AIWorkflowExecution[]
  template         AIWorkflowTemplate?   @relation(fields: [templateId], references: [id])
  user             User                  @relation("UserWorkflowInstances", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([triggerType])
}

model AIWorkflowExecution {
  id           String             @id @default(cuid())
  userId       String
  instanceId   String
  status       String
  currentStep  String?
  inputData    Json
  outputData   Json?
  startedAt    DateTime           @default(now())
  completedAt  DateTime?
  duration     Int?
  errorMessage String?
  errorStep    String?
  retryCount   Int                @default(0)
  stepLogs     Json?
  triggeredBy  String?
  context      Json?
  instance     AIWorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  user         User               @relation("UserWorkflowExecutions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
  @@index([status])
  @@index([startedAt])
}

// AI-generated reports from the conversational assistant
model AiGeneratedReport {
  id         String   @id @default(cuid())
  userId     String
  title      String
  reportType String // sales, leads, revenue, overview, custom
  content    Json // Chart data, tables, summary text
  period     String? // last_7_days, last_month, etc.
  createdAt  DateTime @default(now())
  user       User     @relation("UserAiGeneratedReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model WorkflowOptimization {
  id                  String    @id @default(cuid())
  userId              String
  originalInstanceId  String
  variantInstanceId   String
  testStartedAt       DateTime  @default(now())
  testEndedAt         DateTime?
  trafficSplit        Float     @default(0.5)
  originalConversions Int       @default(0)
  originalExecutions  Int       @default(0)
  variantConversions  Int       @default(0)
  variantExecutions   Int       @default(0)
  winnerId            String?
  winnerConfidence    Float?
  improvementPercent  Float?
  insights            Json?
  user                User      @relation("UserWorkflowOptimizations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([originalInstanceId])
  @@index([variantInstanceId])
}

model ToolRelationship {
  id               String       @id @default(cuid())
  userId           String
  sourceInstanceId String
  targetType       String
  targetId         String
  relationshipType String
  strength         Float        @default(1.0)
  interactionCount Int          @default(1)
  successfulUses   Int          @default(0)
  failedUses       Int          @default(0)
  lastUsedAt       DateTime     @default(now())
  aiConfidence     Float?
  suggestedByAI    Boolean      @default(false)
  context          Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  sourceInstance   ToolInstance @relation("SourceToolRelationships", fields: [sourceInstanceId], references: [id], onDelete: Cascade)
  targetInstance   ToolInstance @relation("TargetToolRelationships", fields: [targetId], references: [id], onDelete: Cascade)
  user             User         @relation("UserToolRelationships", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sourceInstanceId])
  @@index([targetType, targetId])
  @@index([relationshipType])
  @@index([strength])
}

model ToolUsagePattern {
  id              String   @id @default(cuid())
  userId          String
  patternName     String
  description     String
  toolInstanceIds String[]
  executionOrder  Json
  detectedCount   Int      @default(1)
  successRate     Float    @default(0)
  avgTimeSaved    Float?
  confidence      Float    @default(0)
  recommendation  String?
  isAutomated     Boolean  @default(false)
  automationId    String?
  firstDetectedAt DateTime @default(now())
  lastDetectedAt  DateTime @default(now())
  user            User     @relation("UserToolUsagePatterns", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([confidence])
}

model ToolHealthMetric {
  id                String       @id @default(cuid())
  userId            String
  instanceId        String
  healthScore       Float
  availabilityScore Float
  performanceScore  Float
  errorRateScore    Float
  usageScore        Float
  hasIssues         Boolean      @default(false)
  issuesSummary     String?
  alertsSent        Int          @default(0)
  recordedAt        DateTime     @default(now())
  instance          ToolInstance @relation("ToolHealthMetrics", fields: [instanceId], references: [id], onDelete: Cascade)
  user              User         @relation("UserToolHealthMetrics", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
  @@index([healthScore])
  @@index([recordedAt])
}

model ToolRecommendation {
  id               String         @id @default(cuid())
  userId           String
  toolDefinitionId String
  reason           String
  confidence       Float
  detectedGap      String?
  estimatedValue   Float?
  viewed           Boolean        @default(false)
  viewedAt         DateTime?
  installed        Boolean        @default(false)
  installedAt      DateTime?
  dismissed        Boolean        @default(false)
  dismissedAt      DateTime?
  dismissReason    String?
  createdAt        DateTime       @default(now())
  toolDefinition   ToolDefinition @relation("ToolRecommendations", fields: [toolDefinitionId], references: [id], onDelete: Cascade)
  user             User           @relation("UserToolRecommendations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([toolDefinitionId])
  @@index([confidence])
}

model ToolRetirement {
  id                   String       @id @default(cuid())
  userId               String
  instanceId           String
  reason               String
  usageStats           Json
  suggestedAlternative String?
  alternativeReason    String?
  viewed               Boolean      @default(false)
  viewedAt             DateTime?
  retired              Boolean      @default(false)
  retiredAt            DateTime?
  dismissed            Boolean      @default(false)
  dismissedAt          DateTime?
  createdAt            DateTime     @default(now())
  instance             ToolInstance @relation("ToolRetirements", fields: [instanceId], references: [id], onDelete: Cascade)
  user                 User         @relation("UserToolRetirements", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
}

enum UserRole {
  SUPER_ADMIN
  AGENCY_ADMIN
  USER
  BUSINESS_OWNER
  PARENT
}

enum Industry {
  RESTAURANT
  SPORTS_CLUB
  CONSTRUCTION
  MEDICAL
  DENTIST
  MEDICAL_SPA
  OPTOMETRIST
  HEALTH_CLINIC
  REAL_ESTATE
  HOSPITAL
  TECHNOLOGY
}

enum LeadStatus {
  NEW
  CONTACTED
  RESPONDED
  QUALIFIED
  CONVERTED
  LOST
}

enum CampaignType {
  REVIEW_REQUEST
  REFERRAL_REQUEST
  FOLLOW_UP
  CUSTOM
  EMAIL
  SMS
  MULTI_CHANNEL
  VOICE_CALL
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  SCHEDULED
  RUNNING
}

enum CampaignFrequency {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
}

enum CampaignLeadStatus {
  PENDING
  SENT
  DELIVERED
  RESPONDED
  FAILED
  COMPLETED
  CONVERTED
}

enum ReviewSource {
  GOOGLE
  FACEBOOK
  YELP
  TRUSTPILOT
  OTHER
}

enum ReferralStatus {
  PENDING
  CONTACTED
  CONVERTED
  EXPIRED
  DECLINED
}

enum VoiceAgentType {
  INBOUND
  OUTBOUND
  BOTH
}

enum VoiceAgentStatus {
  ACTIVE
  INACTIVE
  TESTING
}

enum CallDirection {
  INBOUND
  OUTBOUND
  PREVIEW
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
}

enum CallOutcome {
  APPOINTMENT_BOOKED
  INFORMATION_PROVIDED
  TRANSFERRED_TO_HUMAN
  VOICEMAIL
  HUNG_UP
  ERROR
}

enum OutboundCallStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  NO_ANSWER
  BUSY
}

enum CalendarProvider {
  GOOGLE
  OUTLOOK
  OFFICE365
  APPLE
  EXTERNAL_API
}

enum SyncStatus {
  SYNCED
  PENDING
  FAILED
  DISABLED
}

enum ChannelType {
  SMS
  EMAIL
  WHATSAPP
  INSTAGRAM
  FACEBOOK_MESSENGER
  GOOGLE_BUSINESS
  WEBSITE_CHAT
}

enum ChannelConnectionStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING_AUTH
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  UNREAD
  SNOOZED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum DealPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DealActivityType {
  NOTE
  CALL
  EMAIL
  MEETING
  TASK_COMPLETED
  STAGE_CHANGED
  VALUE_CHANGED
  CREATED
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
  SCHEDULED
  CANCELLED
}

enum WorkflowTriggerType {
  LEAD_CREATED
  LEAD_STATUS_CHANGED
  DEAL_CREATED
  DEAL_STAGE_CHANGED
  DEAL_WON
  DEAL_LOST
  EMAIL_OPENED
  EMAIL_CLICKED
  SMS_REPLIED
  FORM_SUBMITTED
  TAG_ADDED
  TAG_REMOVED
  APPOINTMENT_BOOKED
  CUSTOM_FIELD_CHANGED
  TIME_BASED
  MANUAL
  MESSAGE_RECEIVED
  MESSAGE_WITH_KEYWORDS
  AFTER_HOURS_MESSAGE
  CONVERSATION_STARTED
  LEAD_NO_RESPONSE
  DEAL_STALE
  SCHEDULED
  WEBSITE_VISITOR
  WEBSITE_FORM_SUBMITTED
  WEBSITE_PAYMENT_RECEIVED
  WEBSITE_BOOKING_CREATED
  WEBSITE_CTA_CLICKED
  WEBSITE_PAGE_VIEWED
  WEBSITE_PRODUCT_LOW_STOCK
  WEBSITE_PRODUCT_OUT_OF_STOCK
  WEBSITE_PRODUCT_BACK_IN_STOCK
  WEBSITE_ORDER_CREATED
  WEBSITE_PAYMENT_AMOUNT_THRESHOLD
  WEBSITE_CUSTOMER_TIER_CHANGED
  WEBSITE_REPEAT_CUSTOMER
  WEBSITE_FIRST_TIME_CUSTOMER
  WEBSITE_PRODUCT_PURCHASED
  WEBSITE_CART_VALUE_THRESHOLD
  WEBSITE_VISITOR_PAGE_VIEWED
  WEBSITE_VISITOR_TIME_ON_SITE
  WEBSITE_VISITOR_PAGES_VIEWED
  WEBSITE_VISITOR_CTA_CLICKED
  WEBSITE_VISITOR_RETURNING
  WEBSITE_VISITOR_ABANDONED_CART
  WEBSITE_REVENUE_MILESTONE
  WEBSITE_ORDER_COUNT_MILESTONE
  WEBSITE_DAILY_REVENUE_THRESHOLD
}

enum WorkflowActionType {
  SEND_EMAIL
  SEND_SMS
  CREATE_TASK
  UPDATE_LEAD
  UPDATE_DEAL
  ADD_TAG
  REMOVE_TAG
  MOVE_DEAL_STAGE
  CHANGE_LEAD_STATUS
  ASSIGN_TO_USER
  CREATE_APPOINTMENT
  WAIT_DELAY
  CONDITIONAL_SPLIT
  WEBHOOK
  AI_GENERATE_MESSAGE
  AI_SCORE_LEAD
  SEND_MESSAGE
  CREATE_LEAD_FROM_MESSAGE
  ASSIGN_TO_DEAL
  AUTO_REPLY
  NOTIFY_USER
  SCHEDULE_FOLLOW_UP
  CREATE_DEAL_FROM_LEAD
  MAKE_OUTBOUND_CALL
  CREATE_WEBSITE
  UPDATE_WEBSITE_CONTENT
  ADD_PAYMENT_SECTION
  ADD_BOOKING_WIDGET
  ADD_LEAD_FORM
  ADD_CTA_BUTTON
  PUBLISH_WEBSITE
}

enum WorkflowEnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum WorkflowActionExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

enum EmailCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum EmailCampaignDealStatus {
  PENDING
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum SmsCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum SmsCampaignDealStatus {
  PENDING
  SENDING
  SENT
  DELIVERED
  CLICKED
  REPLIED
  FAILED
}

enum TeamMemberRole {
  OWNER
  ADMIN
  MANAGER
  AGENT
  VIEWER
}

enum TeamMemberStatus {
  ACTIVE
  INACTIVE
  INVITED
}

enum AppointmentTypeCategory {
  CONSULTATION
  SERVICE
  MEETING
  DEMO
  SUPPORT
  TRAINING
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum MeetingType {
  PHONE_CALL
  VIDEO_CALL
  IN_PERSON
}

enum PaymentProvider {
  STRIPE
  SQUARE
  PAYPAL
  APPLE_PAY
  GOOGLE_PAY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentType {
  APPOINTMENT
  INVOICE
  SUBSCRIPTION
  DEAL
  SERVICE
  PRODUCT
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  PERMISSION_CHANGE
  API_KEY_CREATED
  API_KEY_DELETED
  PAYMENT_PROCESSED
  DATA_EXPORT
  SETTINGS_MODIFIED
  USER_INVITED
  USER_REMOVED
}

enum AuditSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SoshogleMerchantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

enum SoshogleMethodType {
  CARD
  BANK_ACCOUNT
  WALLET
  CRYPTO
  BNPL
}

enum SoshogleIntentStatus {
  PENDING
  PROCESSING
  REQUIRES_PAYMENT_METHOD
  REQUIRES_CONFIRMATION
  REQUIRES_ACTION
  SUCCEEDED
  CANCELED
  FAILED
  REFUNDED
}

enum SoshogleFinancingStatus {
  PENDING
  ACTIVE
  PAID_OFF
  DEFAULTED
  CANCELED
}

enum SoshogleDisputeStatus {
  NEEDS_RESPONSE
  UNDER_REVIEW
  CHARGE_REFUNDED
  WON
  LOST
}

enum SoshogleLoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApplicationType {
  NEW_CREDIT
  CREDIT_INCREASE
  BNPL_ELIGIBILITY
  MERCHANT_FINANCING
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  DENIED
  EXPIRED
}

enum AchSettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum AchTransactionType {
  CREDIT
  DEBIT
  REFUND
  REVERSAL
}

enum BnplStatus {
  PENDING
  APPROVED
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

enum BnplInstallmentStatus {
  SCHEDULED
  PENDING
  PAID
  OVERDUE
  FAILED
  WAIVED
}

enum InsightType {
  TRANSACTION_VOLUME
  PAYMENT_METHOD_PREFERENCE
  CUSTOMER_BEHAVIOR
  REVENUE_TREND
  CREDIT_UTILIZATION
  BNPL_PERFORMANCE
  FRAUD_DETECTION
  GEOGRAPHIC_DISTRIBUTION
}

enum InsightPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DataExportFormat {
  CSV
  JSON
  XML
  PDF
}

enum DataExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum WidgetLayout {
  GRID
  LIST
  CAROUSEL
  COMPACT
  FEATURED
}

enum WidgetTheme {
  LIGHT
  DARK
  AUTO
  CUSTOM
}

enum CashTransactionType {
  SALE
  REFUND
  EXPENSE
  ADJUSTMENT
}

enum DataConsentStatus {
  PENDING
  GRANTED
  REVOKED
  EXPIRED
}

enum DataSharingLevel {
  NONE
  ANONYMOUS_ONLY
  AGGREGATED
  FULL_ANONYMOUS
}

enum FraudRiskLevel {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudReviewStatus {
  PENDING
  APPROVED
  DECLINED
  INVESTIGATING
  RESOLVED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ReservationActivityType {
  CREATED
  CONFIRMED
  MODIFIED
  CANCELLED
  REMINDER_SENT
  SEATED
  COMPLETED
  NO_SHOW
  NOTE_ADDED
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum ReminderChannel {
  EMAIL
  SMS
  VOICE
  PUSH
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
  FAILED
}

enum VehicleType {
  CAR
  BIKE
  SCOOTER
  WALKING
  VAN
  TRUCK
}

enum DriverStatus {
  OFFLINE
  AVAILABLE
  BUSY
  ON_BREAK
}

enum StaffRole {
  CASHIER
  MANAGER
  ADMIN
}

enum ShiftStatus {
  ACTIVE
  CLOSED
  VOID
}

enum POSOrderType {
  DINE_IN
  TAKEOUT
  DELIVERY
  DRIVE_THRU
}

enum POSOrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
  VOID
}

enum POSPaymentMethod {
  CASH
  CARD
  WALLET
  SPLIT
}

enum POSPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
}

enum ReceiptType {
  SALE
  RETURN
  VOID
  REFUND
}

enum KitchenItemStatus {
  PENDING
  PREPARING
  READY
  BUMPED
  CANCELLED
}

enum KitchenPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PrepAction {
  RECEIVED
  STARTED
  PAUSED
  RESUMED
  READY
  BUMPED
  CANCELLED
  MODIFIED
}

enum InventoryCategory {
  INGREDIENT
  BEVERAGE
  SUPPLY
  EQUIPMENT
  OTHER
}

enum InventoryUnit {
  PIECE
  KG
  LBS
  GRAM
  OZ
  LITER
  ML
  GALLON
  CUP
  TBSP
  TSP
  BOX
  CASE
  BAG
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum POPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum AdjustmentType {
  SALE
  WASTE
  MANUAL_ADD
  MANUAL_SUBTRACT
  TRANSFER
  RETURN
  PRODUCTION
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  EXPIRING_SOON
  EXPIRED
  REORDER_NEEDED
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AccountStatus {
  PENDING_APPROVAL
  ACTIVE
  TRIAL
  SUSPENDED
  CANCELLED
  DISABLED
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum ClubOSHouseholdStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum ClubOSMemberType {
  PLAYER
  PARENT
  COACH
  VOLUNTEER
  REFEREE
  ADMIN
}

enum ClubOSGender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ClubOSProgramType {
  LEAGUE
  CAMP
  CLINIC
  TOURNAMENT
  TRAINING
}

enum ClubOSProgramStatus {
  DRAFT
  OPEN
  CLOSED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ClubOSTeamStatus {
  FORMING
  ACTIVE
  INACTIVE
  DISBANDED
}

enum ClubOSTeamRole {
  PLAYER
  HEAD_COACH
  ASSISTANT_COACH
  TEAM_PARENT
}

enum ClubOSRegistrationStatus {
  PENDING
  APPROVED
  WAITLIST
  ACTIVE
  COMPLETED
  CANCELLED
  REFUNDED
}

enum ClubOSVenueType {
  FIELD
  COURT
  GYM
  POOL
  TRACK
  STADIUM
  FACILITY
  OTHER
}

enum ClubOSEventType {
  GAME
  PRACTICE
  TOURNAMENT
  TRYOUT
  MEETING
  OTHER
}

enum ClubOSEventStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  POSTPONED
  CANCELLED
}

enum ClubOSStaffRole {
  REFEREE
  ASSISTANT_REFEREE
  SCOREKEEPER
  TIMEKEEPER
  MEDIC
  OTHER
}

enum ClubOSPaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum ClubOSPaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  ACH
  CASH
  CHECK
  OTHER
}

enum ClubOSInvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum ClubOSCommunicationType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum ClubOSCommunicationStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum ClubOSCommunicationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ClubOSNotificationType {
  REGISTRATION_CONFIRMATION
  PAYMENT_CONFIRMATION
  SCHEDULE_UPDATE
  SCHEDULE_REMINDER
  BALANCE_REMINDER
  REGISTRATION_APPROVED
  REGISTRATION_WAITLIST
  TEAM_ASSIGNMENT
}

enum GeneralInventoryAdjustmentType {
  PURCHASE
  SALE
  RETURN
  DAMAGE
  TRANSFER
  ADJUSTMENT
  INITIAL
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
  BLOCKED
  REVIEW
}

enum PageResource {
  DASHBOARD
  LEADS
  CONTACTS
  DEALS
  TASKS
  CALENDAR
  MESSAGES
  VOICE_AGENTS
  TEAM
  ANALYTICS
  REPORTS
  SETTINGS
  BILLING
  GENERAL_INVENTORY
  CLUBOS_ADMIN
  CLUBOS_TEAMS
  CLUBOS_SCHEDULES
  CLUBOS_COMMUNICATIONS
  CLUBOS_PARENT_PORTAL
}

enum PermissionAction {
  READ
  WRITE
  DELETE
}

enum EntityType {
  LEAD
  DEAL
  TASK
  CONVERSATION
  CONTACT
  APPOINTMENT
  CALL_LOG
  EMAIL
  SMS
  NOTE
  PAYMENT
  INVOICE
}

enum RelationshipType {
  CREATED_FROM
  ASSIGNED_TO
  RELATED_TO
  MENTIONED_IN
  FOLLOWS_UP_ON
  CONVERTED_TO
  SCHEDULED_FOR
  PAYMENT_FOR
  ORIGINATED_FROM
  DEPENDS_ON
}

enum ToolAuthType {
  API_KEY
  OAUTH2
  BASIC_AUTH
  BEARER_TOKEN
  CUSTOM
}

enum ToolStatus {
  ACTIVE
  INACTIVE
  TESTING
  DEPRECATED
  FAILED
}

enum ToolCategory {
  COMMUNICATION
  INTEGRATION
  AUTOMATION
  ANALYTICS
  AI_ML
  STORAGE
  PAYMENT
  CUSTOM
}

enum AIWorkflowTriggerType {
  MANUAL
  SCHEDULED
  EVENT
  TOOL_RESPONSE
  AI_SUGGESTION
}

enum AIWorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
  FAILED
}

enum WorkflowNodeType {
  TRIGGER
  CONDITION
  TOOL_ACTION
  AI_DECISION
  WAIT
  BRANCH
  LOOP
  END
}

// ============================================
// LEAD GENERATION SYSTEM MODELS
// ============================================

enum LeadGenerationSource {
  GOOGLE_MAPS
  LINKEDIN
  MANUAL_IMPORT
  WEB_SCRAPING
}

enum LeadGenerationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  PAUSED
}

enum EnrichmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  PARTIAL
}

enum EnrichmentProvider {
  HUNTER_IO
  CLEARBIT
  APOLLO
  BUILTWITH
  LINKEDIN
  CUSTOM
}

model LeadGenerationCampaign {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  source      LeadGenerationSource
  status      LeadGenerationStatus @default(PENDING)

  // Search Parameters
  searchQuery String
  location    String?
  radius      Float? // in km
  maxResults  Int?    @default(100)

  // Filters
  minRating       Float?
  categories      Json? // Array of business categories
  excludeKeywords Json? // Array of keywords to exclude

  // Progress Tracking
  totalFound    Int @default(0)
  totalScraped  Int @default(0)
  totalEnriched Int @default(0)
  totalImported Int @default(0)

  // Metadata
  startedAt    DateTime?
  completedAt  DateTime?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scrapedLeads ScrapedLead[]

  @@index([userId])
  @@index([status])
  @@index([source])
}

model ScrapedLead {
  id         String                 @id @default(cuid())
  campaignId String
  campaign   LeadGenerationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String
  user       User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Raw Scraped Data
  businessName String
  address      String?
  city         String?
  state        String?
  zipCode      String?
  country      String?
  phone        String?
  website      String?
  email        String?
  category     String?

  // Google Maps Specific
  googlePlaceId     String? @unique
  googleRating      Float?
  googleReviewCount Int?
  googleMapUrl      String?
  latitude          Float?
  longitude         Float?
  businessHours     Json? // Operating hours

  // LinkedIn Specific
  linkedinUrl         String?
  linkedinCompanySize String?
  linkedinIndustry    String?

  // Social Media
  facebookUrl  String?
  instagramUrl String?
  twitterUrl   String?

  // Enrichment Status
  enrichmentStatus EnrichmentStatus @default(PENDING)
  isImportedToCRM  Boolean          @default(false)
  importedLeadId   String? // Reference to Lead if imported

  // AI Scoring (will be added in Phase 1C)
  aiScore        Float? // 0-100 score
  aiScoreReasons Json? // Array of scoring factors

  // Metadata
  rawData        Json? // Store original scrape data
  scrapedAt      DateTime  @default(now())
  lastEnrichedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  enrichments LeadEnrichment[]

  @@index([campaignId])
  @@index([userId])
  @@index([enrichmentStatus])
  @@index([aiScore])
  @@index([googlePlaceId])
}

model LeadEnrichment {
  id            String      @id @default(cuid())
  scrapedLeadId String
  scrapedLead   ScrapedLead @relation(fields: [scrapedLeadId], references: [id], onDelete: Cascade)

  provider EnrichmentProvider
  status   EnrichmentStatus   @default(PENDING)

  // Enriched Data
  emails         Json? // Array of found emails with confidence scores
  phoneNumbers   Json? // Array of found phone numbers
  socialProfiles Json? // Social media URLs
  companyInfo    Json? // Company size, revenue, etc.
  contactInfo    Json? // Decision maker contacts
  technologies   Json? // Tech stack (from BuiltWith, etc.)

  // Verification Status
  emailVerified Boolean?
  phoneVerified Boolean?

  // Metadata
  confidence  Float? // 0-1 confidence score
  cost        Float? // API call cost
  creditsUsed Int? // Credits consumed

  apiResponse  Json? // Full API response for debugging
  errorMessage String?

  enrichedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([scrapedLeadId])
  @@index([provider])
  @@index([status])
}

// ============================================
// AI LEAD GENERATION SYSTEM - NEW TABLES
// ============================================

// EnrichmentCache: Cache enrichment API responses to reduce costs
model EnrichmentCache {
  id           String   @id @default(cuid())
  companyId    String   @unique // Unique identifier for company
  companyName  String
  domain       String?
  enrichedData Json // Cached enrichment data from Hunter.io, Clearbit, etc.
  lastUpdated  DateTime @default(now())
  expiresAt    DateTime // Cache expiration (typically 90 days)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([companyId])
  @@index([domain])
  @@index([expiresAt])
}

// LeadScore: Track lead scoring history for analytics
model LeadScore {
  id             String   @id @default(cuid())
  leadId         String
  score          Int // 0-100 weighted score
  scoreBreakdown Json // { firmographics: 40, intent: 30, engagement: 20, fit: 10 }
  calculatedAt   DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([leadId])
  @@index([score])
  @@index([calculatedAt])
}

// OutreachLog: Track all outreach attempts across channels
model OutreachLog {
  id                String    @id @default(cuid())
  leadId            String
  channel           String // email, sms, voice, linkedin
  sentAt            DateTime  @default(now())
  openedAt          DateTime? // Email only
  clickedAt         DateTime? // Email only
  repliedAt         DateTime? // Email, SMS only
  responseText      String? // Response content
  responseSentiment String? // positive, neutral, negative
  messageId         String? // External message ID for tracking
  errorMessage      String? // If delivery failed
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([leadId])
  @@index([channel])
  @@index([sentAt])
  @@index([openedAt])
}

// LeadEnrichmentCache: Cache enriched lead data to minimize API costs
model LeadEnrichmentCache {
  id           String   @id @default(cuid())
  email        String?
  domain       String?
  enrichedData Json // Cached data from Hunter.io, Clearbit APIs
  expiresAt    DateTime // Cache expiration (typically 30 days)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
  @@index([domain])
  @@index([expiresAt])
}

// ============================================
// EMAIL DRIP CAMPAIGN SYSTEM - Week 1-2
// ============================================

// EmailDripCampaign: Main drip campaign configuration
model EmailDripCampaign {
  id          String                  @id @default(cuid())
  userId      String
  name        String
  description String?
  status      EmailDripCampaignStatus @default(DRAFT)
  triggerType DripTriggerType         @default(MANUAL)

  // Trigger configuration
  triggerConfig Json? // Additional trigger settings

  // Campaign settings
  fromName  String?
  fromEmail String?
  replyTo   String?

  // Analytics
  totalEnrolled     Int   @default(0)
  totalCompleted    Int   @default(0)
  totalUnsubscribed Int   @default(0)
  totalBounced      Int   @default(0)
  avgOpenRate       Float @default(0)
  avgClickRate      Float @default(0)
  avgReplyRate      Float @default(0)

  // A/B Testing
  enableAbTesting Boolean @default(false)
  abTestConfig    Json? // A/B test configuration

  // Metadata
  tags      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sequences   EmailDripSequence[]
  enrollments EmailDripEnrollment[]

  @@index([userId])
  @@index([status])
  @@index([triggerType])
}

// EmailDripSequence: Individual emails in the drip sequence
model EmailDripSequence {
  id            String  @id @default(cuid())
  campaignId    String
  sequenceOrder Int // Order in the sequence (1, 2, 3, etc.)
  name          String
  subject       String
  previewText   String?
  htmlContent   String
  textContent   String?

  // Timing
  delayDays  Int     @default(0) // Days to wait after previous email
  delayHours Int     @default(0) // Additional hours to wait
  sendTime   String? // Preferred send time (HH:MM)

  // Conditions
  sendConditions Json? // Conditions to check before sending
  skipIfEngaged  Boolean @default(false) // Skip if lead engaged with previous email

  // A/B Testing variants
  isAbTestVariant Boolean @default(false)
  abTestGroup     String? // A or B
  variantOf       String? // ID of the main sequence if this is a variant

  // Analytics
  totalSent         Int @default(0)
  totalDelivered    Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalReplied      Int @default(0)
  totalBounced      Int @default(0)
  totalUnsubscribed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign EmailDripCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages EmailDripMessage[]

  @@unique([campaignId, sequenceOrder])
  @@index([campaignId])
  @@index([sequenceOrder])
}

// EmailDripEnrollment: Track which leads are enrolled in campaigns
model EmailDripEnrollment {
  id         String               @id @default(cuid())
  campaignId String
  leadId     String
  status     DripEnrollmentStatus @default(ACTIVE)

  // Progress tracking
  currentSequenceId String? // Current sequence in the campaign
  currentStep       Int       @default(0) // Current step number
  nextSendAt        DateTime? // When to send next email

  // Engagement tracking
  totalOpened   Int       @default(0)
  totalClicked  Int       @default(0)
  totalReplied  Int       @default(0)
  lastEngagedAt DateTime?

  // A/B Testing
  abTestGroup String? // A or B

  // Status tracking
  enrolledAt     DateTime  @default(now())
  completedAt    DateTime?
  unsubscribedAt DateTime?
  bouncedAt      DateTime?
  pausedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign EmailDripCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages EmailDripMessage[]

  @@unique([campaignId, leadId])
  @@index([campaignId])
  @@index([leadId])
  @@index([status])
  @@index([nextSendAt])
}

// EmailDripMessage: Track individual sent emails
model EmailDripMessage {
  id           String @id @default(cuid())
  enrollmentId String
  sequenceId   String

  // Recipient info
  recipientEmail String
  recipientName  String?

  // Message content (snapshot at send time)
  subject     String
  htmlContent String
  textContent String?

  // Delivery tracking
  status         EmailDripMessageStatus @default(PENDING)
  scheduledFor   DateTime
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  firstOpenedAt  DateTime?
  clickedAt      DateTime?
  firstClickedAt DateTime?
  repliedAt      DateTime?
  bouncedAt      DateTime?
  unsubscribedAt DateTime?

  // Tracking data
  openCount    Int   @default(0)
  clickCount   Int   @default(0)
  clickedLinks Json? // Array of clicked links

  // Provider data
  emailProvider     String? // gmail, sendgrid, etc.
  providerMessageId String?
  errorMessage      String?

  // Tracking pixels/links
  trackingId String @unique @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollment EmailDripEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  sequence   EmailDripSequence   @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([sequenceId])
  @@index([status])
  @@index([scheduledFor])
  @@index([recipientEmail])
  @@index([trackingId])
}

// Enums for Email Drip Campaign System
enum EmailDripCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum DripTriggerType {
  MANUAL // Manually enroll leads
  LEAD_CREATED // Trigger when new lead is created
  LEAD_STATUS // Trigger when lead status changes
  TAG_ADDED // Trigger when tag is added
  FORM_SUBMITTED // Trigger when form is submitted
  LIST_ADDED // Trigger when added to list
  SCHEDULED // Trigger on specific date/time
  REFERRAL_CREATED // Trigger when a referral is created (enrolls referrer lead)
  REFERRAL_CONVERTED // Trigger when a referral is converted to lead (enrolls new lead)
  SERVICE_COMPLETED // Trigger when appointment/service is completed (enrolls client lead)
  FEEDBACK_POSITIVE // Trigger when feedback is positive (rating >= 4) - for referral ask flow
}

enum DripEnrollmentStatus {
  ACTIVE // Currently enrolled and receiving emails
  COMPLETED // Finished all sequences
  PAUSED // Temporarily paused
  UNSUBSCRIBED // Unsubscribed from campaign
  BOUNCED // Email bounced
  FAILED // Failed to send
}

enum EmailDripMessageStatus {
  PENDING // Scheduled but not sent
  SENDING // Currently sending
  SENT // Successfully sent
  DELIVERED // Confirmed delivered
  OPENED // Recipient opened email
  CLICKED // Recipient clicked link
  REPLIED // Recipient replied
  BOUNCED // Email bounced
  FAILED // Failed to send
  UNSUBSCRIBED // Recipient unsubscribed
}

// Lead Blacklist for data validation
model LeadBlacklist {
  id        String   @id @default(cuid())
  userId    String
  email     String?
  phone     String?
  reason    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("LeadBlacklists", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([phone])
  @@index([isActive])
}

// A/B Testing Framework
model ABTest {
  id          String          @id @default(cuid())
  userId      String
  name        String
  testType    String // email_subject, email_body, sms_template, voice_script
  status      String          @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED
  winnerId    String?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation("ABTests", fields: [userId], references: [id], onDelete: Cascade)
  variants    ABTestVariant[]
  winner      ABTestVariant?  @relation("ABTestWinner", fields: [winnerId], references: [id])

  @@index([userId])
  @@index([status])
}

model ABTestVariant {
  id           String   @id @default(cuid())
  testId       String
  name         String
  content      String
  variantIndex Int
  sendCount    Int      @default(0)
  successCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  test         ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)
  wonTests     ABTest[] @relation("ABTestWinner")

  @@index([testId])
}

// Social Media Platform Settings (Meta/Facebook/Instagram/WhatsApp)
model SocialMediaSettings {
  id        String   @id @default(cuid())
  userId    String
  platform  String // META, TWITTER, LINKEDIN, etc.
  appId     String // Platform App ID
  appSecret String // Platform App Secret
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("SocialMediaSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
}

// 
// AI EMPLOYEE SYSTEM
// 

enum AIEmployeeType {
  LEAD_RESEARCHER // Researches and enriches lead data
  CUSTOMER_ONBOARDING // Handles customer onboarding, invoices, emails
  BOOKING_COORDINATOR // Manages calendar and booking automation
  PROJECT_MANAGER // Creates projects, assigns teams
  COMMUNICATION_SPECIALIST // Sends welcome packages, follow-ups
}

enum AIJobStatus {
  PENDING // Job queued, waiting to start
  RUNNING // Currently executing
  COMPLETED // Successfully completed
  FAILED // Failed with error
  CANCELLED // Manually cancelled
  PAUSED // Temporarily paused
}

enum AIJobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// UserAIEmployee - "Your AI Team" user-configured employees (Accountant, Developer, etc.)
// Used in workflow builder for assignable agents; persists to DB for Phase 1 integration
// voiceConfig: per-call overrides { voiceId?, language?, stability?, speed?, similarityBoost? } for ElevenLabs
model UserAIEmployee {
  id           String   @id @default(cuid())
  userId       String
  profession   String // e.g. "accountant", "developer", "virtual_receptionist"
  customName   String
  voiceAgentId String?
  voiceConfig  Json? // Per-call overrides: { voiceId, language, stability, speed, similarityBoost }
  isActive     Boolean  @default(true)
  capabilities Json? // Optional: { voice: true, email: true } for future task-type filtering
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation("UserAIEmployees", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([profession])
}

// AI Employee - represents different types of AI workers (backend workflow orchestrator)
model AIEmployee {
  id           String         @id @default(cuid())
  userId       String
  name         String // e.g., "Sarah - Lead Researcher"
  type         AIEmployeeType
  description  String?
  isActive     Boolean        @default(true)
  capabilities Json // Stores specific capabilities and settings
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation("AIEmployees", fields: [userId], references: [id], onDelete: Cascade)
  jobs         AIJob[]

  @@index([userId])
  @@index([type])
  @@index([isActive])
}

// AI Job - represents a task assigned to an AI employee
model AIJob {
  id            String        @id @default(cuid())
  userId        String
  employeeId    String
  workflowId    String? // Links multiple jobs in a workflow
  jobType       String // lead_enrichment, invoice_generation, etc.
  priority      AIJobPriority @default(MEDIUM)
  status        AIJobStatus   @default(PENDING)
  input         Json // Input data for the job
  output        Json? // Result/output data
  error         String? // Error message if failed
  progress      Int           @default(0) // 0-100
  startedAt     DateTime?
  completedAt   DateTime?
  estimatedTime Int? // Estimated seconds to complete
  actualTime    Int? // Actual seconds taken
  retryCount    Int           @default(0)
  maxRetries    Int           @default(3)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation("AIJobs", fields: [userId], references: [id], onDelete: Cascade)
  employee      AIEmployee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  logs          AIJobLog[]

  @@index([userId])
  @@index([employeeId])
  @@index([workflowId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// AI Job Log - detailed execution logs
model AIJobLog {
  id        String   @id @default(cuid())
  jobId     String
  level     String // INFO, WARNING, ERROR, SUCCESS
  message   String
  data      Json? // Additional structured data
  createdAt DateTime @default(now())
  job       AIJob    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([createdAt])
}

// ==========================================
// AI DOCPEN - Ambient Medical Scribe System
// ==========================================

enum DocpenProfession {
  GENERAL_PRACTICE
  DENTIST
  ORTHODONTIC
  OPTOMETRIST
  DERMATOLOGIST
  CARDIOLOGIST
  PSYCHIATRIST
  PEDIATRICIAN
  ORTHOPEDIC
  PHYSIOTHERAPIST
  CHIROPRACTOR
  CUSTOM
}

enum DocpenSessionStatus {
  RECORDING
  PROCESSING
  REVIEW_PENDING
  SIGNED
  ARCHIVED
  CANCELLED
}

enum DocpenSpeakerRole {
  PRACTITIONER
  PATIENT
  OTHER
}

enum DocpenSOAPType {
  STANDARD_SOAP
  FOCUSED_SOAP
  PROGRESS_NOTE
  CONSULTATION_NOTE
  PROCEDURE_NOTE
  FOLLOW_UP_NOTE
}

// Main session/consultation record
model DocpenSession {
  id               String              @id @default(cuid())
  userId           String
  leadId           String? // Link to CRM Client Record
  patientName      String? // For quick reference
  profession       DocpenProfession    @default(GENERAL_PRACTICE)
  customProfession String? // If CUSTOM selected
  status           DocpenSessionStatus @default(RECORDING)

  // Session metadata
  sessionDate     DateTime @default(now())
  sessionDuration Int? // Duration in seconds
  chiefComplaint  String? // Initial reason for visit
  consultantName  String? // Name of consultant signing off on notes approval

  // Audio storage (encrypted reference)
  audioStoragePath String? // S3 path for encrypted audio
  audioRetained    Boolean   @default(false) // HIPAA: track if retained
  retentionExpiry  DateTime? // When audio will be deleted

  // Processing status
  transcriptionComplete Boolean @default(false)
  soapNoteGenerated     Boolean @default(false)

  // Signing workflow
  reviewedAt    DateTime?
  signedAt      DateTime?
  signedBy      String? // Name of signing practitioner
  signatureHash String? // Digital signature verification

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead             Lead?                  @relation(fields: [leadId], references: [id], onDelete: SetNull)
  transcriptions   DocpenTranscription[]
  soapNotes        DocpenSOAPNote[]
  assistantQueries DocpenAssistantQuery[]
  auditLogs        DocpenSessionAuditLog[]

  @@index([userId])
  @@index([leadId])
  @@index([status])
  @@index([sessionDate])
}

// Audit log for Docpen workflow (review  sign  export)
model DocpenSessionAuditLog {
  id        String   @id @default(cuid())
  sessionId String
  event     String   // session_created, recording_started, soap_generated, reviewed, signed, exported
  metadata  Json?    // { exportedMethod?: "copy"|"pdf"|"webhook", ... }
  createdAt DateTime @default(now())

  session DocpenSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([event])
}

// Individual transcription segments with speaker identification
model DocpenTranscription {
  id        String @id @default(cuid())
  sessionId String

  // Speaker diarization
  speakerRole  DocpenSpeakerRole
  speakerLabel String? // "Dr. Smith", "Patient", etc.

  // Transcription content
  content    String // The spoken text
  startTime  Float // Start time in seconds
  endTime    Float // End time in seconds
  confidence Float? // STT confidence score

  // Processing flags
  isEdited        Boolean @default(false)
  originalContent String? // Store original if edited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session DocpenSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([speakerRole])
}

// Generated SOAP Notes
model DocpenSOAPNote {
  id        String @id @default(cuid())
  sessionId String
  version   Int    @default(1)

  // SOAP Type
  soapType DocpenSOAPType @default(STANDARD_SOAP) // Type of SOAP note

  // SOAP Format
  subjective String? @db.Text // Patient's complaints, history
  objective  String? @db.Text // Exam findings, measurements
  assessment String? @db.Text // Diagnosis, clinical impression
  plan       String? @db.Text // Treatment plan, follow-up

  // Additional sections based on profession
  additionalNotes String? @db.Text // ICD-10 codes, dental charting, etc.

  // AI Processing metadata
  aiModel        String? // GPT-4o, etc.
  processingTime Int? // Processing time in ms
  promptVersion  String? // Track prompt version used

  // Review workflow
  isCurrentVersion Boolean @default(true)
  editedByUser     Boolean @default(false)

  // DICOM auto-link: X-rays matched by tooth numbers in SOAP
  linkedXrayIds String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session DocpenSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([isCurrentVersion])
  @@index([soapType])
}

// Active Assistant queries during session
model DocpenAssistantQuery {
  id        String @id @default(cuid())
  sessionId String

  // Query details
  queryType    String // "patient_history", "drug_interaction", "medical_lookup", "feedback"
  queryText    String // The user's question
  responseText String? @db.Text // AI response

  // Context
  triggerMethod String? // "voice", "text", "wake_word"
  timestamp     Float? // When during session (seconds)

  // Sources/References
  sourcesCited Json? // Array of sources used in response

  createdAt DateTime @default(now())

  session DocpenSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([queryType])
}

// Docpen Voice Agent tracking (per user, per profession)
model DocpenVoiceAgent {
  id               String           @id @default(cuid())
  userId           String
  profession       DocpenProfession
  customProfession String? // If CUSTOM selected

  // ElevenLabs configuration
  elevenLabsAgentId String  @unique
  voiceId           String? // ElevenLabs voice ID used
  voiceName         String? // Human-readable voice name
  systemPrompt      String? @db.Text

  // Language & Voice Settings
  language        String  @default("en") // ISO 639-1 code
  languageName    String? @default("English")
  voiceGender     String? @default("neutral") // male, female, neutral
  stability       Float?  @default(0.6)
  similarityBoost Float?  @default(0.8)

  // Status
  isActive          Boolean   @default(true)
  lastUsedAt        DateTime?
  conversationCount Int       @default(0)
  totalDurationSec  Int       @default(0) // Total conversation time

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user               User                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations      DocpenConversation[]
  knowledgeBaseFiles DocpenAgentKnowledgeBaseFile[]

  @@unique([userId, profession, customProfession])
  @@index([userId])
  @@index([profession])
  @@index([elevenLabsAgentId])
}

// Docpen Conversation History (synced from ElevenLabs)
model DocpenConversation {
  id               String @id @default(cuid())
  agentId          String
  elevenLabsConvId String @unique // ElevenLabs conversation_id

  // Session info
  sessionId   String? // Link to DocpenSession if applicable
  patientName String?

  // Conversation data
  status      String    @default("completed") // active, completed, error
  startedAt   DateTime
  endedAt     DateTime?
  durationSec Int?

  // Audio & Transcript
  audioUrl   String? @db.Text // Recording URL from ElevenLabs
  transcript String? @db.Text // Full transcript JSON
  summary    String? @db.Text // AI-generated summary

  // Metadata
  messageCount Int @default(0)
  turnCount    Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agent DocpenVoiceAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([sessionId])
  @@index([startedAt])
}

// Docpen Knowledge Base Files
model DocpenKnowledgeBaseFile {
  id     String @id @default(cuid())
  userId String

  // File info
  fileName         String
  fileType         String // MIME type
  fileSize         Int // bytes
  cloudStoragePath String? // S3 path

  // Content
  extractedText String? @db.Text

  // Specialty categorization
  specialty       DocpenProfession?
  customSpecialty String?
  tags            String[]          @default([])

  // ElevenLabs sync
  elevenLabsDocId String? // If uploaded to ElevenLabs knowledge base

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  agents DocpenAgentKnowledgeBaseFile[]

  @@index([userId])
  @@index([specialty])
}

// Junction table for Docpen Agent <-> Knowledge Base Files (many-to-many)
model DocpenAgentKnowledgeBaseFile {
  id      String   @id @default(cuid())
  agentId String
  fileId  String
  addedAt DateTime @default(now())

  agent             DocpenVoiceAgent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  knowledgeBaseFile DocpenKnowledgeBaseFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([agentId, fileId])
  @@index([agentId])
  @@index([fileId])
}

// ==========================================
// REAL ESTATE INDUSTRY ENUMS
// ==========================================

enum REPropertyType {
  SINGLE_FAMILY
  CONDO
  TOWNHOUSE
  MULTI_FAMILY
  LAND
  COMMERCIAL
  MOBILE_HOME
  OTHER
}

enum REListingStatus {
  ACTIVE
  PENDING
  SOLD
  WITHDRAWN
  EXPIRED
  COMING_SOON
}

enum REFSBOSource {
  DUPROPRIO
  PURPLEBRICKS
  FSBO_COM
  CRAIGSLIST
  FACEBOOK_MARKETPLACE
  KIJIJI
  ZILLOW_FSBO
  MANUAL_IMPORT
  OTHER
}

enum REFSBOStatus {
  NEW
  CONTACTED
  FOLLOW_UP
  NOT_INTERESTED
  CONVERTED
  DO_NOT_CONTACT
  INVALID
}

enum REDNCSource {
  NATIONAL_REGISTRY
  STATE_REGISTRY
  MANUAL_ADD
  OPT_OUT
  COMPLAINT
}

enum REPeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum REReportType {
  WEEKLY_MARKET_UPDATE
  MONTHLY_MARKET_REPORT
  QUARTERLY_ANALYSIS
  CUSTOM
}

enum REDiagnosticStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED
}

enum RETransactionType {
  PURCHASE
  SALE
  LEASE
  DUAL_AGENCY
}

enum RERepresentingSide {
  BUYER
  SELLER
  DUAL
  LANDLORD
  TENANT
}

enum RETransactionStage {
  OFFER_SUBMITTED
  OFFER_ACCEPTED
  INSPECTION_PERIOD
  FINANCING_CONTINGENCY
  APPRAISAL
  FINAL_WALKTHROUGH
  CLOSING_SCHEDULED
  CLOSED
  TERMINATED
}

enum REExpiredStatus {
  NEW
  CONTACTED
  FOLLOW_UP
  NOT_INTERESTED
  RELISTED
  CONVERTED
}

enum REAIEmployeeType {
  RE_SPEED_TO_LEAD
  RE_FSBO_OUTREACH
  RE_EXPIRED_OUTREACH
  RE_COLD_REACTIVATION
  RE_DOCUMENT_CHASER
  RE_SHOWING_CONFIRM
  RE_SPHERE_NURTURE
  RE_BUYER_FOLLOWUP
  RE_MARKET_UPDATE
  RE_STALE_DIAGNOSTIC
  RE_LISTING_BOOST
  RE_CMA_GENERATOR
}

// ==========================================
// REAL ESTATE INDUSTRY MODELS
// ==========================================

model REProperty {
  id             String          @id @default(cuid())
  userId         String
  address        String
  unit           String?
  city           String
  state          String
  zip            String
  country        String          @default("US")
  beds           Int?
  baths          Float?
  sqft           Int?
  lotSize        Int?
  yearBuilt      Int?
  propertyType   REPropertyType  @default(SINGLE_FAMILY)
  listingStatus  REListingStatus @default(ACTIVE)
  listPrice      Float?
  soldPrice      Float?
  mlsNumber      String?
  daysOnMarket   Int             @default(0)
  photos         Json?
  virtualTourUrl String?
  description    String?
  features       String[]        @default([])
  sellerLeadId   String?
  listingDate    DateTime?
  soldDate       DateTime?
  expirationDate DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  user          User                    @relation("REUserProperties", fields: [userId], references: [id], onDelete: Cascade)
  sellerLead    Lead?                   @relation("REPropertySeller", fields: [sellerLeadId], references: [id])
  cmaReports    RECMAReport[]
  comps         REComparable[]
  presentations REListingPresentation[]
  netSheets     RESellerNetSheet[]
  diagnostics   REStaleDiagnostic[]
  transactions  RETransaction[]

  @@index([userId])
  @@index([city, state])
  @@index([listingStatus])
  @@index([mlsNumber])
}

model REFSBOListing {
  id              String       @id @default(cuid())
  source          REFSBOSource
  sourceUrl       String       @unique
  sourceListingId String?
  address         String
  city            String
  state           String
  zip             String?
  country         String       @default("CA")
  listPrice       Float?
  beds            Int?
  baths           Float?
  sqft            Int?
  lotSize         Int?
  yearBuilt       Int?
  propertyType    String?
  daysOnMarket    Int          @default(0)
  firstSeenAt     DateTime     @default(now())
  lastSeenAt      DateTime     @default(now())
  priceHistory    Json?
  sellerName      String?
  sellerPhone     String?
  sellerEmail     String?
  photos          Json?
  description     String?
  status          REFSBOStatus @default(NEW)
  assignedUserId  String?
  lastContactedAt DateTime?
  contactAttempts Int          @default(0)
  notes           String?
  convertedLeadId String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  assignedUser  User? @relation("REFSBOAssignedUser", fields: [assignedUserId], references: [id])
  convertedLead Lead? @relation("REFSBOConvertedLead", fields: [convertedLeadId], references: [id])

  @@index([source])
  @@index([city, state])
  @@index([status])
  @@index([assignedUserId])
  @@index([daysOnMarket])
}

model REDNCEntry {
  id          String      @id @default(cuid())
  phoneNumber String      @unique
  source      REDNCSource
  reason      String?
  country     String      @default("US")
  addedAt     DateTime    @default(now())
  expiresAt   DateTime?

  @@index([phoneNumber])
  @@index([country])
}

model REScrapingJob {
  id                 String        @id @default(cuid())
  userId             String
  name               String        @default("FSBO Scraping Job")
  source             REFSBOSource?
  sources            String[]      @default([])
  targetCity         String?
  targetRegion       String?
  targetCities       String[]      @default([])
  targetStates       String[]      @default([])
  targetZips         String[]      @default([])
  targetZipCodes     String[]      @default([])
  country            String        @default("CA")
  propertyTypes      String[]      @default([])
  minPrice           Int?
  maxPrice           Int?
  maxListingsPerRun  Int           @default(100)
  frequency          String        @default("weekly")
  isActive           Boolean       @default(true)
  status             String        @default("IDLE")
  mlsCredentials     Json?
  lastRunAt          DateTime?
  nextRunAt          DateTime?
  lastRunStatus      String?
  totalScraped       Int           @default(0)
  totalListingsFound Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  user User @relation("REScrapingJobUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model REMarketStats {
  id              String       @id @default(cuid())
  userId          String
  periodStart     DateTime
  periodEnd       DateTime
  periodType      REPeriodType @default(WEEKLY)
  region          String
  city            String?
  state           String?
  country         String       @default("US")
  medianSalePrice Float?
  avgSalePrice    Float?
  domMedian       Int?
  domAvg          Float?
  newListings     Int?
  closedSales     Int?
  activeInventory Int?
  monthsOfSupply  Float?
  listToSaleRatio Float?
  priceReductions Int?
  source          String?
  rawData         Json?
  createdAt       DateTime     @default(now())

  // Relations
  user User @relation("REMarketStatsUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([region])
  @@index([periodStart, periodEnd])
}

model REMarketReport {
  id               String       @id @default(cuid())
  userId           String
  type             REReportType
  title            String
  region           String
  periodStart      DateTime
  periodEnd        DateTime
  executiveSummary String?
  keyHighlights    Json?
  buyerInsights    String?
  sellerInsights   String?
  predictions      Json?
  socialCaption    String?
  pdfUrl           String?
  slidesUrl        String?
  sentTo           Json?
  sentAt           DateTime?
  createdAt        DateTime     @default(now())

  // Relations
  user User @relation("REMarketReportUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([periodStart])
}

model REStaleDiagnostic {
  id               String             @id @default(cuid())
  userId           String
  propertyId       String?
  fsboListingId    String?
  address          String
  listPrice        Float?
  daysOnMarket     Int
  analysisJson     Json
  topReasons       Json
  actionPlan       Json
  clientSummary    String?
  agentNotes       String?
  sellerEmailDraft String?
  callScript       String?
  pdfUrl           String?
  status           REDiagnosticStatus @default(PENDING)
  reviewedAt       DateTime?
  actionedAt       DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // Relations
  user     User        @relation("REStaleDiagnosticUser", fields: [userId], references: [id], onDelete: Cascade)
  property REProperty? @relation(fields: [propertyId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([daysOnMarket])
}

model REListingPresentation {
  id              String    @id @default(cuid())
  userId          String
  propertyId      String?
  address         String
  sellerName      String?
  sellerGoals     String?
  timeline        String?
  concerns        String?
  pricingStrategy Json?
  marketingPlan   Json?
  compsAnalysis   Json?
  objectionsFAQ   Json?
  timelinePhases  Json?
  pdfUrl          String?
  slidesUrl       String?
  status          String    @default("draft")
  presentedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user     User        @relation("REListingPresentationUser", fields: [userId], references: [id], onDelete: Cascade)
  property REProperty? @relation(fields: [propertyId], references: [id])

  @@index([userId])
}

model RESellerNetSheet {
  id               String   @id @default(cuid())
  userId           String
  propertyId       String?
  address          String
  salePrice        Float
  mortgagePayoff   Float?
  commissionRate   Float    @default(5.0)
  commissionAmount Float?
  listingAgentComm Float?
  buyerAgentComm   Float?
  closingCosts     Float?
  titleInsurance   Float?
  transferTax      Float?
  repairs          Float?
  stagingCosts     Float?
  otherCosts       Float?
  estimatedNet     Float?
  pdfUrl           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user     User        @relation("RESellerNetSheetUser", fields: [userId], references: [id], onDelete: Cascade)
  property REProperty? @relation(fields: [propertyId], references: [id])

  @@index([userId])
}

model RECMAReport {
  id                String   @id @default(cuid())
  userId            String
  propertyId        String?
  address           String
  beds              Int?
  baths             Float?
  sqft              Int?
  yearBuilt         Int?
  comparables       Json
  adjustments       Json
  suggestedPriceMin Float?
  suggestedPriceMax Float?
  suggestedPrice    Float?
  pricePerSqft      Float?
  pdfUrl            String?
  fullPdfUrl        String?
  createdAt         DateTime @default(now())

  // Relations
  user     User        @relation("RECMAReportUser", fields: [userId], references: [id], onDelete: Cascade)
  property REProperty? @relation(fields: [propertyId], references: [id])

  @@index([userId])
}

model REComparable {
  id             String    @id @default(cuid())
  propertyId     String
  status         String
  address        String?
  distance       Float?
  salePrice      Float?
  listPrice      Float?
  closeDate      DateTime?
  daysOnMarket   Int?
  beds           Int?
  baths          Float?
  sqft           Int?
  yearBuilt      Int?
  lotSize        Int?
  adjustedPrice  Float?
  adjustments    Json?
  features       String[]  @default([])
  conditionScore Int?
  notes          String?
  createdAt      DateTime  @default(now())

  // Relations
  property REProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

model RETransaction {
  id               String             @id @default(cuid())
  userId           String
  propertyId       String?
  leadId           String?
  transactionType  RETransactionType
  representingSide RERepresentingSide
  address          String
  offerPrice       Float?
  salePrice        Float?
  listPrice        Float?
  commissionRate   Float?
  commissionAmount Float?
  commissionSplit  Json?
  contractDate     DateTime?
  closingDate      DateTime?
  possessionDate   DateTime?
  stage            RETransactionStage @default(OFFER_SUBMITTED)
  vendorContacts   Json?
  notes            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // Relations
  user       User                    @relation("RETransactionUser", fields: [userId], references: [id], onDelete: Cascade)
  property   REProperty?             @relation(fields: [propertyId], references: [id])
  lead       Lead?                   @relation("RETransactionLead", fields: [leadId], references: [id])
  activities RETransactionActivity[]
  tasks      RETransactionTask[]

  @@index([userId])
  @@index([stage])
  @@index([closingDate])
}

model RETransactionActivity {
  id            String   @id @default(cuid())
  transactionId String
  type          String
  description   String
  metadata      Json?
  createdAt     DateTime @default(now())

  // Relations
  transaction RETransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
}

model RETransactionTask {
  id            String              @id @default(cuid())
  transactionId String
  title         String
  description   String?
  dueDate       DateTime?
  stage         RETransactionStage?
  isCompleted   Boolean             @default(false)
  completedAt   DateTime?
  assignedTo    String?
  createdAt     DateTime            @default(now())

  // Relations
  transaction RETransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([dueDate])
}

model REBuyerCriteria {
  id                  String           @id @default(cuid())
  leadId              String           @unique
  userId              String
  minPrice            Float?
  maxPrice            Float?
  minBeds             Int?
  maxBeds             Int?
  minBaths            Float?
  minSqft             Int?
  maxSqft             Int?
  targetCities        String[]         @default([])
  targetZips          String[]         @default([])
  targetNeighborhoods String[]         @default([])
  propertyTypes       REPropertyType[]
  mustHaves           String[]         @default([])
  dealBreakers        String[]         @default([])
  notes               String?
  isPreApproved       Boolean          @default(false)
  preApprovalAmount   Float?
  lenderName          String?
  timeline            String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  user User @relation("REBuyerCriteriaUser", fields: [userId], references: [id], onDelete: Cascade)
  lead Lead @relation("REBuyerCriteriaLead", fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model REExpiredListing {
  id                String          @id @default(cuid())
  source            String
  sourceId          String?
  address           String
  city              String
  state             String
  zip               String?
  originalListPrice Float?
  finalListPrice    Float?
  daysOnMarket      Int?
  expiredDate       DateTime?
  previousAgentName String?
  previousBrokerage String?
  ownerName         String?
  ownerPhone        String?
  ownerEmail        String?
  status            REExpiredStatus @default(NEW)
  assignedUserId    String?
  lastContactedAt   DateTime?
  contactAttempts   Int             @default(0)
  notes             String?
  convertedLeadId   String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  assignedUser  User? @relation("REExpiredAssignedUser", fields: [assignedUserId], references: [id])
  convertedLead Lead? @relation("REExpiredConvertedLead", fields: [convertedLeadId], references: [id])

  @@index([status])
  @@index([assignedUserId])
  @@index([expiredDate])
}

model REAIEmployeeExecution {
  id           String           @id @default(cuid())
  userId       String
  employeeType REAIEmployeeType
  employeeName String?
  targetType   String?
  targetId     String?
  status       String           @default("pending")
  startedAt    DateTime?
  completedAt  DateTime?
  result       Json?
  error        String?
  callMade     Boolean          @default(false)
  smsSent      Boolean          @default(false)
  emailSent    Boolean          @default(false)
  taskCreated  Boolean          @default(false)
  createdAt    DateTime         @default(now())

  // Relations
  user User @relation("REAIEmployeeExecutionUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeType])
  @@index([status])
  @@index([createdAt])
}

// Real Estate AI Employee Voice Agents
// Maps RE AI Employee types to their ElevenLabs agent instances per user
model REAIEmployeeAgent {
  id                String           @id @default(cuid())
  userId            String
  employeeType      REAIEmployeeType
  name              String
  elevenLabsAgentId String
  twilioPhoneNumber String?
  voiceId           String?
  status            String           @default("active")
  lastUsedAt        DateTime?
  callCount         Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  user User @relation("REAIEmployeeAgentUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, employeeType])
  @@index([userId])
  @@index([employeeType])
  @@index([elevenLabsAgentId])
}

// Industry AI Employee Voice Agents (Dental, Medical, Restaurant, etc.)
// Generic model for non-RE industries - RE uses REAIEmployeeAgent
model IndustryAIEmployeeAgent {
  id                String    @id @default(cuid())
  userId            String
  industry          Industry
  employeeType      String // e.g. DENTIST: "APPOINTMENT_SCHEDULER", MEDICAL: "PATIENT_COORDINATOR"
  name              String
  elevenLabsAgentId String
  twilioPhoneNumber String?
  voiceId           String?
  status            String    @default("active")
  lastUsedAt        DateTime?
  callCount         Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation("IndustryAIEmployeeAgentUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, industry, employeeType])
  @@index([userId])
  @@index([industry])
  @@index([elevenLabsAgentId])
}

// ==========================================
// WHITE-LABEL VOICE AI PLATFORM ENUMS
// ==========================================

enum VoiceAISubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum VoiceAICallDirection {
  INBOUND
  OUTBOUND
}

enum VoiceAICallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  CANCELLED
}

enum VoiceAIBillingStatus {
  PENDING
  INVOICED
  PAID
  OVERDUE
  CANCELLED
}

// ==========================================
// WHITE-LABEL VOICE AI PLATFORM MODELS
// ==========================================

// Platform-level Voice AI configuration (admin only)
// Stores the master ElevenLabs API key and global settings
model PlatformVoiceAIConfig {
  id                  String   @id @default(cuid())
  masterElevenLabsKey String // Encrypted master API key
  masterTwilioSid     String? // Optional: Master Twilio Account SID
  masterTwilioToken   String? // Optional: Master Twilio Auth Token
  defaultPricePerMin  Decimal  @default(0.50) @db.Decimal(10, 4)
  defaultOverageRate  Decimal  @default(0.75) @db.Decimal(10, 4)
  totalMonthlyQuota   Int      @default(2000) // Your ElevenLabs plan limit
  usedThisMonth       Int      @default(0) // Total used by all agencies
  billingCycleStart   DateTime @default(now())
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([isActive])
}

// Per-agency Voice AI subscription and quota management
model VoiceAISubscription {
  id                   String                  @id @default(cuid())
  userId               String                  @unique
  tier                 VoiceAISubscriptionTier @default(STARTER)
  monthlyMinutesQuota  Int                     @default(100)
  pricePerMinute       Decimal                 @default(0.50) @db.Decimal(10, 4)
  minutesUsedThisMonth Int                     @default(0)
  overageAllowed       Boolean                 @default(false)
  overageRate          Decimal                 @default(0.75) @db.Decimal(10, 4)
  billingCycleStart    DateTime                @default(now())
  isActive             Boolean                 @default(true)
  agentPrefix          String? // Unique prefix for this agency's agents in ElevenLabs
  notes                String? // Admin notes
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  // Relations
  user           User                   @relation("VoiceAISubscriptionUser", fields: [userId], references: [id], onDelete: Cascade)
  usageLogs      VoiceAIUsageLog[]      @relation("VoiceAISubscriptionUsage")
  billingRecords VoiceAIBillingRecord[] @relation("VoiceAISubscriptionBilling")

  @@index([userId])
  @@index([tier])
  @@index([isActive])
}

// Tracks every Voice AI call for usage and billing
model VoiceAIUsageLog {
  id                String               @id @default(cuid())
  userId            String
  subscriptionId    String?
  agentId           String? // VoiceAgent or REAIEmployeeAgent ID
  elevenLabsAgentId String? // ElevenLabs agent ID
  elevenLabsCallId  String? // ElevenLabs call ID
  direction         VoiceAICallDirection @default(OUTBOUND)
  durationSeconds   Int                  @default(0)
  durationMinutes   Decimal              @default(0) @db.Decimal(10, 2) // Rounded up for billing
  cost              Decimal              @default(0) @db.Decimal(10, 4) // minutes  rate
  callerNumber      String?
  recipientNumber   String?
  status            VoiceAICallStatus    @default(INITIATED)
  recordingUrl      String?
  transcriptUrl     String?
  metadata          Json? // Extra data from ElevenLabs
  errorMessage      String?
  createdAt         DateTime             @default(now())

  // Relations
  user         User                 @relation("VoiceAIUsageLogUser", fields: [userId], references: [id], onDelete: Cascade)
  subscription VoiceAISubscription? @relation("VoiceAISubscriptionUsage", fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([agentId])
  @@index([elevenLabsCallId])
  @@index([status])
  @@index([createdAt])
}

// Monthly billing records per agency
model VoiceAIBillingRecord {
  id                 String               @id @default(cuid())
  userId             String
  subscriptionId     String?
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  totalMinutesUsed   Int                  @default(0)
  quotaMinutes       Int                  @default(0)
  overageMinutes     Int                  @default(0)
  baseCost           Decimal              @default(0) @db.Decimal(10, 2)
  overageCost        Decimal              @default(0) @db.Decimal(10, 2)
  totalCost          Decimal              @default(0) @db.Decimal(10, 2)
  status             VoiceAIBillingStatus @default(PENDING)
  invoiceNumber      String?              @unique
  paidAt             DateTime?
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  // Relations
  user         User                 @relation("VoiceAIBillingRecordUser", fields: [userId], references: [id], onDelete: Cascade)
  subscription VoiceAISubscription? @relation("VoiceAISubscriptionBilling", fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([billingPeriodStart])
  @@index([createdAt])
}

// ==========================================
// REAL ESTATE WORKFLOW AUTOMATION SYSTEM
// ==========================================

enum REWorkflowType {
  BUYER
  SELLER
  CUSTOM
}

enum RETaskType {
  QUALIFICATION
  MLS_SEARCH
  SHOWING_SCHEDULE
  SHOWING_FEEDBACK
  OFFER_PREP
  OFFER_SUBMIT
  CONDITION_TRACKING
  CLOSING_COORDINATION
  POST_CLOSE_FOLLOWUP
  CMA_GENERATION
  LISTING_PREP
  PHOTO_SCHEDULING
  MARKETING_DRAFT
  LISTING_PUBLISH
  CUSTOM
}

enum REWorkflowInstanceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum RETaskExecutionStatus {
  PENDING
  IN_PROGRESS
  AWAITING_HITL
  APPROVED
  REJECTED
  COMPLETED
  FAILED
  SKIPPED
}

// RE Workflow Template - defines a buyer/seller pipeline
model REWorkflowTemplate {
  id          String         @id @default(cuid())
  userId      String
  name        String
  type        REWorkflowType
  description String?
  isDefault   Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  user      User                 @relation("UserREWorkflowTemplates", fields: [userId], references: [id], onDelete: Cascade)
  tasks     REWorkflowTask[]     @relation("REWorkflowTemplateTasks")
  instances REWorkflowInstance[] @relation("REWorkflowTemplateInstances")

  @@index([userId])
  @@index([type])
  @@index([isDefault])
}

// RE Workflow Task - a single task/step in the workflow
model REWorkflowTask {
  id                String            @id @default(cuid())
  templateId        String
  name              String
  description       String?
  taskType          RETaskType
  assignedAgentType REAIEmployeeType?
  delayValue        Int               @default(0)
  delayUnit         String            @default("MINUTES") // MINUTES, HOURS, DAYS
  isHITL            Boolean           @default(false)
  isOptional        Boolean           @default(false)
  position          Json // {angle: 45, radius: 1, x: 0, y: 0} for circular UI
  displayOrder      Int
  parentTaskId      String?
  branchCondition   Json? // {field: "feedback", operator: "equals", value: "liked"}
  actionConfig      Json // {actions: ["voice_call", "sms"], script: "...", etc}
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  template   REWorkflowTemplate @relation("REWorkflowTemplateTasks", fields: [templateId], references: [id], onDelete: Cascade)
  parentTask REWorkflowTask?    @relation("RETaskBranches", fields: [parentTaskId], references: [id])
  childTasks REWorkflowTask[]   @relation("RETaskBranches")
  executions RETaskExecution[]  @relation("RETaskExecutions")

  @@index([templateId])
  @@index([parentTaskId])
  @@index([displayOrder])
}

// RE Workflow Instance - a running instance of a workflow for a specific lead/deal
model REWorkflowInstance {
  id            String                   @id @default(cuid())
  templateId    String
  userId        String
  leadId        String?
  dealId        String?
  status        REWorkflowInstanceStatus @default(ACTIVE)
  currentTaskId String?
  metadata      Json? // Buyer/Seller specific data collected
  startedAt     DateTime                 @default(now())
  completedAt   DateTime?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  // Relations
  template   REWorkflowTemplate @relation("REWorkflowTemplateInstances", fields: [templateId], references: [id])
  user       User               @relation("UserREWorkflowInstances", fields: [userId], references: [id], onDelete: Cascade)
  lead       Lead?              @relation("LeadREWorkflowInstances", fields: [leadId], references: [id])
  deal       Deal?              @relation("DealREWorkflowInstances", fields: [dealId], references: [id])
  executions RETaskExecution[]  @relation("REInstanceExecutions")

  @@index([templateId])
  @@index([userId])
  @@index([leadId])
  @@index([dealId])
  @@index([status])
}

// RE Task Execution - tracks execution of a single task within an instance
model RETaskExecution {
  id             String                @id @default(cuid())
  instanceId     String
  taskId         String
  status         RETaskExecutionStatus @default(PENDING)
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  agentUsed      REAIEmployeeType?
  callLogId      String? // Link to CallLog if voice call made
  result         Json? // Outcome data
  hitlApprovedBy String? // User who approved HITL
  hitlApprovedAt DateTime?
  hitlNotes      String?
  errorMessage   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  instance REWorkflowInstance @relation("REInstanceExecutions", fields: [instanceId], references: [id], onDelete: Cascade)
  task     REWorkflowTask     @relation("RETaskExecutions", fields: [taskId], references: [id])

  @@index([instanceId])
  @@index([taskId])
  @@index([status])
  @@index([scheduledFor])
}

// HITL Notification Queue - tracks pending human-in-the-loop approvals
model REHITLNotification {
  id          String   @id @default(cuid())
  userId      String
  executionId String   @unique
  taskName    String
  contactName String?
  dealAddress String?
  message     String
  urgency     String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  isRead      Boolean  @default(false)
  isActioned  Boolean  @default(false)
  smsSent     Boolean  @default(false)
  emailSent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation("UserREHITLNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActioned])
  @@index([createdAt])
}

// ==========================================
// GENERIC MULTI-INDUSTRY WORKFLOW ENUMS
// ==========================================

enum WorkflowType {
  CUSTOM
  TEMPLATE
}

enum WorkflowInstanceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum TaskExecutionStatus {
  PENDING
  IN_PROGRESS
  AWAITING_HITL
  APPROVED
  REJECTED
  COMPLETED
  FAILED
  SKIPPED
}

// ==========================================
// MEDICAL INDUSTRY ENUMS
// ==========================================

enum MedicalTaskType {
  LEAD_RESEARCH
  PATIENT_RESEARCH
  APPOINTMENT_BOOKING
  APPOINTMENT_REMINDER
  PRESCRIPTION_REMINDER
  TEST_RESULTS_NOTIFICATION
  REFERRAL_COORDINATION
  FOLLOW_UP_CALL
  PATIENT_ONBOARDING
  POST_VISIT_FOLLOWUP
  INSURANCE_VERIFICATION
  CUSTOM
}

enum MedicalAIEmployeeType {
  MEDICAL_APPOINTMENT_SCHEDULER
  PATIENT_COORDINATOR
  REFERRAL_SPECIALIST
  PRESCRIPTION_MANAGER
  INSURANCE_VERIFIER
  FOLLOW_UP_COORDINATOR
}

enum MedicalWorkflowType {
  PATIENT_ONBOARDING
  APPOINTMENT_REMINDER_SEQUENCE
  POST_VISIT_FOLLOWUP
  PRESCRIPTION_REFILL_REMINDER
  REFERRAL_PROCESS
  CUSTOM
}

// ==========================================
// RESTAURANT INDUSTRY ENUMS
// ==========================================

enum RestaurantTaskType {
  LEAD_RESEARCH
  CUSTOMER_RESEARCH
  RESERVATION_CONFIRMATION
  RESERVATION_REMINDER
  ORDER_TRACKING
  MENU_RECOMMENDATION
  LOYALTY_POINTS_UPDATE
  FEEDBACK_REQUEST
  SPECIAL_OFFER_NOTIFICATION
  BIRTHDAY_GREETING
  CUSTOM
}

enum RestaurantAIEmployeeType {
  RESERVATION_COORDINATOR
  ORDER_TRACKER
  LOYALTY_MANAGER
  MENU_ADVISOR
  CUSTOMER_SERVICE_SPECIALIST
  MARKETING_COORDINATOR
}

enum RestaurantWorkflowType {
  NEW_CUSTOMER_WELCOME
  RESERVATION_CONFIRMATION
  ORDER_FOLLOWUP
  LOYALTY_PROGRAM_ENROLLMENT
  FEEDBACK_COLLECTION
  CUSTOM
}

// ==========================================
// CONSTRUCTION INDUSTRY ENUMS
// ==========================================

enum ConstructionTaskType {
  LEAD_RESEARCH
  PROJECT_RESEARCH
  QUOTE_GENERATION
  QUOTE_FOLLOWUP
  PERMIT_TRACKING
  INSPECTION_SCHEDULING
  MATERIAL_ORDERING
  PROGRESS_UPDATE
  PAYMENT_REMINDER
  PROJECT_COMPLETION
  CUSTOM
}

enum ConstructionAIEmployeeType {
  QUOTE_SPECIALIST
  PERMIT_COORDINATOR
  INSPECTION_SCHEDULER
  MATERIAL_MANAGER
  PROJECT_COORDINATOR
  CLIENT_COMMUNICATOR
}

enum ConstructionWorkflowType {
  LEAD_QUALIFICATION
  QUOTE_FOLLOWUP
  PROJECT_KICKOFF
  INSPECTION_REMINDER
  MATERIAL_ORDERING
  CUSTOM
}

// ==========================================
// DENTIST INDUSTRY ENUMS
// ==========================================

enum DentistTaskType {
  LEAD_RESEARCH
  PATIENT_RESEARCH
  APPOINTMENT_BOOKING
  APPOINTMENT_REMINDER
  CLEANING_REMINDER
  TREATMENT_FOLLOWUP
  PAYMENT_REMINDER
  REFERRAL_COORDINATION
  CUSTOM
}

enum DentistAIEmployeeType {
  APPOINTMENT_SCHEDULER
  PATIENT_COORDINATOR
  TREATMENT_COORDINATOR
  BILLING_SPECIALIST
}

enum DentistWorkflowType {
  PATIENT_ONBOARDING
  CLEANING_REMINDER
  TREATMENT_FOLLOWUP
  CUSTOM
}

// ==========================================
// MEDICAL_SPA INDUSTRY ENUMS
// ==========================================

enum MedicalSpaTaskType {
  LEAD_RESEARCH
  CLIENT_RESEARCH
  APPOINTMENT_BOOKING
  APPOINTMENT_REMINDER
  TREATMENT_FOLLOWUP
  PACKAGE_PROMOTION
  MEMBERSHIP_RENEWAL
  CUSTOM
}

enum MedicalSpaAIEmployeeType {
  APPOINTMENT_COORDINATOR
  CLIENT_ADVISOR
  TREATMENT_SPECIALIST
  MEMBERSHIP_MANAGER
}

enum MedicalSpaWorkflowType {
  NEW_CLIENT_WELCOME
  TREATMENT_FOLLOWUP
  MEMBERSHIP_RENEWAL
  CUSTOM
}

// ==========================================
// OPTOMETRIST INDUSTRY ENUMS
// ==========================================

enum OptometristTaskType {
  LEAD_RESEARCH
  PATIENT_RESEARCH
  APPOINTMENT_BOOKING
  EXAM_REMINDER
  PRESCRIPTION_REMINDER
  FRAME_SELECTION_FOLLOWUP
  CONTACT_LENS_REORDER
  CUSTOM
}

enum OptometristAIEmployeeType {
  APPOINTMENT_SCHEDULER
  PATIENT_COORDINATOR
  OPTICAL_ADVISOR
  CONTACT_LENS_SPECIALIST
}

enum OptometristWorkflowType {
  PATIENT_ONBOARDING
  EXAM_REMINDER
  PRESCRIPTION_FOLLOWUP
  CUSTOM
}

// ==========================================
// HEALTH_CLINIC INDUSTRY ENUMS
// ==========================================

enum HealthClinicTaskType {
  LEAD_RESEARCH
  PATIENT_RESEARCH
  APPOINTMENT_BOOKING
  APPOINTMENT_REMINDER
  TEST_RESULTS_NOTIFICATION
  TREATMENT_FOLLOWUP
  REFERRAL_COORDINATION
  CUSTOM
}

enum HealthClinicAIEmployeeType {
  APPOINTMENT_COORDINATOR
  PATIENT_NAVIGATOR
  TEST_RESULTS_COORDINATOR
  REFERRAL_SPECIALIST
}

enum HealthClinicWorkflowType {
  PATIENT_ONBOARDING
  APPOINTMENT_REMINDER
  TEST_RESULTS_NOTIFICATION
  CUSTOM
}

// ==========================================
// HOSPITAL INDUSTRY ENUMS
// ==========================================

enum HospitalTaskType {
  LEAD_RESEARCH
  PATIENT_RESEARCH
  ADMISSION_COORDINATION
  DISCHARGE_FOLLOWUP
  TEST_RESULTS_NOTIFICATION
  APPOINTMENT_SCHEDULING
  REFERRAL_COORDINATION
  BILLING_FOLLOWUP
  CUSTOM
}

enum HospitalAIEmployeeType {
  ADMISSION_COORDINATOR
  PATIENT_NAVIGATOR
  DISCHARGE_PLANNER
  TEST_RESULTS_COORDINATOR
  REFERRAL_SPECIALIST
}

enum HospitalWorkflowType {
  ADMISSION_PROCESS
  DISCHARGE_FOLLOWUP
  TEST_RESULTS_NOTIFICATION
  CUSTOM
}

// ==========================================
// TECHNOLOGY INDUSTRY ENUMS
// ==========================================

enum TechnologyTaskType {
  LEAD_RESEARCH
  ACCOUNT_RESEARCH
  TRIAL_ONBOARDING
  FEATURE_ANNOUNCEMENT
  RENEWAL_REMINDER
  SUPPORT_FOLLOWUP
  UPSELL_OPPORTUNITY
  CUSTOM
}

enum TechnologyAIEmployeeType {
  ACCOUNT_MANAGER
  ONBOARDING_SPECIALIST
  SUPPORT_COORDINATOR
  SALES_SPECIALIST
}

enum TechnologyWorkflowType {
  TRIAL_USER_NURTURE
  ONBOARDING_SEQUENCE
  RENEWAL_REMINDER
  CUSTOM
}

// ==========================================
// SPORTS_CLUB INDUSTRY ENUMS
// ==========================================

enum SportsClubTaskType {
  LEAD_RESEARCH
  MEMBER_RESEARCH
  MEMBERSHIP_ENROLLMENT
  CLASS_REMINDER
  PAYMENT_REMINDER
  EVENT_NOTIFICATION
  ACHIEVEMENT_CONGratulations
  CUSTOM
}

enum SportsClubAIEmployeeType {
  MEMBERSHIP_COORDINATOR
  CLASS_SCHEDULER
  EVENT_COORDINATOR
  MEMBER_SERVICES_SPECIALIST
}

enum SportsClubWorkflowType {
  NEW_MEMBER_WELCOME
  CLASS_REMINDER
  MEMBERSHIP_RENEWAL
  CUSTOM
}

// ==========================================
// GENERIC MULTI-INDUSTRY WORKFLOW MODELS
// ==========================================

// Generic Workflow Template - defines workflows for all industries except Real Estate
model WorkflowTemplate {
  id          String       @id @default(cuid())
  userId      String
  industry    Industry
  name        String
  type        WorkflowType @default(CUSTOM)
  description String?
  isDefault   Boolean      @default(false)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Campaign mode fields (added in previous migration)
  executionMode    String? // WORKFLOW, CAMPAIGN, DRIP
  audience         Json?
  campaignSettings Json?
  analytics        Json?
  totalRecipients  Int     @default(0)
  sentCount        Int     @default(0)
  deliveredCount   Int     @default(0)
  openedCount      Int     @default(0)
  clickedCount     Int     @default(0)
  repliedCount     Int     @default(0)
  failedCount      Int     @default(0)
  openRate         Float?
  clickRate        Float?
  deliveryRate     Float?
  replyRate        Float?

  // Enrollment mode fields (Phase 1 - Drip Campaigns)
  enrollmentMode     Boolean @default(false)
  enrollmentTriggers Json?

  // Phase 3: A/B Testing fields
  enableAbTesting Boolean @default(false)
  abTestConfig    Json? // {splitPercentage: 50, testType: "subject" | "content" | "timing"}

  // Relations
  user        User                         @relation("UserWorkflowTemplates", fields: [userId], references: [id], onDelete: Cascade)
  tasks       WorkflowTask[]               @relation("WorkflowTemplateTasks")
  instances   WorkflowInstance[]           @relation("WorkflowTemplateInstances")
  enrollments WorkflowTemplateEnrollment[] @relation("WorkflowTemplateEnrollments")

  @@index([userId])
  @@index([industry])
  @@index([type])
  @@index([isDefault])
  @@index([executionMode])
  @@index([enrollmentMode])
}

// Generic Workflow Task - a single task/step in the workflow
model WorkflowTask {
  id                String   @id @default(cuid())
  templateId        String
  name              String
  description       String?
  taskType          String // JSON string of industry-specific task type enum
  assignedAgentType String? // JSON string of industry-specific AI employee type enum
  delayValue        Int      @default(0)
  delayUnit         String   @default("MINUTES") // MINUTES, HOURS, DAYS
  isHITL            Boolean  @default(false)
  isOptional        Boolean  @default(false)
  position          Json // {row: 0, col: 0} for serpentine UI
  displayOrder      Int
  parentTaskId      String?
  branchCondition   Json? // {field: "status", operator: "equals", value: "completed"}
  actionConfig      Json // {actions: ["voice_call", "sms"], script: "...", etc}
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Phase 2: Enhanced timing options for drip campaigns
  delayDays         Int     @default(0) // Days delay (for granular control)
  delayHours        Int     @default(0) // Hours delay (for granular control)
  preferredSendTime String? // Preferred time of day to send (HH:MM format, e.g., "09:00")
  skipConditions    Json? // Conditions to skip this task (e.g., [{"field": "status", "operator": "equals", "value": "converted"}])

  // Phase 3: A/B Testing fields
  isAbTestVariant Boolean @default(false) // True if this task is an A/B test variant
  abTestGroup     String? // 'A' or 'B' - which test group this variant belongs to
  variantOf       String? // ID of the original task this variant is based on

  // Relations
  template   WorkflowTemplate @relation("WorkflowTemplateTasks", fields: [templateId], references: [id], onDelete: Cascade)
  parentTask WorkflowTask?    @relation("WorkflowTaskBranches", fields: [parentTaskId], references: [id])
  childTasks WorkflowTask[]   @relation("WorkflowTaskBranches")
  executions TaskExecution[]  @relation("WorkflowTaskExecutions")

  @@index([templateId])
  @@index([parentTaskId])
  @@index([displayOrder])
}

// Generic Workflow Instance - a running instance of a workflow
model WorkflowInstance {
  id            String                 @id @default(cuid())
  templateId    String
  userId        String
  industry      Industry
  leadId        String?
  dealId        String?
  contactId     String?
  status        WorkflowInstanceStatus @default(ACTIVE)
  currentTaskId String?
  metadata      Json? // Industry-specific data collected
  startedAt     DateTime               @default(now())
  completedAt   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  // Relations
  template   WorkflowTemplate @relation("WorkflowTemplateInstances", fields: [templateId], references: [id])
  user       User             @relation("UserIndustryWorkflowInstances", fields: [userId], references: [id], onDelete: Cascade)
  lead       Lead?            @relation("LeadWorkflowInstances", fields: [leadId], references: [id])
  deal       Deal?            @relation("DealWorkflowInstances", fields: [dealId], references: [id])
  executions TaskExecution[]  @relation("WorkflowInstanceExecutions")

  @@index([templateId])
  @@index([userId])
  @@index([industry])
  @@index([leadId])
  @@index([dealId])
  @@index([status])
}

// Generic Task Execution - tracks execution of a single task within an instance
model TaskExecution {
  id             String              @id @default(cuid())
  instanceId     String
  taskId         String
  status         TaskExecutionStatus @default(PENDING)
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  agentUsed      String? // JSON string of industry-specific AI employee type
  callLogId      String? // Link to CallLog if voice call made
  result         Json? // Outcome data
  hitlApprovedBy String? // User who approved HITL
  hitlApprovedAt DateTime?
  hitlNotes      String?
  errorMessage   String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  instance WorkflowInstance @relation("WorkflowInstanceExecutions", fields: [instanceId], references: [id], onDelete: Cascade)
  task     WorkflowTask     @relation("WorkflowTaskExecutions", fields: [taskId], references: [id])

  @@index([instanceId])
  @@index([taskId])
  @@index([status])
  @@index([scheduledFor])
}

// WorkflowTemplate Enrollment - tracks individual lead enrollments in enrollment-mode workflows (drip campaigns)
// This is separate from WorkflowEnrollment which is for the older Workflow model
model WorkflowTemplateEnrollment {
  id          String                   @id @default(cuid())
  workflowId  String
  leadId      String
  status      WorkflowEnrollmentStatus @default(ACTIVE)
  currentStep Int                      @default(1)
  nextSendAt  DateTime?
  abTestGroup String?
  enrolledAt  DateTime                 @default(now())
  completedAt DateTime?
  pausedAt    DateTime?
  metadata    Json?

  // Relations
  workflow WorkflowTemplate @relation("WorkflowTemplateEnrollments", fields: [workflowId], references: [id], onDelete: Cascade)
  lead     Lead             @relation("LeadWorkflowTemplateEnrollments", fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([workflowId, leadId])
  @@index([workflowId])
  @@index([leadId])
  @@index([status])
  @@index([nextSendAt])
}

// Generic HITL Notification Queue - tracks pending human-in-the-loop approvals
model HITLNotification {
  id          String   @id @default(cuid())
  userId      String
  executionId String   @unique
  taskName    String
  contactName String?
  metadata    Json? // Industry-specific context (e.g., dealAddress for RE, appointmentTime for Medical)
  message     String
  urgency     String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  isRead      Boolean  @default(false)
  isActioned  Boolean  @default(false)
  smsSent     Boolean  @default(false)
  emailSent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation("UserHITLNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActioned])
  @@index([createdAt])
}

// ==========================================
// MULTI-CLINIC SUPPORT
// ==========================================

// Clinic Model - Multi-clinic support
model Clinic {
  id      String  @id @default(cuid())
  name    String
  address String?
  city    String?
  state   String?
  zipCode String?
  country String? @default("Canada")
  phone   String?
  email   String?
  website String?

  // Settings
  timezone String? @default("America/Toronto")
  currency String? @default("CAD")
  language String? @default("en")

  // Branding
  logo         String?
  primaryColor String? @default("#9333ea") // Purple

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userMemberships   UserClinic[]             @relation("ClinicUsers")
  appointments      BookingAppointment[]
  odontograms       DentalOdontogram[]
  periodontalCharts DentalPeriodontalChart[]
  treatmentPlans    DentalTreatmentPlan[]
  procedures        DentalProcedure[]
  forms             DentalForm[]
  formResponses     DentalFormResponse[]
  xrays             DentalXRay[]
  labOrders         DentalLabOrder[]
  insuranceClaims   DentalInsuranceClaim[]
  vnaConfigurations VnaConfiguration[]
  documents         PatientDocument[]        @relation("ClinicDocuments")

  @@index([isActive])
}

// User-Clinic Junction Table (Many-to-Many)
model UserClinic {
  id        String   @id @default(cuid())
  userId    String
  clinicId  String
  role      String   @default("MEMBER") // OWNER, ADMIN, MEMBER
  isPrimary Boolean  @default(false) // User's primary clinic
  createdAt DateTime @default(now())

  // Relations
  user   User   @relation("UserClinicMemberships", fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation("ClinicUsers", fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([userId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@index([isPrimary])
}

// Phase 1: Core Dental Practice Management Models

// ==========================================
// DENTAL PRACTICE MANAGEMENT MODELS
// ==========================================

// Dental Odontogram - Interactive tooth chart
model DentalOdontogram {
  id       String @id @default(cuid())
  leadId   String // Patient
  userId   String // Practice
  clinicId String // Clinic

  // Tooth data (Universal Numbering System: 1-32)
  toothData Json // { "1": { condition: "crown", date: "2024-01-15", ... }, "2": {...} }

  // Chart metadata
  chartDate DateTime @default(now())
  chartedBy String // User who created/updated chart
  notes     String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([chartDate])
}

// Dental Periodontal Chart - Periodontal measurements
model DentalPeriodontalChart {
  id       String @id @default(cuid())
  leadId   String // Patient
  userId   String // Practice
  clinicId String // Clinic

  // Periodontal measurements (pocket depths, BOP, recession, mobility)
  measurements Json // { "tooth": "1", "mesial": {pd: 3, bop: false}, "buccal": {...}, ... }

  // Chart metadata
  chartDate DateTime @default(now())
  chartedBy String
  notes     String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([chartDate])
}

// Dental Treatment Plan - Treatment plans with procedures
model DentalTreatmentPlan {
  id       String @id @default(cuid())
  leadId   String // Patient
  userId   String // Practice
  clinicId String // Clinic

  // Treatment plan details
  planName    String
  description String?             @db.Text
  status      TreatmentPlanStatus @default(DRAFT)

  // Procedures (ordered sequence)
  procedures Json // Array of {procedureCode: "D0120", description: "...", cost: 150, sequence: 1, ...}

  // Financial
  totalCost             Float  @default(0)
  insuranceCoverage     Float? @default(0)
  patientResponsibility Float? @default(0)

  // Dates
  createdDate    DateTime  @default(now())
  startDate      DateTime?
  completionDate DateTime?

  // Approval
  approvedBy         String?
  approvedAt         DateTime?
  patientConsent     Boolean   @default(false)
  patientConsentDate DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead            Lead                   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic          Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  proceduresLog   DentalProcedure[]
  labOrders       DentalLabOrder[]
  insuranceClaims DentalInsuranceClaim[]

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([status])
}

// Dental Procedure - Procedure log/activity log
model DentalProcedure {
  id              String  @id @default(cuid())
  leadId          String // Patient
  userId          String // Practice
  clinicId        String // Clinic
  treatmentPlanId String? // Link to treatment plan

  // Procedure details
  procedureCode String // CDT code (e.g., "D0120", "D1110")
  procedureName String
  description   String? @db.Text

  // Tooth/teeth involved
  teethInvolved String[] // ["1", "2", "3"] - Universal numbering

  // Status
  status ProcedureStatus @default(SCHEDULED)

  // Dates
  scheduledDate DateTime?
  performedDate DateTime?

  // Financial
  cost              Float  @default(0)
  insuranceCoverage Float? @default(0)

  // Performed by
  performedBy String? // Dentist/hygienist name

  // Notes
  notes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead            Lead                   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic          Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  treatmentPlan   DentalTreatmentPlan?   @relation(fields: [treatmentPlanId], references: [id])
  labOrders       DentalLabOrder[]
  insuranceClaims DentalInsuranceClaim[]

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([procedureCode])
  @@index([status])
  @@index([performedDate])
}

// Dental Form - Dynamic form templates
model DentalForm {
  id       String @id @default(cuid())
  userId   String // Practice
  clinicId String // Clinic

  // Form details
  formName    String
  description String? @db.Text
  category    String? // "Medical History", "Consent", "Treatment", etc.

  // Form structure (JSON schema)
  formSchema Json // { fields: [{type: "text", label: "...", required: true}, ...]}

  // Settings
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic    Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  responses DentalFormResponse[]

  @@index([userId])
  @@index([clinicId])
  @@index([isActive])
  @@index([category])
}

// Dental Form Response - Form submissions
model DentalFormResponse {
  id       String @id @default(cuid())
  leadId   String // Patient
  userId   String // Practice
  clinicId String // Clinic
  formId   String // Form template

  // Response data
  responseData Json // { fieldId: "value", ... }

  // Submission metadata
  submittedAt DateTime @default(now())
  submittedBy String? // Patient or staff member

  // Digital signature
  signatureData Json? // { signature: "...", signedBy: "...", signedAt: "..." }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead   Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  form   DentalForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([formId])
  @@index([submittedAt])
}

// Dental X-Ray - X-ray images with AI analysis
model DentalXRay {
  id       String @id @default(cuid())
  leadId   String // Patient
  userId   String // Practice
  clinicId String // Clinic

  // File info - Multi-resolution support
  dicomFile String? // Path to DICOM file in Canadian storage (original)
  imageFile String? // DEPRECATED: Use imageUrls instead
  imageUrl  String? // DEPRECATED: Use imageUrls instead

  // Compressed image URLs (cloud storage)
  thumbnailUrl String? // Thumbnail (200px) - fast loading
  previewUrl   String? // Preview (1024px) - list views
  fullUrl      String? // Full resolution (2048px) - detailed viewing

  // Storage paths (for deletion/management)
  storagePaths Json? // { thumbnail: "...", preview: "...", full: "..." }

  // Compression metadata
  compressionRatio Float? // Percentage reduction (e.g., 85.5 = 85.5% smaller)
  originalSize     Int? // Original DICOM file size in bytes
  compressedSize   Int? // Compressed full image size in bytes

  // X-ray metadata
  xrayType      String // PANORAMIC, BITEWING, PERIAPICAL, CEPHALOMETRIC, CBCT
  teethIncluded String[] // ["1", "2", "3"] - Universal numbering
  dateTaken     DateTime

  // AI Analysis
  aiAnalysis   Json? // { findings: "...", confidence: 0.95, recommendations: "...", model: "gpt-4-vision" }
  aiAnalyzedAt DateTime?
  aiModel      String? // "gpt-4-vision", "denti-ai", etc.

  // Comparison
  comparedToXRayId String? // Link to previous X-ray for comparison

  // Notes
  notes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([dateTaken])
  @@index([xrayType])
}

// Phase 6: Lab Order Management
model DentalLabOrder {
  id              String  @id @default(cuid())
  leadId          String // Patient
  userId          String // Practice
  clinicId        String // Clinic
  treatmentPlanId String? // Link to treatment plan
  procedureId     String? // Link to specific procedure

  // Lab order details
  orderNumber  String       @unique // Auto-generated: LAB-YYYYMMDD-XXXX
  labName      String // Lab company name
  labContact   Json? // { name, phone, email, address }
  orderType    LabOrderType // CROWN, BRIDGE, DENTURE, IMPLANT, ORTHODONTIC, OTHER
  description  String?      @db.Text
  instructions String?      @db.Text // Special instructions for lab

  // Patient information sent to lab
  patientInfo    Json // { name, dob, gender, etc. }
  impressionDate DateTime?
  deliveryDate   DateTime? // Expected delivery date

  // Status tracking
  status       LabOrderStatus @default(PENDING)
  submittedAt  DateTime?
  receivedAt   DateTime? // When lab received order
  inProgressAt DateTime?
  completedAt  DateTime?
  deliveredAt  DateTime? // When delivered back to practice

  // Financial
  cost        Float?    @default(0)
  paid        Boolean   @default(false)
  paymentDate DateTime?

  // Tracking
  trackingNumber String?
  shippingMethod String?

  // Files/Attachments
  attachments     Json? // Array of file references
  prescriptionUrl String? // Link to prescription/instructions

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text // Staff-only notes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead          Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic        Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  treatmentPlan DentalTreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])
  procedure     DentalProcedure?     @relation(fields: [procedureId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([procedureId])
  @@index([status])
  @@index([orderNumber])
  @@index([orderType])
}

enum LabOrderType {
  CROWN
  BRIDGE
  DENTURE
  IMPLANT
  ORTHODONTIC
  RETAINER
  NIGHT_GUARD
  OTHER
}

enum LabOrderStatus {
  PENDING // Order created, not yet submitted
  SUBMITTED // Sent to lab
  RECEIVED // Lab confirmed receipt
  IN_PROGRESS // Lab is working on it
  COMPLETED // Lab finished, ready for pickup/delivery
  DELIVERED // Received back at practice
  CANCELLED
}

// Phase 6: Insurance Integration
model DentalInsuranceClaim {
  id              String  @id @default(cuid())
  leadId          String // Patient
  userId          String // Practice
  clinicId        String // Clinic
  treatmentPlanId String? // Link to treatment plan
  procedureId     String? // Link to specific procedure

  // Claim details
  claimNumber   String                @unique // Auto-generated or provider claim #
  insuranceType InsuranceProviderType // RAMQ, PRIVATE, BOTH
  providerName  String // Insurance company name
  policyNumber  String // Patient's policy number
  groupNumber   String? // Group/plan number
  subscriberId  String? // Subscriber ID

  // Patient information
  patientInfo    Json // { name, dob, relationshipToSubscriber, etc. }
  subscriberInfo Json? // Subscriber information if different from patient

  // Procedure/Service details
  procedures            Json // Array of { procedureCode, description, cost, dateOfService }
  totalAmount           Float
  submittedAmount       Float // Amount submitted to insurance
  estimatedCoverage     Float? // Expected coverage amount
  patientResponsibility Float? // Patient's portion

  // Status tracking
  status         InsuranceClaimStatus @default(DRAFT)
  submittedAt    DateTime?
  acknowledgedAt DateTime? // Insurance acknowledged receipt
  processedAt    DateTime?
  paidAt         DateTime?
  deniedAt       DateTime?
  appealDeadline DateTime?

  // Response from insurance
  responseData  Json? // { approvedAmount, deniedAmount, reason, etc. }
  eobUrl        String? // Explanation of Benefits document URL
  paymentAmount Float? // Actual payment received
  paymentDate   DateTime?

  // RAMQ-specific fields
  ramqClaimId String? // RAMQ claim reference number
  ramqStatus  String? // RAMQ processing status

  // Private insurance-specific fields
  claimFormUrl  String? // Link to claim form PDF
  preAuthNumber String? // Pre-authorization number if applicable

  // Notes
  notes        String? @db.Text
  denialReason String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead          Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic        Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  treatmentPlan DentalTreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])
  procedure     DentalProcedure?     @relation(fields: [procedureId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([procedureId])
  @@index([status])
  @@index([claimNumber])
  @@index([insuranceType])
  @@index([providerName])
}

enum InsuranceProviderType {
  RAMQ // Rgie de l'assurance maladie du Qubec
  PRIVATE // Private insurance (Sun Life, Manulife, etc.)
  BOTH // Both RAMQ and private
}

enum InsuranceClaimStatus {
  DRAFT // Being prepared
  SUBMITTED // Sent to insurance
  ACKNOWLEDGED // Insurance confirmed receipt
  PROCESSING // Under review
  APPROVED // Approved for payment
  PARTIALLY_APPROVED // Partially approved
  DENIED // Denied
  PAID // Payment received
  APPEALED // Under appeal
  CANCELLED
}

// Phase 2: Multi-VNA Support
model VnaConfiguration {
  id       String  @id @default(cuid())
  userId   String // Practice owner
  clinicId String // Clinic
  name     String // Display name (e.g., "Main Clinic VNA", "Cloud Storage")
  type     VnaType // ORTHANC, AWS_S3, AZURE_BLOB, CLOUD_VNA, OTHER
  isActive Boolean @default(true)

  // Connection details
  endpoint    String? // API endpoint URL
  aeTitle     String? // DICOM AE Title (for Orthanc)
  host        String? // Host/IP address
  port        Int? // Port number
  credentials Json? // Encrypted credentials {username, password, apiKey, etc.}

  // Storage configuration
  bucket     String? // S3 bucket or Azure container
  region     String? // AWS/Azure region
  pathPrefix String? // Path prefix for storage

  // Routing configuration
  routingRules Json? // Array of routing rules
  priority     Int     @default(0) // Lower number = higher priority
  isDefault    Boolean @default(false) // Default VNA if no rules match

  // Metadata
  description    String?   @db.Text
  lastTestedAt   DateTime?
  lastTestStatus String? // "success" | "failed" | "pending"
  lastTestError  String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clinicId])
  @@index([isActive])
  @@index([type])
}

enum VnaType {
  ORTHANC // Orthanc DICOM server
  AWS_S3 // AWS S3 storage
  AZURE_BLOB // Azure Blob Storage
  CLOUD_VNA // Cloud-based VNA (Dentitek, etc.)
  OTHER // Other VNA systems
}

// Enums for dental models
enum TreatmentPlanStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProcedureStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

// ==========================================
// LAW 25 COMPLIANT DOCUMENT STORAGE
// ==========================================

// Main document storage model (Law 25 compliant)
model PatientDocument {
  id           String       @id @default(cuid())
  userId       String // Practice owner
  clinicId     String // Clinic
  leadId       String? // Patient/Lead reference
  documentType DocumentType
  category     String? // "X-Ray", "Consent Form", "Insurance", etc.

  // File metadata
  fileName             String
  fileType             String // MIME type
  fileSize             Int // bytes
  encryptedStoragePath String // Encrypted S3 path (Canada region)
  encryptionKeyId      String // Reference to encryption key

  // Law 25 compliance fields
  consentId       String? // Link to consent record
  dataResidency   String   @default("CA-QC") // Must be Canada/Quebec
  retentionPolicy String   @default("MEDICAL_7_YEARS")
  retentionExpiry DateTime // Auto-delete after this date

  // Access control
  accessLevel    DocumentAccessLevel @default(RESTRICTED)
  createdBy      String // User who uploaded
  lastAccessedBy String?
  lastAccessedAt DateTime?

  // Patient rights
  deletionRequested   Boolean   @default(false)
  deletionRequestDate DateTime?
  deletionReason      String?
  deletionBlocked     Boolean   @default(false) // Legal hold

  // Metadata
  tags        String[]
  description String?
  metadata    Json? // Flexible metadata (procedure codes, etc.)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  user       User                @relation("PracticeDocuments", fields: [userId], references: [id], onDelete: Cascade)
  clinic     Clinic              @relation("ClinicDocuments", fields: [clinicId], references: [id], onDelete: Cascade)
  lead       Lead?               @relation("PatientDocuments", fields: [leadId], references: [id], onDelete: SetNull)
  consent    DocumentConsent?    @relation(fields: [consentId], references: [id])
  accessLogs DocumentAccessLog[]
  versions   DocumentVersion[]

  @@index([userId])
  @@index([clinicId])
  @@index([leadId])
  @@index([documentType])
  @@index([retentionExpiry])
  @@index([deletionRequested])
  @@index([dataResidency])
}

// Document versions (for audit trail)
model DocumentVersion {
  id                   String   @id @default(cuid())
  documentId           String
  versionNumber        Int
  encryptedStoragePath String
  changeReason         String?
  changedBy            String
  createdAt            DateTime @default(now())

  document PatientDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

// Consent management (Law 25 requirement)
model DocumentConsent {
  id     String @id @default(cuid())
  leadId String // Patient
  userId String // Practice

  // Consent details
  consentType ConsentType
  purpose     String // "Treatment", "Insurance", "Legal", etc.
  granted     Boolean     @default(false)
  grantedAt   DateTime?
  grantedBy   String? // Patient or authorized representative

  // Consent withdrawal
  withdrawn        Boolean   @default(false)
  withdrawnAt      DateTime?
  withdrawalReason String?

  // Legal basis
  legalBasis    String // "Consent", "Legal obligation", "Vital interests", etc.
  consentMethod String // "Written", "Digital signature", "Verbal", etc.

  // Retention
  consentExpiry DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead      Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents PatientDocument[]

  @@index([leadId])
  @@index([userId])
  @@index([granted])
  @@index([consentType])
}

// Access audit log (Law 25 requirement)
model DocumentAccessLog {
  id           String               @id @default(cuid())
  documentId   String
  userId       String // Who accessed
  action       DocumentAccessAction
  ipAddress    String?
  userAgent    String?
  reason       String? // "Treatment", "Billing", "Legal request", etc.
  success      Boolean              @default(true)
  errorMessage String?
  createdAt    DateTime             @default(now())

  document PatientDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User            @relation("DocumentAccessLogUser", fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Patient data access requests (Law 25 right to access)
model DataAccessRequest {
  id     String @id @default(cuid())
  leadId String // Patient
  userId String // Practice

  requestType DataRequestType
  status      DataRequestStatus @default(PENDING)

  // Request details
  requestedAt   DateTime @default(now())
  requestedBy   String // Patient name/ID
  requestReason String?

  // Response
  respondedAt    DateTime?
  responseMethod String? // "Email", "Portal", "Mail", etc.
  responseData   Json? // Links to exported documents

  // Completion
  completedAt DateTime?
  notes       String?

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation("DataAccessRequestUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([status])
  @@index([requestType])
}

// Data breach tracking (Law 25 requirement - notify within 72 hours)
model DataBreach {
  id     String @id @default(cuid())
  userId String // Practice

  // Breach details
  breachType       BreachType
  severity         BreachSeverity
  description      String         @db.Text
  affectedRecords  Int            @default(0)
  affectedPatients Int            @default(0)

  // Discovery
  discoveredAt DateTime
  reportedAt   DateTime? // When reported to authorities

  // Notification
  patientsNotified   Boolean   @default(false)
  notificationDate   DateTime?
  notificationMethod String? // "Email", "Mail", "Phone", etc.

  // Resolution
  resolved        Boolean   @default(false)
  resolvedAt      DateTime?
  resolutionNotes String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation("DataBreachUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([severity])
  @@index([resolved])
  @@index([discoveredAt])
}

// Enums for Law 25 document storage
enum DocumentType {
  XRAY
  PHOTO
  CONSENT_FORM
  INSURANCE_FORM
  TREATMENT_PLAN
  INVOICE
  MEDICAL_HISTORY
  CORRESPONDENCE
  OTHER
}

enum DocumentAccessLevel {
  PUBLIC // Anyone in practice
  RESTRICTED // Specific roles only
  CONFIDENTIAL // Only creator and admins
}

enum ConsentType {
  TREATMENT
  DATA_COLLECTION
  DATA_SHARING
  MARKETING
  RESEARCH
}

enum DocumentAccessAction {
  VIEW
  DOWNLOAD
  DELETE
  SHARE
  EXPORT
}

enum DataRequestType {
  ACCESS // Right to access
  DELETION // Right to deletion
  PORTABILITY // Data portability
  CORRECTION // Correction of data
}

enum DataRequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  EXPIRED
}

enum BreachType {
  UNAUTHORIZED_ACCESS
  DATA_LOSS
  DATA_THEFT
  SYSTEM_COMPROMISE
  ACCIDENTAL_DISCLOSURE
}

enum BreachSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ==========================================
// WEBSITE BUILDER MODELS
// ==========================================

enum WebsiteType {
  REBUILT
  SERVICE_TEMPLATE
  PRODUCT_TEMPLATE
}

enum WebsiteStatus {
  BUILDING
  READY
  PUBLISHED
  FAILED
}

enum WebsiteBuildType {
  INITIAL
  REBUILD
  UPDATE
}

enum WebsiteBuildStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum WebsiteIntegrationType {
  STRIPE
  BOOKING
  FORM
  CTA
  CHAT
  ANALYTICS
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum ChangeType {
  AI_MODIFICATION
  MANUAL_EDIT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  MODIFIED
}

enum WebsiteTemplateType {
  SERVICE
  PRODUCT
}

// Website - Main model for user websites
model Website {
  id            String               @id @default(cuid())
  userId        String
  name          String
  type          WebsiteType
  sourceUrl     String? // If rebuilt from existing site
  templateType  WebsiteTemplateType? // SERVICE, PRODUCT
  status        WebsiteStatus        @default(BUILDING)
  buildProgress Int                  @default(0) // 0-100

  // Structure & Content
  structure            Json // Complete website structure (pages, components, etc.)
  seoData              Json // SEO metadata
  extractedData        Json? // All scraped/extracted data
  questionnaireAnswers Json? // Answers from questionnaire (if new site)

  // Integrations
  stripeConnectAccountId String?
  elevenLabsAgentId      String?
  integrationsConfig     Json    @default("{}") // Active integrations config
  googleAnalyticsId      String? // Google Analytics tracking ID (UA-XXXXX or G-XXXXX)
  facebookPixelId        String? // Facebook Pixel ID

  // Google Search Console OAuth (for SEO automation)
  googleSearchConsoleAccessToken  String? // Encrypted OAuth access token
  googleSearchConsoleRefreshToken String? // Encrypted OAuth refresh token
  googleSearchConsoleTokenExpiry  DateTime? // Token expiration time
  googleSearchConsoleSiteUrl      String? // Verified site URL in Search Console
  googleSearchConsoleVerified     Boolean   @default(false) // Whether site is verified

  // Resources (separate per website)
  githubRepoUrl       String?
  neonDatabaseUrl     String?
  vercelProjectId     String?
  vercelDeploymentUrl String?

  // Voice AI
  voiceAIEnabled Boolean @default(false)
  voiceAIConfig  Json? // Voice AI settings

  // Approval Queue
  pendingChanges Json? // Changes awaiting approval

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  builds              WebsiteBuild[]
  websiteIntegrations WebsiteIntegration[]
  visitors            WebsiteVisitor[]
  changeApprovals     WebsiteChangeApproval[]
  websiteProducts     WebsiteProduct[]
  websiteOrders       WebsiteOrder[]
  stockSettings       WebsiteStockSettings?
  media               WebsiteMedia[]

  @@index([userId])
  @@index([status])
  @@index([type])
}

// WebsiteBuild - Tracks build processes
model WebsiteBuild {
  id          String             @id @default(cuid())
  websiteId   String
  buildType   WebsiteBuildType
  status      WebsiteBuildStatus @default(PENDING)
  progress    Int                @default(0)
  sourceUrl   String? // If cloning
  buildData   Json? // Build configuration
  error       String?
  startedAt   DateTime           @default(now())
  completedAt DateTime?

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
  @@index([status])
}

// WebsiteIntegration - Active integrations on websites
model WebsiteIntegration {
  id        String                 @id @default(cuid())
  websiteId String
  type      WebsiteIntegrationType
  config    Json // Integration-specific configuration
  status    IntegrationStatus      @default(ACTIVE)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
  @@index([type])
}

// WebsiteVisitor - Tracks website visitors and interactions
model WebsiteVisitor {
  id           String   @id @default(cuid())
  websiteId    String
  sessionId    String
  ipAddress    String?
  userAgent    String?
  referrer     String?
  pagesVisited Json     @default("[]") // Array of page visits
  interactions Json     @default("{}") // CTA clicks, form submissions, etc.
  formData     Json? // Submitted form data
  createdAt    DateTime @default(now())

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
  @@index([sessionId])
  @@index([createdAt])
}

// WebsiteChangeApproval - Tracks pending changes awaiting approval
model WebsiteChangeApproval {
  id          String         @id @default(cuid())
  websiteId   String
  changeType  ChangeType
  changes     Json // Proposed changes
  preview     Json // Preview data
  status      ApprovalStatus @default(PENDING)
  requestedBy String? // User ID
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime       @default(now())

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
  @@index([status])
}

// WebsiteTemplate - Pre-built templates
model WebsiteTemplate {
  id                 String              @id @default(cuid())
  name               String
  type               WebsiteTemplateType
  category           String?
  previewImage       String?
  previewUrl         String? // Live demo URL for iframe preview (e.g. source site)
  previewUrlBlocked  Boolean             @default(false) // True if previewUrl blocks scraping/iframe
  structure          Json // Template structure
  description        String?
  isDefault          Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([type])
  @@index([category])
}

// WebsiteProduct - Links products to websites for e-commerce
model WebsiteProduct {
  id           String   @id @default(cuid())
  websiteId    String
  productId    String
  displayOrder Int? // Order in which product appears on website
  isVisible    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([websiteId, productId])
  @@index([websiteId])
  @@index([productId])
}

// WebsiteOrder - Links orders to websites
model WebsiteOrder {
  id         String   @id @default(cuid())
  websiteId  String
  orderId    String
  customerId String? // Lead ID
  createdAt  DateTime @default(now())

  website  Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customer Lead?   @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@unique([websiteId, orderId])
  @@index([websiteId])
  @@index([orderId])
  @@index([customerId])
}

// WebsiteStockSettings - Stock management settings per website
model WebsiteStockSettings {
  id                 String   @id @default(cuid())
  websiteId          String   @unique
  lowStockThreshold  Int      @default(10)
  outOfStockAction   String   @default("HIDE") // HIDE, SHOW_OUT_OF_STOCK, PRE_ORDER
  syncInventory      Boolean  @default(true)
  autoHideOutOfStock Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
}

// WebsiteMedia - Media library per website (images, videos, files)
model WebsiteMedia {
  id          String   @id @default(cuid())
  websiteId   String
  url         String
  path        String
  filename    String
  mimeType    String
  size        Int
  type        String   // IMAGE, VIDEO, FILE
  width       Int?
  height      Int?
  alt         String?
  thumbnailUrl String?
  optimizedUrl String?
  metadata    Json?    // { duration for video, pageCount for PDF, etc. }
  createdAt   DateTime @default(now())

  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@index([websiteId])
  @@index([type])
}

// ==========================================
// TWILIO FAILOVER SYSTEM
// ==========================================

// Twilio Account Management - Multiple accounts for failover
model TwilioAccount {
  id                String    @id @default(cuid())
  name              String // e.g., "Primary", "Backup 1"
  accountSid        String    @unique
  authToken         String?   // Encrypted when stored; null when envKey is used
  envKey            String?   @unique // e.g. "PRIMARY", "BACKUP" - credentials from TWILIO_PRIMARY_*, TWILIO_BACKUP_*
  isPrimary         Boolean   @default(false)
  isActive          Boolean   @default(true)
  status            String    @default("ACTIVE") // ACTIVE, SUSPENDED, FAILED
  lastHealthCheck   DateTime?
  healthStatus      String? // HEALTHY, DEGRADED, FAILED
  phoneNumbersCount Int       @default(0)
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  voiceAgents          VoiceAgent[]
  purchasedPhoneNumbers PurchasedPhoneNumber[]
  healthChecks         TwilioHealthCheck[]
  failoverEventsFrom   TwilioFailoverEvent[]     @relation("FailoverFromAccount")
  failoverEventsTo     TwilioFailoverEvent[]     @relation("FailoverToAccount")
  backupPhoneNumbers   TwilioBackupPhoneNumber[]

  @@index([isPrimary])
  @@index([isActive])
  @@index([status])
  @@index([healthStatus])
}

// Failover Events & Logging
enum TwilioFailoverTriggerType {
  CRITICAL // Account hacked, suspended - immediate failover
  DEGRADED // Multiple agents failing - approval window
  MANUAL // Admin manually triggered
}

enum TwilioFailoverStatus {
  PENDING_APPROVAL
  APPROVED
  EXECUTING
  COMPLETED
  CANCELLED
  ROLLED_BACK
}

model TwilioFailoverEvent {
  id                      String                    @id @default(cuid())
  triggerType             TwilioFailoverTriggerType
  detectedAt              DateTime                  @default(now())
  approvalWindowStarted   DateTime?
  approvedAt              DateTime?
  approvedBy              String? // User ID or 'AUTO'
  status                  TwilioFailoverStatus      @default(PENDING_APPROVAL)
  affectedAgentsCount     Int
  totalActiveAgentsCount  Int
  testResultsDuringWindow Json? // Store test results during approval window
  failoverExecutedAt      DateTime?
  rollbackAt              DateTime?
  rollbackBy              String?
  fromAccountId           String?
  toAccountId             String?
  notes                   String?
  errorMessage            String?

  // Relations
  fromAccount TwilioAccount? @relation("FailoverFromAccount", fields: [fromAccountId], references: [id])
  toAccount   TwilioAccount? @relation("FailoverToAccount", fields: [toAccountId], references: [id])

  @@index([status])
  @@index([triggerType])
  @@index([detectedAt])
  @@index([fromAccountId])
  @@index([toAccountId])
}

// Health Check History
enum TwilioHealthCheckType {
  API
  WEBHOOK
  PHONE_NUMBER
  AGENT
  ACCOUNT_STATUS
}

enum TwilioHealthCheckStatus {
  PASS
  FAIL
  DEGRADED
}

model TwilioHealthCheck {
  id              String                  @id @default(cuid())
  twilioAccountId String
  checkType       TwilioHealthCheckType
  status          TwilioHealthCheckStatus
  details         Json? // Store detailed results
  responseTime    Int? // Milliseconds
  checkedAt       DateTime                @default(now())

  // Relations
  twilioAccount TwilioAccount @relation(fields: [twilioAccountId], references: [id], onDelete: Cascade)

  @@index([twilioAccountId])
  @@index([checkType])
  @@index([status])
  @@index([checkedAt])
}

// Backup Phone Number Pool
model TwilioBackupPhoneNumber {
  id                String    @id @default(cuid())
  twilioAccountId   String
  phoneNumber       String    @unique
  countryCode       String
  isAssigned        Boolean   @default(false)
  assignedToAgentId String?
  assignedAt        DateTime?
  createdAt         DateTime  @default(now())

  // Relations
  twilioAccount TwilioAccount @relation(fields: [twilioAccountId], references: [id], onDelete: Cascade)

  @@index([twilioAccountId])
  @@index([isAssigned])
  @@index([assignedToAgentId])
}

// Landing page blog posts (auto-generated for social media)
model BlogPost {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  excerpt       String // Short summary for cards / social
  content       String   @db.Text // Full markdown content
  category      String // e.g. "Healthcare", "E-commerce", "AI Automation Guide"
  industry      String // Industry this post targets
  problemImage  String? // AI-generated image URL (depicts the problem)
  solutionImage String? // Screenshot URL (Nexrel/Soshogle AI product)
  readTime      String   @default("5 min read")
  publishedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([publishedAt])
  @@index([industry])
  @@index([category])
}
